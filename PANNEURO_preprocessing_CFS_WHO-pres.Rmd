---
title: "PANNEURO_CFS_cleaning_WHO_pres"
author: "Molly Davies (adapting from a script by K Purves, K Thompson, and C Huebel)"
date: "26/10/2020"
output: html_document
---

This is a script to quickly clean the Chalder Fatigue Scale in COPING follow-up set B, for the purpose of Gerome Breen's presentation to the WHO.

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

#Packages
Install packages (if they are not available in your version of R)
```{r Installing packages}
#install.packages("summarytools")
#install.packages("tidyverse")
#install.packages("psych")
#install.packages("eeptools")
#install.packages("skimr")
```

Load packages
```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(eeptools) # Needed to calculate age from birthdate
library(tidyverse)
```

# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```

#Add_numeric function
Function used to convert character variables into numeric variables. 
```{r add_numeric function}
add_numeric <- function(dat, exclude = NULL) {
  dat_fct <- sjlabelled::as_label(dat)

  dat <- dat[!colnames(dat) %in% exclude]
  colnames(dat) <- paste(colnames(dat), "numeric", sep = "_")
  return(bind_cols(dat_fct, dat))
}
```

# Data import and merging

Note: GLAD only receives current measures and RAMP questionnaire
Note: All COPING surveys are separate surveys

# Source data file paths 

```{r source file path}
#source raw data directory: data.raw_path
source("../PANCHANGE_raw_path.R")
```

# Read in data
```{r glad dem cols}
cfs.raw <- readRDS(file = paste0(data.raw_path, "/2020-10-22-CFS/chalder_coping_followup_setB_ongoing.rds"))
dim(cfs.raw)
colnames(cfs.raw)
```

# Select variables
```{r cfs cleaning}
exclude_cols <- c("ID",
                  "Sample",
                  "startDate")

# NBR cohort
nbr.cfs.raw.id <- cfs.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  #distinct(externalDataReference, .keep_all = TRUE) %>% # DO NOT remove duplicates based on ID. We will need to divide them by startDate. 
  filter(str_detect(externalDataReference, "SP")) %>%  #NBR cohort
  separate(externalDataReference, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>% 
  mutate(ID = as.numeric(ID)) %>%
  select(
         Sample, # Sample
         ID, # ID
         startDate, #Date when participant completed set B
         cfs.do_you_have_problems_with_tiredness = NA.8.do_you_have_problems_with_tiredness, 
         cfs.do_you_need_to_rest_more = NA.8.do_you_need_to_rest_more, 
         cfs.do_you_feel_sleepy_or_drowsy = NA.8.do_you_feel_sleepy_or_drowsy, 
         cfs.do_you_have_problems_starting_things = NA.8.do_you_have_problems_starting_things, 
         cfs.do_you_lack_energy = NA.8.do_you_lack_energy, 
         cfs.strength_muscles = NA.8.strength_muscles,
         cfs.do_you_feel_weak = NA.8.do_you_feel_weak,
         cfs.do_you_have_difficulty_concentrating = NA.8.do_you_have_difficulty_concentrating,
         cfs.make_slips_speaking_tongue = NA.8.make_slips_speaking_tongue,
         cfs.correct_word_find_difficult = NA.8.correct_word_find_difficult,
         cfs.how_is_your_memory = NA.8.how_is_your_memory
         ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

#GLAD/EDGI cohorts
glad.edgi.cfs.raw.id <- cfs.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  #distinct(externalDataReference, .keep_all = TRUE) %>% # DO NOT remove duplicates based on ID. We will need to divide them by startDate. 
  filter(str_detect(externalDataReference, "GLAD") | str_detect(externalDataReference, "EDGI")) %>% 
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
         Sample, # Sample
         ID, # ID
         startDate, #Date when participant completed set B
         cfs.do_you_have_problems_with_tiredness = NA.8.do_you_have_problems_with_tiredness, 
         cfs.do_you_need_to_rest_more = NA.8.do_you_need_to_rest_more, 
         cfs.do_you_feel_sleepy_or_drowsy = NA.8.do_you_feel_sleepy_or_drowsy, 
         cfs.do_you_have_problems_starting_things = NA.8.do_you_have_problems_starting_things, 
         cfs.do_you_lack_energy = NA.8.do_you_lack_energy, 
         cfs.strength_muscles = NA.8.strength_muscles,
         cfs.do_you_feel_weak = NA.8.do_you_feel_weak,
         cfs.do_you_have_difficulty_concentrating = NA.8.do_you_have_difficulty_concentrating,
         cfs.make_slips_speaking_tongue = NA.8.make_slips_speaking_tongue,
         cfs.correct_word_find_difficult = NA.8.correct_word_find_difficult,
         cfs.how_is_your_memory = NA.8.how_is_your_memory
         ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(cfs.raw.id)
# Inspect colnames
colnames(cfs.raw.id)
#Differences
dim(cfs.raw)[1]-dim(cfs.raw.id)[1]

```

```{r rename NBR cohort}
nbr.cfs.raw.id <- nbr.cfs.raw.id%>%
  mutate(
    Sample = 
    recode(
      Sample, 
      "SP0068" = "NBR"
    )
  )
```


```{r merge datasets}
# Merge datasets
cfs.raw.id <- bind_rows(
  nbr.cfs.raw.id,
  glad.edgi.cfs.raw.id
  )

```

#Select subsample
Chalder Fatigue Scale was added to Set B on July 28.

For the purpose of the WHO presentation, we are filtering participants for the timepoint 6 between 28 July and 4 August.
```{r filter first CFS timepoint}
#Eventually we will need to create these timepoint variables for all timepoints.
startDate.timepoint <- as.Date("2020-07-27", format = "%Y-%m-%d")
endDate.timepoint <- as.Date("2020-08-04", format = "%Y-%m-%d")

#Filter responses within target timpeoint
cfs.raw.id_wave6 <- cfs.raw.id %>%
  filter((startDate > startDate.timepoint) & (startDate < endDate.timepoint)) %>% 
  distinct(paste0(Sample, ID), .keep_all = TRUE) #Remove duplicates for the single timepoint (hopefully this code works)

#Inspect dimensions
dim(cfs.raw.id_wave6)
#Differences
dim(cfs.raw.id)[1]-dim(cfs.raw.id_wave6)[1]
```

#Export dataset
```{r export data}
saveRDS(object = cfs.raw.id_wave6, file = paste0(data_path, "/cfs_wave6.rds"))
```

