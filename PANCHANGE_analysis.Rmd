---
title: "PANCHANGE_analysis"
author: "Katie Thompson, Topher Huebel, Molly Davies, Kirstin Purves"
date: Sys.Date()
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

This is the analysis script to prepare the data to run analyses for the project "Anxiety, depression and trauma symptom change during the COVID-19 pandemic: retrospective versus objective assessment" - Young et al (2020)

Script written by K Purves, K Thompson, C Huebel and M Davies.
Email: kirstin.purves@kcl.ac.uk, katie.thompson@kcl.ac.uk, christopher.1.huebel@kcl.ac.uk, molly.davies@kcl.ac.uk

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

#Packages
Install packages (if they are not available in your version of R)
```{r Installing packages}
#install.packages("summarytools")
#install.packages("tidyverse")
#install.packages("psych")
#install.packages("eeptools")
#install.packages("skimr")
```

Load packages
```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(eeptools) # Needed to calculate age from birthdate
library(tidyverse)
```

# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```


# Data import

## Source data file paths 

```{r source file path}
#source raw data directory: data.raw_path
source("../PANCHANGE_raw_path.R")
```


### Read in data
```{r read in data}
dat <- readRDS(file = paste0(data_path, "/four_cohorts.rds"))
dim(dat)
colnames(dat)
```

```{r dat.coping summary, eval=FALSE, include=FALSE}
summarytools::dfSummary(
  dat,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

Data availability
```{r gad availability}
dat %>%
  freq(
    data_group_gad,
    cumul = F)
```

```{r phq availability}
dat %>%
  freq(
    data_group_phq,
    cumul = F)
```

```{r pcl availability}
dat %>%
  freq(
    data_group_pcl,
    cumul = F)
```

```{r vector with psychiatric disorders}
disorder_columns <- c(
    "depressive_disorders_numeric",
    "anxiety_disorders_numeric",
    "eating_disorders_numeric",
    "obsessive_compulsive_disorders_numeric",
    "psychotic_disorders_numeric",
    "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
    "mhd.posttraumatic_stress_disorder_ptsd_numeric",
    "mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric",
    "mhd.attention_deficit_hyperactivity_disorder_numeric",
    "mhd.personality_disorder_numeric"
)
```



```{r gather to long format}
dat.long <- dat %>%
  gather(
    key = "Disorder",
    value = "Diagnosis",
    all_of(disorder_columns)) %>%
  select(
    ID,
    Sample,
    Disorder,
    Diagnosis
  )

head(dat.long)
```

Define disorder columns in vector
```{r}
dat.long %>%
  group_by(Disorder) %>%
  count()
```


## Disorders - Frequencies *use this as example to convert chunk above*
```{r Disorders - Frequencies}
#0 = No to disorder; 1 = Yes to disorder
PMAD_na_drop_Dx %>%
  select(ID, #need to add columns for which you want summaries for - ASK GB & KY what they want in descriptives table
         dem.sex,
         starts_with("mhd.") & ends_with("numeric")) %>%
  gather(
    key = "Disorder",
    value = "Diagnosis",
    mhd.MDD_numeric:mhd.ADHD_numeric #all the columns that we want to be gathered
  ) %>%
  group_by(Disorder) %>%
  count(Diagnosis) #count for diagnoses
```



Compare the GLAD/EDGI and COPING cohorts as a whole
+++CH: Diagnosis, ethnicity, gender, 
+++MD: May not be possible for NBR; potentially send them code to run it for us

Ethnicity
```{r}

```


Gender
```{r}

```

Education
```{r}

```

Key worker status
```{r}

```

COVID test positive
```{r}

```

COVID probable diagnosis
```{r}

```



Calculate mean change per disorder group 
Disorders (9) 
Sex 
Age (13; RAMP; potentially collapse above 65 depending on group sizes) 
Ethnicity groups (5; White European, Black (British), Asian, Arab, Mixed) 

Rank the disorders by the size of the change 


# Regression
Regress covariates out of the change? Which? 

Model 0: Disorders
```{r}

```


Model 1: Model 0 + Sex + Age + Ethnicity + Time registration and baseline
```{r}

```


Re-calculate change
```{r}

```


Re-rank the change again
```{r}

```


PCL:  
Calculate the total GLAD, COPING, RAMP baseline 
```{r}

```


For each item 
present percentages of how say that this is due to the pandemic 
```{r}

```


Calculate a variable PCL pandemic score 
```{r}

```


If one item is highly endorsed due to pandemic -> exclude in sensitivity analysis 
```{r}

```

 


Descriptives for reporting: "How different are these feelings to how you felt before the pandemic?â€™ on a 5-point scale (much worse, a little worse, no different, a little better, much better)."
+++KLP: Discuss during the meeting if we use 3 or 5 categories
```{r}

```


Replicate chunk above for retrospective reports. This will only be for people who say that have reported that there is a change in their scores. 
*Discuss if we should include people who reported "no change" as repition of their current GAD, PHQ, PCL report*
```{r}

```


```{r}

```

