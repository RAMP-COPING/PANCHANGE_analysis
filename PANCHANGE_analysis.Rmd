---
title: "PANCHANGE_analysis"
author: "Katie Thompson, Topher Huebel, Molly Davies, Kirstin Purves"
date: Sys.Date()
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

This is the analysis script to prepare the data to run analyses for the project "Anxiety, depression and trauma symptom change during the COVID-19 pandemic: retrospective versus objective assessment" - Young et al (2020)

Script written by K Purves, K Thompson, C Huebel and M Davies.
Email: kirstin.purves@kcl.ac.uk, katie.thompson@kcl.ac.uk, christopher.1.huebel@kcl.ac.uk, molly.davies@kcl.ac.uk

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

#Packages
Install packages (if they are not available in your version of R)
```{r Installing packages}
#install.packages("summarytools")
#install.packages("tidyverse")
#install.packages("psych")
#install.packages("broom")
#install.packages("skimr")
```

Load packages
```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(polycor)
library(corrplot)
library(patchwork)
library(broom)
library(tidyverse)
```

# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```


# Data import

## Source data file paths 

```{r source file path}
#source raw data directory: data.raw_path
source("../PANCHANGE_raw_path.R")
```


## Read in data
```{r read in data}
dat.raw <- readRDS(file = paste0(data_path, "/four_cohorts.rds"))
dim(dat.raw)
colnames(dat.raw)
```


```{r dat.coping summary, eval=FALSE, include=FALSE}
summarytools::dfSummary(
  dat.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# Data availability

Data availability GAD
```{r gad availability}
dat.raw %>%
  freq(
    data_group_gad,
    cumul = F)
```

Data availability PHQ
```{r phq availability}
dat.raw %>%
  freq(
    data_group_phq,
    cumul = F)
```

Data availability PCL
```{r pcl availability}
dat.raw %>%
  freq(
    data_group_pcl,
    cumul = F)
```

Data availability OCI-R
```{r ocir availability}
dat.raw %>%
  freq(
    data_group_ocir,
    cumul = F)
```

```{r}
dat.raw %>%
  freq(Sample)
```

# Collapsing categories

## age_category
```{r Inspect age_category}
dat.raw %>%
  freq(age_category)

dat.raw %>%
  freq(age_category_numeric)
```

```{r Collapse age_category}
dat.raw <- dat.raw %>%
  mutate(age_category_collapsed_numeric =
           case_when(
             age_category_numeric == 1 ~ 0,
             age_category_numeric == 2 ~ 1,
             age_category_numeric == 3 ~ 2,
             age_category_numeric == 4 ~ 3,
             age_category_numeric == 5 ~ 4,
             age_category_numeric == 6 ~ 5,
             age_category_numeric == 7 ~ 6,
             age_category_numeric == 8 ~ 7,
             age_category_numeric == 9 ~ 8,
             age_category_numeric == 10 ~ 8,
             age_category_numeric == 11 ~ 8,
             age_category_numeric == 12 ~ 8,
             age_category_numeric == 13 ~ 8
             
           )
  )

dat.raw <- dat.raw %>%
  mutate(age_category_collapsed =
           recode_factor(
             age_category_collapsed_numeric,
             `0` = "16-18",
             `1` = "19-25",
             `2` = "26-35",
             `3` = "36-45",
             `4` = "46-55",
             `5` = "56-65",
             `6` = "66-70",
             `7` = "71-75",
             `8` = "76+"
           )
  )

dat.raw %>%
  freq(age_category_collapsed)
```



## Gender
```{r Inspect Gender}
dat.raw %>%
  freq(Gender)

dat.raw %>%
  freq(Gender_numeric)
```

```{r Collapse Gender}
dat.raw <- dat.raw %>%
  mutate(Gender_collapsed_numeric =
           case_when(
             Gender_numeric == 0 ~ 0,
             Gender_numeric == 1 ~ 1,
             Gender_numeric == 2 ~ 2,
             Gender_numeric == 3 ~ 2
           )
         )

dat.raw <- dat.raw %>%
  mutate(Gender_collapsed =
           recode_factor(
             Gender_collapsed_numeric,
             `0` = "Male",
             `1` = "Female",
             `2` = "Non-binary/Self-defined"
           )
         )

dat.raw %>%
  freq(Gender_collapsed)
```

## Ethnicity
```{r Inspect Ethnicity}
dat.raw %>%
  freq(Ethnicity)

dat.raw %>%
  freq(Ethnicity_numeric)
```

```{r Collapse Ethnicity}
dat.raw <- dat.raw %>%
  mutate(Ethnicity_collapsed_numeric =
           case_when(
             Ethnicity_numeric == 1 ~ 0,
             Ethnicity_numeric == 2 ~ 1,
             Ethnicity_numeric == 3 ~ 2,
             Ethnicity_numeric == 4 ~ 3,
             Ethnicity_numeric == 5 ~ 3,
             Ethnicity_numeric == 6 ~ 4
           )
  )

dat.raw <- dat.raw %>%
  mutate(Ethnicity_collapsed =
           recode_factor(
             Ethnicity_collapsed_numeric,
             `0` = "European",
             `1` = "Mixed or multiple ethnic origins",
             `2` = "Asian or Asian British",
             `3` = "African or African British",
             `4` = "Asian or Asian British"
           )
  )

dat.raw %>%
  freq(Ethnicity_collapsed)
```

# Exclusion

## COPING
Filter data frame to exclude participants that never answered COPING
```{r exclusion criteria dat}
dat <- dat.raw %>%
  filter(
    (data_group_gad == "Baseline and retrospective data" |
      data_group_gad == "Prepandemic and baseline data" |
      data_group_gad == "All prepandemic, baseline and retrospective data") |
      (data_group_phq == "Baseline and retrospective data" |
      data_group_phq == "Prepandemic and baseline data" |
      data_group_phq == "All prepandemic, baseline and retrospective data") |
      (data_group_pcl == "Baseline and retrospective data" |
      data_group_pcl == "Prepandemic and baseline data" |
      data_group_pcl == "All prepandemic, baseline and retrospective data") |
      (data_group_ocir == "Baseline and retrospective data" |
      data_group_ocir == "Prepandemic and baseline data" |
      data_group_ocir == "All prepandemic, baseline and retrospective data")
  )
```

```{r dimensions of total dat}
dim(dat)
```

```{r}
dat %>%
  freq(disorders_total_count)
```

# Vectors for sum_score
```{r Vectors with sum_score_cols}
sum_score_cols <- dat %>%
  select(contains("sum_score")) %>%
  select(-ends_with("raw")) %>%
  colnames()

sum_score_cols

phq.sum_score_cols <- dat %>%
  select(contains("phq")) %>%
  select(contains("sum_score")) %>% 
  select(-ends_with("raw")) %>%
  select(-contains("8items")) %>%
  colnames()

phq.sum_score_cols

gad.sum_score_cols <- dat %>%
  select(contains("gad")) %>%
  select(contains("sum_score")) %>% 
  select(-ends_with("raw")) %>%
  colnames()

gad.sum_score_cols

ocir.sum_score_cols <- dat %>%
  select(contains("ocir")) %>%
  select(contains("sum_score")) %>% 
  select(-ends_with("raw")) %>%
  colnames()

ocir.sum_score_cols

pcl.sum_score_cols <- dat %>%
  select(contains("pcl")) %>%
  select(contains("sum_score")) %>% 
  select(-ends_with("raw")) %>%
  colnames()

pcl.sum_score_cols
```



# Vectors for diff_score
```{r Vectors with diff_score_cols}
diff_score_cols <- dat %>%
  select(contains("diff_score")) %>% 
  colnames()

diff_score_cols

phq.diff_score_cols <- dat %>%
  select(contains("phq")) %>%
  select(contains("diff_score")) %>% 
  colnames()

phq.diff_score_cols

gad.diff_score_cols <- dat %>%
  select(contains("gad")) %>%
  select(contains("diff_score")) %>% 
  colnames()

gad.diff_score_cols

ocir.diff_score_cols <- dat %>%
  select(contains("ocir")) %>%
  select(contains("diff_score")) %>% 
  colnames()

ocir.diff_score_cols
```

# ggplot theme
Set up ggplot theme for the plots
```{r ggplot theme}
theme_personal <-  theme(
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    axis.title.y = element_blank(), 
    legend.background = element_blank(),
    legend.box.background = element_blank(),
    panel.background = element_blank(), 
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(
      colour = "gray",
      linetype = "dashed",
      size = 0.2
      ),
    axis.ticks = element_blank()
    )
```

# Psychiatric disorder hierarchy

control_numeric == 1 ~ 0,
depressive_disorders_numeric == 1 ~ 1,
anxiety_disorders_numeric == 1 ~ 2,
mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 3,
eating_disorders_numeric == 1 ~ 4,
obsessive_compulsive_disorders_numeric == 1 ~ 5,
mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 6,
mhd.personality_disorder_numeric == 1 ~ 7,
autism_spectrum_disorder_numeric == 1 ~ 8,
mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 9,
psychotic_disorders_numeric == 1 ~ 10

psychotic_disorders_numeric == 1 ~ 10
mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 9,
autism_spectrum_disorder_numeric == 1 ~ 8,
mhd.personality_disorder_numeric == 1 ~ 7,
mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 6,
obsessive_compulsive_disorders_numeric == 1 ~ 5,
eating_disorders_numeric == 1 ~ 4,
mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 3,
anxiety_disorders_numeric == 1 ~ 2,
depressive_disorders_numeric == 1 ~ 1,
control_numeric == 1 ~ 0,


```{r Psychiatric disorders hierarchy}
dat <- dat %>%
  mutate(
    Disorder_hierarchical_numeric =
      case_when(
        psychotic_disorders_numeric == 1 ~ 11,
        mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 10,
        autism_spectrum_disorder_numeric == 1 ~ 9,
        mhd.personality_disorder_numeric == 1 ~ 8,
        mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 7,
        obsessive_compulsive_disorders_numeric == 1 ~ 6,
        eating_disorders_numeric == 1 ~ 5,
        mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 4,
        (anxiety_disorders_numeric == 1 &
        depressive_disorders_numeric == 1) ~ 3,
        anxiety_disorders_numeric == 1 ~ 2,
        depressive_disorders_numeric == 1 ~ 1,
        control_numeric == 1 ~ 0
      )
  )

dat <- dat %>%
  mutate(
    Disorder_hierarchical =
      recode_factor(
        Disorder_hierarchical_numeric,
        `0` = "Controls",
        `1` = "Depressive disorders",
        `2` = "Anxiety disorders",
        `3` = "Depressive & anxiety disorders",
        `4` = "PTSD",
        `5` = "Eating disorders",
        `6` = "OCDs",
        `7` = "ADHD",
        `8` = "Personality disorders",
        `9` = "Autism",
        `10` = "Bipolar disorders",
        `11` = "Psychotic disorders"
      )
  )


dat %>%
  freq(Disorder_hierarchical)
```

Investigate NAs 
Ask Leo?
```{r NAs in diagnosis}
dat %>%
  filter(is.na(Disorder_hierarchical)) %>%
  freq(Sample)
```




# Psychiatric disorders

## Vector
```{r vector with psychiatric disorders}
disorder_columns <- c(
  "control_numeric",  
  "depressive_disorders_numeric",
    "anxiety_disorders_numeric",
    "mhd.posttraumatic_stress_disorder_ptsd_numeric",
    "eating_disorders_numeric",
    "obsessive_compulsive_disorders_numeric",
    "mhd.attention_deficit_hyperactivity_disorder_numeric",
    "mhd.personality_disorder_numeric",
    "autism_spectrum_disorder_numeric",
    "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
    "psychotic_disorders_numeric"
)
```

## Correlation matrix
```{r Correlation matrix of psychiatric disorders}
# Select items for correlation matrix
mhd.items <- c(
    "depressive_disorders",
    "anxiety_disorders",
    "eating_disorders",
    "obsessive_compulsive_disorders",
    "psychotic_disorders",
    "mhd.mania_hypomania_bipolar_or_manicdepression",
    "mhd.posttraumatic_stress_disorder_ptsd",
    "autism_spectrum_disorder",
    "mhd.attention_deficit_hyperactivity_disorder",
    "mhd.personality_disorder",
    "control"
)

# Calculate correlation matrix on specific columns (variables) from your data frame
mhd.corr.mat <- hetcor(
  as.data.frame(dat[,mhd.items]), # Specify the data
  use = "pairwise.complete.obs" # Use all pairwise observations
)

# Print the correlation matrix
print(mhd.corr.mat, digits = max(3, getOption("digits") - 3)) 

# Save the correlations from the correlation matrix in an object
mhd.corr.matrix <- as.matrix(mhd.corr.mat)

# Save the p values from the correlation matrix in an object
mhd.p.matrix <- as.matrix(mhd.corr.mat$tests)
```

Create the correlation matrix plot using the corrplot package
```{r Correlation matrix of psychiatric disorders plot, fig.height=7}
corrplot(mhd.corr.matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.8,
         tl.col = "black",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         # Combine with significance
         p.mat = mhd.p.matrix, # Matrix with p values
         sig.level = 0.01, # Choose significant level
         insig = "blank" # Nonsignificant correlations have no colour
         )
```



```{r gather to long format Disorder_hierarchical}
dat.long.psych <- dat %>%
  gather(
    key = "Disorder_inc_raw",
    value = "Diagnosis",
    all_of(disorder_columns)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    all_of(diff_score_cols),
    Disorder_inc_raw,
    Diagnosis
  ) %>%
  mutate(Disorder_inc =
           recode_factor(
             Disorder_inc_raw,
             anxiety_disorders_numeric = "Anxiety disorders",
             depressive_disorders_numeric = "Depressive disorders",
             eating_disorders_numeric = "Eating disorders",
             obsessive_compulsive_disorders_numeric = "OCDs",
             psychotic_disorders_numeric = "Psychotic disorders",
             mhd.mania_hypomania_bipolar_or_manicdepression_numeric = "Bipolar disorders",
             mhd.posttraumatic_stress_disorder_ptsd_numeric = "PTSD",
             autism_spectrum_disorder_numeric = "Autism",
             mhd.attention_deficit_hyperactivity_disorder_numeric = "ADHD",
             mhd.personality_disorder_numeric = "Personality disorders",
             control_numeric = "Controls"
           ))

head(dat.long.psych)
```



```{r Disorder_inc by Gender_collapsed}
Disorder_inc_by_Gender_collapsed <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Gender_collapsed) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Gender_collapsed
```

```{r Disorder_inc by Gender_collapsed prop}
Disorder_inc_by_Gender_collapsed <- dat.long.psych %>%
  group_by(Disorder_inc) %>%
  filter(Diagnosis == 1) %>%
  count(Gender_collapsed) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Gender_collapsed
```


```{r Disorder_inc by Gender_collapsed count plot}
Disorder_inc_by_Gender_collapsed_count_plot <- Disorder_inc_by_Gender_collapsed %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
    ) +
  geom_bar(
    aes(fill = Gender_collapsed),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Gender_collapsed") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4
    ) +
  coord_flip()

Disorder_inc_by_Gender_collapsed_count_plot
```

```{r Disorder_inc by Gender_collapsed prop plot}
Disorder_inc_by_Gender_collapsed_prop_plot <- Disorder_inc_by_Gender_collapsed %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = Prop)
    ) +
  geom_bar(
    aes(fill = Gender_collapsed),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Gender_collapsed") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4
    ) +
  coord_flip()

Disorder_inc_by_Gender_collapsed_prop_plot
```


100% bar per diagnosis with percentages of contribution per sample

```{r Disorder_inc by Sample}
Disorder_inc_by_Sample <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Sample)
```

```{r Disorder_inc by Sample plot}
Disorder_inc_by_Sample %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
    ) +
  geom_bar(
    aes(fill = Sample),
#    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4,
#    labels = c("Prepandemic", "Retrospective")
    ) +
  coord_flip()
```



Ethnicity should be recoded
European
Mixed or multiple ethnic origins
African or African British
Asian or Asian British
Arab
```{r Disorder_inc by Ethnicity_collapsed}
Disorder_inc_by_Ethnicity <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Ethnicity_collapsed) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Ethnicity
```

```{r Disorder_inc by Ethnicity_collapsed plot}
Disorder_inc_by_Ethnicity %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
  ) +
  geom_bar(
    aes(fill = Ethnicity_collapsed),
    #    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Ethnicity_collapsed") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6,
    #    labels = c("Prepandemic", "Retrospective")
  ) +
  coord_flip()
```


Compare the GLAD/EDGI and COPING cohorts as a whole
+++CH: Diagnosis, ethnicity, gender, age

# age_category
```{r age_category per Sample prop per total}
age_category_per_Sample_prop_total <- dat %>%
  count(age_category, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(age_category_per_Sample_prop_total)
age_category_per_Sample_prop_total
```

```{r age_category per Sample prop per Sample}
age_category_per_Sample_prop_Sample <- dat %>%
  group_by(Sample) %>%
  count(age_category, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(age_category_per_Sample_prop_Sample)
age_category_per_Sample_prop_Sample
```

```{r age_category per Sample prop cross table}
age_category_per_Sample_prop_Sample_cross_table <- dat %>%
  group_by(Sample) %>%
  count(age_category, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))

kable(age_category_per_Sample_prop_Sample_cross_table)
age_category_per_Sample_prop_Sample_cross_table
```


```{r age_category per Sample count cross table}
age_category_per_Sample_count_cross_table <- dat %>%
  count(age_category, Sample) %>%
  spread(key = Sample, value = n) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  )

kable(age_category_per_Sample_count_cross_table)
age_category_per_Sample_count_cross_table
```


```{r age_category per Sample chisquare test}
age_category_per_Sample_chissquare_test <- dat %>%
  count(age_category, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-age_category) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  ) %>%
  chisq.test() %>%
  glance()

kable(age_category_per_Sample_chissquare_test)
age_category_per_Sample_chissquare_test
```

```{r age_category by Sample count plot}
age_category_by_Sample_count_plot <- age_category_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = age_category,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "age_category",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

age_category_by_Sample_count_plot
```

```{r age_category by Sample prop plot}
age_category_by_Sample_prop_plot <- age_category_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = age_category,
    y = Prop)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "age_category",
    y = "Percentage per sample",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

age_category_by_Sample_prop_plot
```

# Ethnicity_collapsed
```{r Ethnicity_collapsed per Sample prop per total}
Ethnicity_collapsed_per_Sample_prop_total <- dat %>%
  count(Ethnicity_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(Ethnicity_collapsed_per_Sample_prop_total)
Ethnicity_collapsed_per_Sample_prop_total
```

```{r Ethnicity_collapsed per Sample prop per Sample}
Ethnicity_collapsed_per_Sample_prop_Sample <- dat %>%
  group_by(Sample) %>%
  count(Ethnicity_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(Ethnicity_collapsed_per_Sample_prop_Sample)
Ethnicity_collapsed_per_Sample_prop_Sample
```

```{r Ethnicity_collapsed per Sample prop cross table}
Ethnicity_collapsed_per_Sample_prop_Sample_cross_table <- dat %>%
  group_by(Sample) %>%
  count(Ethnicity_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))

kable(Ethnicity_collapsed_per_Sample_prop_Sample_cross_table)
Ethnicity_collapsed_per_Sample_prop_Sample_cross_table
```


```{r Ethnicity_collapsed per Sample count cross table}
Ethnicity_collapsed_per_Sample_count_cross_table <- dat %>%
  count(Ethnicity_collapsed, Sample) %>%
  spread(key = Sample, value = n) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  )

kable(Ethnicity_collapsed_per_Sample_count_cross_table)
Ethnicity_collapsed_per_Sample_count_cross_table
```


```{r Ethnicity_collapsed per Sample chisquare test}
Ethnicity_collapsed_per_Sample_chissquare_test <- dat %>%
  count(Ethnicity_collapsed, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-Ethnicity_collapsed) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  ) %>%
  chisq.test() %>%
  glance()

kable(Ethnicity_collapsed_per_Sample_chissquare_test)
Ethnicity_collapsed_per_Sample_chissquare_test
```

```{r Ethnicity_collapsed by Sample count plot}
Ethnicity_collapsed_by_Sample_count_plot <- Ethnicity_collapsed_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = Ethnicity_collapsed,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Ethnicity_collapsed",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

Ethnicity_collapsed_by_Sample_count_plot
```

```{r Ethnicity_collapsed by Sample prop plot}
Ethnicity_collapsed_by_Sample_prop_plot <- Ethnicity_collapsed_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = Ethnicity_collapsed,
    y = Prop)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Ethnicity_collapsed",
    y = "Percentage per sample",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

Ethnicity_collapsed_by_Sample_prop_plot
```

# Gender_collapsed
```{r Gender_collapsed per Sample prop per total}
Gender_collapsed_per_Sample_prop_total <- dat %>%
  count(Gender_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(Gender_collapsed_per_Sample_prop_total)
Gender_collapsed_per_Sample_prop_total
```

```{r Gender_collapsed per Sample prop per Sample}
Gender_collapsed_per_Sample_prop_Sample <- dat %>%
  group_by(Sample) %>%
  count(Gender_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(Gender_collapsed_per_Sample_prop_Sample)
Gender_collapsed_per_Sample_prop_Sample
```

```{r Gender_collapsed per Sample prop cross table}
Gender_collapsed_per_Sample_prop_Sample_cross_table <- dat %>%
  group_by(Sample) %>%
  count(Gender_collapsed, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))

kable(Gender_collapsed_per_Sample_prop_Sample_cross_table)
Gender_collapsed_per_Sample_prop_Sample_cross_table
```


```{r Gender_collapsed per Sample count cross table}
Gender_collapsed_per_Sample_count_cross_table <- dat %>%
  count(Gender_collapsed, Sample) %>%
  spread(key = Sample, value = n) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  )

kable(Gender_collapsed_per_Sample_count_cross_table)
Gender_collapsed_per_Sample_count_cross_table
```


```{r Gender_collapsed per Sample chisquare test}
Gender_collapsed_per_Sample_chissquare_test <- dat %>%
  count(Gender_collapsed, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-Gender_collapsed) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  ) %>%
  chisq.test() %>%
  glance()

kable(Gender_collapsed_per_Sample_chissquare_test)
Gender_collapsed_per_Sample_chissquare_test
```

```{r Gender_collapsed by Sample count plot}
Gender_collapsed_by_Sample_count_plot <- Gender_collapsed_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = Gender_collapsed,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Gender_collapsed",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

Gender_collapsed_by_Sample_count_plot
```

```{r Gender_collapsed by Sample prop plot}
Gender_collapsed_by_Sample_prop_plot <- Gender_collapsed_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = Gender_collapsed,
    y = Prop)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Gender_collapsed",
    y = "Percentage per sample",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

Gender_collapsed_by_Sample_prop_plot
```


# highest_education
```{r highest_education per Sample prop per total}
highest_education_per_Sample_prop_total <- dat %>%
  count(highest_education, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(highest_education_per_Sample_prop_total)
highest_education_per_Sample_prop_total
```

```{r highest_education per Sample prop per Sample}
highest_education_per_Sample_prop_Sample <- dat %>%
  group_by(Sample) %>%
  count(highest_education, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(highest_education_per_Sample_prop_Sample)
highest_education_per_Sample_prop_Sample
```

```{r highest_education per Sample prop cross table}
highest_education_per_Sample_prop_Sample_cross_table <- dat %>%
  group_by(Sample) %>%
  count(highest_education, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))

kable(highest_education_per_Sample_prop_Sample_cross_table)
highest_education_per_Sample_prop_Sample_cross_table
```


```{r highest_education per Sample count cross table}
highest_education_per_Sample_count_cross_table <- dat %>%
  count(highest_education, Sample) %>%
  spread(key = Sample, value = n) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  )

kable(highest_education_per_Sample_count_cross_table)
highest_education_per_Sample_count_cross_table
```


```{r highest_education per Sample chisquare test}
highest_education_per_Sample_chissquare_test <- dat %>%
  count(highest_education, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-highest_education) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  ) %>%
  chisq.test() %>%
  glance()

kable(highest_education_per_Sample_chissquare_test)
highest_education_per_Sample_chissquare_test
```

```{r highest_education by Sample count plot}
highest_education_by_Sample_count_plot <- highest_education_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = highest_education,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "highest_education",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

highest_education_by_Sample_count_plot
```

```{r highest_education by Sample prop plot}
highest_education_by_Sample_prop_plot <- highest_education_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = highest_education,
    y = Prop)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "highest_education",
    y = "Percentage per sample",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

highest_education_by_Sample_prop_plot
```


# key_worker
```{r key_worker per Sample prop per total}
key_worker_per_Sample_prop_total <- dat %>%
  count(key_worker, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(key_worker_per_Sample_prop_total)
key_worker_per_Sample_prop_total
```

```{r key_worker per Sample prop per Sample}
key_worker_per_Sample_prop_Sample <- dat %>%
  group_by(Sample) %>%
  count(key_worker, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

kable(key_worker_per_Sample_prop_Sample)
key_worker_per_Sample_prop_Sample
```

```{r key_worker per Sample prop cross table}
key_worker_per_Sample_prop_Sample_cross_table <- dat %>%
  group_by(Sample) %>%
  count(key_worker, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))

kable(key_worker_per_Sample_prop_Sample_cross_table)
key_worker_per_Sample_prop_Sample_cross_table
```


```{r key_worker per Sample count cross table}
key_worker_per_Sample_count_cross_table <- dat %>%
  count(key_worker, Sample) %>%
  spread(key = Sample, value = n) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  )

kable(key_worker_per_Sample_count_cross_table)
key_worker_per_Sample_count_cross_table
```


```{r key_worker per Sample chisquare test}
key_worker_per_Sample_chissquare_test <- dat %>%
  count(key_worker, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-key_worker) %>%
  mutate(
    EDGI = as.integer(replace_na(EDGI, 0)),
    GLAD = as.integer(replace_na(GLAD, 0)),
    NBR = as.integer(replace_na(NBR, 0)),
    RAMP = as.integer(replace_na(RAMP, 0))
  ) %>%
  chisq.test() %>%
  glance()

kable(key_worker_per_Sample_chissquare_test)
key_worker_per_Sample_chissquare_test
```

```{r key_worker by Sample count plot}
key_worker_by_Sample_count_plot <- key_worker_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = key_worker,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "key_worker",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

key_worker_by_Sample_count_plot
```

```{r key_worker by Sample prop plot}
key_worker_by_Sample_prop_plot <- key_worker_per_Sample_prop_Sample %>%
  ggplot(mapping = aes(
    x = key_worker,
    y = Prop)
  ) +
  geom_bar(
    aes(fill = Sample),
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "key_worker",
    y = "Percentage per sample",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6
  ) +
  coord_flip()

key_worker_by_Sample_prop_plot
```


# COVID
## Recode variable
```{r gad covid test positive double}
dat <- dat %>%
  mutate(covid_test_positive_double_numeric =
           case_when(
             (respiratory.throat_swab_test_nose_numeric == 1 &
               respiratory.results_antibody_test_numeric == 1) ~ 2,
             respiratory.throat_swab_test_nose_numeric == 1 ~ 1,
             respiratory.throat_swab_test_nose_numeric == 2 ~ 0,
             respiratory.results_antibody_test_numeric == 1 ~ 1,
             respiratory.results_antibody_test_numeric == 2 ~ 0
           )
         )

dat <- dat %>%
  mutate(covid_test_positive_double =
           recode_factor(
             covid_test_positive_double_numeric,
             `0` = "Negative",
             `1` = "Positive",
             `2` = "Double positive"
           )
         )

dat %>%
  freq(covid_test_positive_double)
```

```{r gad covid test positive}
dat <- dat %>%
  mutate(gad.covid_test_positive_numeric =
           case_when(
             (respiratory.throat_swab_test_nose_numeric == 1 &
               respiratory.results_antibody_test_numeric == 1) ~ 1, # with two positive test results get coded as positive
             respiratory.throat_swab_test_nose_numeric == 1 ~ 1,
             respiratory.throat_swab_test_nose_numeric == 2 ~ 0,
             respiratory.results_antibody_test_numeric == 1 ~ 1,
             respiratory.results_antibody_test_numeric == 2 ~ 0
           )
         )

dat <- dat %>%
  mutate(covid_test_positive =
           recode_factor(
             gad.covid_test_positive_numeric,
             `0` = "Negative",
             `1` = "Positive"
#             `2` = "Double positive"
           )
         )

dat %>%
  freq(covid_test_positive)
```



## COVID swab test positive
```{r COVID positive swap}
dat %>%
  count(respiratory.throat_swab_test_nose, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

## antibody test
```{r COVID positive antibody test}
dat %>%
  count(respiratory.results_antibody_test, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```


## COVID probable diagnosis
```{r COVID probable diagnosis}
dat %>%
  count(covid_probable_case_incl_screening, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

## Cross table probable covid and covid test positive
```{r Cross table probable covid and covid test positive}
dat %>%
  count(covid_test_positive, covid_probable_case_incl_screening) %>%
  spread(key = covid_test_positive, value = n)
```

# Create data set per cohort

## GAD
```{r}
dat.gad <- dat %>%
#  drop_na() %>%
  filter(
    (data_group_gad == "Baseline and retrospective data" |
      data_group_gad == "Prepandemic and baseline data" |
      data_group_gad == "All prepandemic, baseline and retrospective data")
  )

dim(dat.gad)
```


# Questionnaire comparions

## gad

### Split sample in improvement and worsening
```{r gad improvment worsening stratification}
dat <- dat %>%
  mutate(gad.change_binary_numeric =
           case_when(
             gad.pandemic_felt_feelings_numeric == 1 ~ 1,
             gad.pandemic_felt_feelings_numeric == 2 ~ 1,
             gad.pandemic_felt_feelings_numeric == 3 ~ 0,
             gad.pandemic_felt_feelings_numeric == 4 ~ 2,
             gad.pandemic_felt_feelings_numeric == 5 ~ 2
           )
         )

dat <- dat %>%
  mutate(gad.change_binary =
           recode_factor(
             gad.change_binary_numeric,
             `0` = "No change",
             `1` = "Worsening",
             `2` = "Improvement"
           )
         )

dat %>%
  freq(gad.change_binary)
```


### Summary scores
```{r descriptives gad.sum_score_cols}
gad.sum_score_numeric_table <- dat %>% 
  group_by(gad.change_binary) %>%
  summarise_at( 
    vars(
      "Prepan" = gad.sum_score_prepan,
      "Base" = gad.sum_score_base,
      "Retro" = gad.sum_score_retro
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

gad.sum_score_numeric_table
```

```{r smart numeric summary tables}
# reshape the table
gad.sum_score_numeric_summary_table_reshaped <- gad.sum_score_numeric_table %>% 
  gather(key, value, -gad.change_binary) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    Change = Gad.change_binary,
    SD = Sd
  ) 

gad.sum_score_numeric_summary_table_reshaped
```

Table for knitting
gad diff summary table
```{r gad diff summary table}
kable(gad.sum_score_numeric_summary_table_reshaped)
```

### Differences scores

```{r descriptives gad.diff_score_cols}
gad.numeric_table <- dat %>% 
  group_by(gad.change_binary) %>%
  summarise_at( 
    vars(
      "Base - prepan" = gad.diff_score_base_prepan,
      "Base - retro" = gad.diff_score_base_retro,
      "Prepan - retro" = gad.diff_score_retro_prepan
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

gad.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
gad.numeric_summary_table_reshaped <- gad.numeric_table %>% 
  gather(key, value, -gad.change_binary) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
    ) %>% 
  # or we can individually rename variables 
  rename(
    Change = Gad.change_binary,
    SD = Sd
  ) 
  
gad.numeric_summary_table_reshaped
```

Table for knitting
gad diff summary table
```{r gad diff summary table}
kable(gad.numeric_summary_table_reshaped)
```

### Long format

```{r gad gather to long format Time_points gad.diff_score}
dat.long.gad.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "gad.diff_score",
    all_of(gad.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    gad.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "gad.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.gad.diff)
```

```{r gad gather to long format Time_points gad.sum_score}
dat.long.gad.sum <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "gad.sum_score",
    all_of(gad.sum_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    gad.sum_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "gad.sum_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.gad.sum)
```


### Plots diff

makes this into percentages
```{r gad absolut plot}
dat.long.gad.diff %>%
  ggplot(mapping = aes(y = gad.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```

```{r gad percentage plot retro_prepan diff}
dat.long.gad.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = gad.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference GAD7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```


```{r gad percentage plot retro_prepan, fig.height=6, fig.width=10}
dat.long.gad.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = gad.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference GAD7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective")) +
  facet_wrap("Disorder_hierarchical")
```



```{r gad plot retro_prepan diff}
dat.long.gad.diff %>%
  filter(Time_point == "retro_prepan") %>%
  ggplot(mapping = aes(
    x = gad.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference GAD7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nRetrospective vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic"))
```

### Plots sum

```{r gad percentage plot retro_prepan sum}
dat.long.gad.sum %>%
#  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = gad.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "GAD7 scores",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
    )
```

```{r gad percentage plot retro_prepan sum, fig.height=6, fig.width=10}
dat.long.gad.sum %>%
#  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = gad.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "GAD7 score",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
#    labels = c("Prepandemic", "Retrospective")
    ) +
  facet_wrap("Disorder_hierarchical")
```


## phq

### Split sample in improvement and worsening
```{r phq improvment worsening stratification}
dat <- dat %>%
  mutate(phq.change_binary_numeric =
           case_when(
             phq.pandemic_felt_feelings_numeric == 1 ~ 1,
             phq.pandemic_felt_feelings_numeric == 2 ~ 1,
             phq.pandemic_felt_feelings_numeric == 3 ~ 0,
             phq.pandemic_felt_feelings_numeric == 4 ~ 2,
             phq.pandemic_felt_feelings_numeric == 5 ~ 2
           )
  )

dat <- dat %>%
  mutate(phq.change_binary =
           recode_factor(
             phq.change_binary_numeric,
             `0` = "No change",
             `1` = "Worsening",
             `2` = "Improvement"
           )
  )

dat %>%
  freq(phq.change_binary)
```

### Summary scores
```{r descriptives phq.sum_score}
phq.sum_score_numeric_table <- dat %>% 
  group_by(phq.change_binary) %>%
  summarise_at( 
    vars(
      "Prepan" = phq.sum_score_prepan,
      "Base" = phq.sum_score_base,
      "Retro" = phq.sum_score_retro
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

phq.sum_score_numeric_table
```

```{r smart numeric summary tables}
# reshape the table
phq.sum_score_numeric_summary_table_reshaped <- phq.sum_score_numeric_table %>%
  gather(key, value, -phq.change_binary) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

phq.sum_score_numeric_summary_table_reshaped
```

Table for knitting
phq diff summary table
```{r phq diff summary table}
kable(phq.sum_score_numeric_summary_table_reshaped)
```

### Differences score

```{r descriptives phq.diff_score_cols}
phq.numeric_table <- dat %>% 
  group_by(phq.change_binary) %>%
  summarise_at( 
    vars(
      "Base - prepan" = phq.diff_score_base_prepan,
      "Base - retro" = phq.diff_score_base_retro,
      "Prepan - retro" = phq.diff_score_retro_prepan
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

phq.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
phq.numeric_summary_table_reshaped <- phq.numeric_table %>% 
  gather(key, value, -phq.change_binary) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

phq.numeric_summary_table_reshaped
```

Table for knitting
phq diff summary table
```{r phq diff summary table}
kable(phq.numeric_summary_table_reshaped)
```

### Long format

```{r phq gather to long format Time_points}
dat.long.phq.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "phq.diff_score",
    all_of(phq.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    phq.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "phq.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.phq.diff)
```

```{r phq gather to long format Time_points phq.sum_score}
dat.long.phq.sum <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "phq.sum_score",
    all_of(phq.sum_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    phq.sum_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "phq.sum_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.phq.sum)
```

### Plots

makes this into percentages
```{r phq absolut plot}
dat.long.phq.diff %>%
  ggplot(mapping = aes(y = phq.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```





```{r phq percentage plot retro_prepan}
dat.long.phq.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = phq.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference PHQ9 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```

```{r phq plot retro_prepan diff}
dat.long.phq.diff %>%
  filter(Time_point == "retro_prepan") %>%
  ggplot(mapping = aes(
    x = phq.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference phq7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nPrepandemic vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Retrospective"))
```

```{r phq percentage plot retro_prepan, fig.height=6, fig.width=10}
dat.long.phq.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = phq.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference PHQ9 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective")) +
  facet_wrap("Disorder_hierarchical")
```

### Plots sum

```{r phq percentage plot retro_prepan sum}
dat.long.phq.sum %>%
  #  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = phq.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "PHQ9 scores",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  )
```

```{r phq percentage plot retro_prepan sum, fig.height=6, fig.width=10}
dat.long.phq.sum %>%
  #  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = phq.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "PHQ9 score",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  ) +
  facet_wrap("Disorder_hierarchical")
```

## ocir

### Split sample in improvement and worsening
```{r ocir improvment worsening stratification}
dat <- dat %>%
  mutate(ocir.change_binary_numeric =
           case_when(
             ocir.felt_pandemic_feelings_numeric == 1 ~ 1,
             ocir.felt_pandemic_feelings_numeric == 2 ~ 1,
             ocir.felt_pandemic_feelings_numeric == 3 ~ 0,
             ocir.felt_pandemic_feelings_numeric == 4 ~ 2,
             ocir.felt_pandemic_feelings_numeric == 5 ~ 2
           )
  )

dat <- dat %>%
  mutate(ocir.change_binary =
           recode_factor(
             ocir.change_binary_numeric,
             `0` = "No change",
             `1` = "Worsening",
             `2` = "Improvement"
           )
  )

dat %>%
  freq(ocir.change_binary)
```

### Summary scores
```{r descriptives ocir.sum_score}
ocir.sum_score_numeric_table <- dat %>% 
  group_by(ocir.change_binary) %>%
  summarise_at( 
    vars(
      "Prepan" = ocir.sum_score_prepan,
      "Base" = ocir.sum_score_base,
      "Retro" = ocir.sum_score_retro
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

ocir.sum_score_numeric_table
```

```{r smart numeric summary tables}
# reshape the table
ocir.sum_score_numeric_summary_table_reshaped <- ocir.sum_score_numeric_table %>%
  filter(ocir.change_binary == "Worsening") %>%
  select(-ocir.change_binary) %>%
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

ocir.sum_score_numeric_summary_table_reshaped
```

Table for knitting
ocir diff summary table
```{r ocir diff summary table}
kable(ocir.sum_score_numeric_summary_table_reshaped)
```

### Differences scores

```{r descriptives ocir.diff_score_cols}
ocir.numeric_table <- dat %>% 
  #  group_by(dem.sex) %>%
  summarise_at( 
    vars(
      "Base - prepan" = ocir.diff_score_base_prepan,
      "Base - retro" = ocir.diff_score_base_retro,
      "Prepan - retro" = ocir.diff_score_retro_prepan
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

ocir.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
ocir.numeric_summary_table_reshaped <- ocir.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

ocir.numeric_summary_table_reshaped
```

Table for knitting
ocir diff summary table
```{r ocir diff summary table}
kable(ocir.numeric_summary_table_reshaped)
```

### Long format

```{r ocir gather to long format Time_points}
dat.long.ocir.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "ocir.diff_score",
    all_of(ocir.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    ocir.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "ocir.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.ocir.diff)
```

```{r ocir gather to long format Time_points ocir.sum_score}
dat.long.ocir.sum <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "ocir.sum_score",
    all_of(ocir.sum_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    ocir.sum_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "ocir.sum_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.ocir.sum)
```

### Plots

makes this into percentages
```{r ocir absolut plot}
dat.long.ocir.diff %>%
  ggplot(mapping = aes(y = ocir.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```

```{r ocir percentage plot retro_prepan}
dat.long.ocir.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = ocir.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference OCI-R score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```

```{r ocir plot retro_prepan diff}
dat.long.ocir.diff %>%
  filter(Time_point == "retro_prepan") %>%
  ggplot(mapping = aes(
    x = ocir.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference ocir7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nPrepandemic vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Retrospective"))
```

```{r ocir percentage plot retro_prepan, fig.height=6, fig.width=10}
dat.long.ocir.diff %>%
  filter(Time_point != "retro_prepan") %>%
  ggplot(mapping = aes(
    x = ocir.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference OCI-R score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective")) +
  facet_wrap("Disorder_hierarchical")
```

### Plots sum

```{r ocir percentage plot retro_prepan sum}
dat.long.ocir.sum %>%
  ggplot(mapping = aes(
    x = ocir.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "OCI-R scores",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  )
```

```{r ocir percentage plot retro_prepan sum, fig.height=6, fig.width=10}
dat.long.ocir.sum %>%
  ggplot(mapping = aes(
    x = ocir.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "OCI-R score",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  ) +
  facet_wrap("Disorder_hierarchical")
```



Rank the disorders by the size of the change 



PCL:  
Calculate the total GLAD, COPING, RAMP baseline 
## pcl

```{r descriptives pcl.diff_score_cols}
pcl.numeric_table <- dat %>% 
#    group_by(Sample) %>%
  summarise_at( 
    vars(
      "Base - prepan" = pcl.diff_score_base_prepan
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

pcl.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
pcl.numeric_summary_table_reshaped <- pcl.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

pcl.numeric_summary_table_reshaped
```

Table for knitting
pcl diff summary table
```{r pcl diff summary table}
kable(pcl.numeric_summary_table_reshaped)
```


```{r descriptives pcl.sum_score}
pcl.sum_score_numeric_table <- dat %>% 
#    group_by(Sample) %>%
  summarise_at( 
    vars(
      "Prepan" = pcl.sum_score_prepan,
      "Base" = pcl.sum_score_base
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

pcl.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
pcl.sum_score_numeric_summary_table_reshaped <- pcl.sum_score_numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

pcl.sum_score_numeric_summary_table_reshaped
```

Table for knitting
pcl diff summary table
```{r pcl diff summary table}
kable(pcl.sum_score_numeric_summary_table_reshaped)
```

```{r pcl gather to long format Time_points pcl.sum_score}
dat.long.pcl.sum <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "pcl.sum_score",
    all_of(pcl.sum_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender_collapsed,
    Ethnicity_collapsed,
    Disorder_hierarchical,
    Time_point_raw,
    pcl.sum_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "pcl.sum_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.pcl.sum)
```

For each item 
present percentages of how say that this is due to the pandemic 
```{r pcl percentages due to pandemic}
pcl.retro.items <- c(
  "pcl.stressful_experience_upset_reminded_retro_numeric",
  "pcl.stressful_experience_repeated_images_retro_numeric",
  "pcl.stressful_situation_avoiding_activities_retro_numeric",
  "pcl.cut_people_feeling_distant_retro_numeric",
  "pcl.difficulty_concentrating_retro_numeric",
  "pcl.feeling_irritable_or_having_angry_outbursts_retro_numeric"
)

pcl.percentages.summary <- dat %>%
  select(
    all_of(pcl.retro.items)
  ) %>%
  gather(
    key = "PCL Item",
    value = "Binary_score",
    all_of(pcl.retro.items)
  ) %>%
  mutate(Binary_score = fct_explicit_na(as.factor(Binary_score), na_level = "Missing")) %>%
  group_by(`PCL Item`) %>%
  count(`PCL Item`, Binary_score) %>%
  mutate(prop = round(n/sum(n), 3)*100) %>%
  mutate(n_prop = paste0(n," (",prop, "%)"))

pcl.percentages.summary
```


### Plots sum

```{r pcl percentage plot retro_prepan sum}
dat.long.pcl.sum %>%
  ggplot(mapping = aes(
    x = pcl.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "PCL scores",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  )
```

```{r pcl percentage plot retro_prepan sum, fig.height=6, fig.width=10}
dat.long.pcl.sum %>%
  ggplot(mapping = aes(
    x = pcl.sum_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "PCL score",
    y = "Percentage of participants",
    fill = "Time point") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette3,
    labels = c("Baseline", "Prepandemic", "Retrospective")
  ) +
  facet_wrap("Disorder_hierarchical")
```


# Regression
Regress covariates out of the change? Which? 

Model 0a: Disorder_hierarchical
```{r Model 0a: Disorder_hierarchical}
model0a <- lm(
  formula = gad.diff_score_base_prepan ~ Disorder_hierarchical,
  data = dat.gad)

summary(model0a)
```

Model 0b: Disorders
```{r}
model0b <- lm(
  formula = ocir.diff_score_base_prepan ~
    anxiety_disorders +
    depressive_disorders +
    eating_disorders +
    obsessive_compulsive_disorders +
    psychotic_disorders +
    mhd.mania_hypomania_bipolar_or_manicdepression +
    mhd.posttraumatic_stress_disorder_ptsd +
    autism_spectrum_disorder +
    mhd.attention_deficit_hyperactivity_disorder +
    mhd.personality_disorder,
  data = dat)

summary(model0b)
```


Model 0: Disorders
```{r}
model0 <- lm(
  formula = gad.diff_score_base_prepan ~ Disorder,
  data = dat)

summary(model0)
```

```{r}
tidy(model0)
```

Model 1: Model 0 + Sex + Age + Ethnicity_collapsed + Time registration and baseline
```{r}
model1 <- lm(
  formula = phq.diff_score_base_prepan ~
    anxiety_disorders +
    depressive_disorders +
    eating_disorders +
    obsessive_compulsive_disorders +
    psychotic_disorders +
    mhd.mania_hypomania_bipolar_or_manicdepression +
    mhd.posttraumatic_stress_disorder_ptsd +
    autism_spectrum_disorder +
    mhd.attention_deficit_hyperactivity_disorder +
    mhd.personality_disorder +
    Gender_collapsed + age_category + Ethnicity_collapsed + time_diff_sign_up_coping,
  data = dat)

summary(model1)
```

Model 1: Model 0 + Sex + Age + Ethnicity_collapsed + Time registration and baseline
```{r}
model1 <- lm(
  formula = pcl.diff_score_base_prepan ~ Disorder_hierarchical + Gender_collapsed + age_category + Ethnicity_collapsed + time_diff_sign_up_coping,
  data = dat)

summary(model1)
```



Model 1: Model 0 + Sex + Age + Ethnicity_collapsed + Time registration and baseline
```{r}
model1 <- lm(
  formula = gad.diff_score_base_prepan ~ Disorder + Gender_collapsed + Age + Ethnicity_collapsed + time_diff_sign_up_coping,
  data = dat)

summary(model1)
```



# RUBBISH

+++ Everything underneath here is only SCRATCH

```{r RUBBISH 1}
gad.diff_score_base_prepan_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_base_prepan)) +
  geom_bar() +
  theme_minimal()

gad.diff_score_retro_prepan_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_retro_prepan)) +
  geom_bar() +
  theme_minimal()

gad.diff_score_base_retro_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_base_retro)) +
  geom_bar() +
  theme_minimal()

```

```{r RUBBISH 2 fig.height=7, fig.width=5}
gad.diff_score_base_prepan_plot /
  gad.diff_score_retro_prepan_plot /
  gad.diff_score_base_retro_plot +
  plot_layout(guides = "collect", heights = c(1,1,1)) +
  plot_annotation(tag_levels = "A")
```


Calculate mean change per disorder group 
Disorders (9) 
Sex 
Age (13; RAMP; potentially collapse above 65 depending on group sizes) 
Ethnicity groups (5; White European, Black (British), Asian, Arab, Mixed) 

```{r RUBBISH }
#ADD
```






Calculate a variable PCL pandemic score 
```{r}

```


If one item is highly endorsed due to pandemic -> exclude in sensitivity analysis 
```{r}

```

 


Descriptives for reporting: "How different are these feelings to how you felt before the pandemic?’ on a 5-point scale (much worse, a little worse, no different, a little better, much better)."
+++KLP: Discuss during the meeting if we use 3 or 5 categories
```{r}

```


Replicate chunk above for retrospective reports. This will only be for people who say that have reported that there is a change in their scores. 
*Discuss if we should include people who reported "no change" as repition of their current GAD, PHQ, PCL report*
```{r}

```


```{r}

```

