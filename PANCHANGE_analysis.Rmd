---
title: "PANCHANGE_analysis"
author: "Katie Thompson, Topher Huebel, Molly Davies, Kirstin Purves"
date: Sys.Date()
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

This is the analysis script to prepare the data to run analyses for the project "Anxiety, depression and trauma symptom change during the COVID-19 pandemic: retrospective versus objective assessment" - Young et al (2020)

Script written by K Purves, K Thompson, C Huebel and M Davies.
Email: kirstin.purves@kcl.ac.uk, katie.thompson@kcl.ac.uk, christopher.1.huebel@kcl.ac.uk, molly.davies@kcl.ac.uk

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

#Packages
Install packages (if they are not available in your version of R)
```{r Installing packages}
#install.packages("summarytools")
#install.packages("tidyverse")
#install.packages("psych")
#install.packages("broom")
#install.packages("skimr")
```

Load packages
```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(patchwork)
library(broom)
library(tidyverse)
```

# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```


# Data import

## Source data file paths 

```{r source file path}
#source raw data directory: data.raw_path
source("../PANCHANGE_raw_path.R")
```


## Read in data
```{r read in data}
dat.raw <- readRDS(file = paste0(data_path, "/four_cohorts.rds"))
dim(dat.raw)
colnames(dat.raw)
```


```{r dat.coping summary, eval=FALSE, include=FALSE}
summarytools::dfSummary(
  dat.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# Data availability

Data availability GAD
```{r gad availability}
dat.raw %>%
  freq(
    data_group_gad,
    cumul = F)
```

Data availability PHQ
```{r phq availability}
dat.raw %>%
  freq(
    data_group_phq,
    cumul = F)
```

Data availability PCL
```{r pcl availability}
dat.raw %>%
  freq(
    data_group_pcl,
    cumul = F)
```

Data availability OCI-R
```{r ocir availability}
dat.raw %>%
  freq(
    data_group_ocir,
    cumul = F)
```



# Exclusion
Filter data frame to exclude participants that never answered COPING
```{r exclusion criteria dat}
dat <- dat.raw %>%
  filter(
    (data_group_gad == "Baseline and retrospective data" |
      data_group_gad == "Prepandemic and baseline data" |
      data_group_gad == "All prepandemic, baseline and retrospective data") |
      (data_group_phq == "Baseline and retrospective data" |
      data_group_phq == "Prepandemic and baseline data" |
      data_group_phq == "All prepandemic, baseline and retrospective data") |
      (data_group_pcl == "Baseline and retrospective data" |
      data_group_pcl == "Prepandemic and baseline data" |
      data_group_pcl == "All prepandemic, baseline and retrospective data") |
      (data_group_ocir == "Baseline and retrospective data" |
      data_group_ocir == "Prepandemic and baseline data" |
      data_group_ocir == "All prepandemic, baseline and retrospective data")
  )
```

```{r dimensions of total dat}
dim(dat)
```


# Vectors for diff_score
```{r Vectors with diff_score_cols}
diff_score_cols <- dat %>%
  select(contains("diff_score")) %>% 
  colnames()

diff_score_cols

phq.diff_score_cols <- dat %>%
  select(contains("phq")) %>%
  select(contains("diff_score")) %>% 
  colnames()

phq.diff_score_cols

gad.diff_score_cols <- dat %>%
  select(contains("gad")) %>%
  select(contains("diff_score")) %>% 
  colnames()

gad.diff_score_cols

ocir.diff_score_cols <- dat %>%
  select(contains("ocir")) %>%
  select(contains("diff_score")) %>% 
  colnames()

ocir.diff_score_cols
```

# ggplot theme
Set up ggplot theme for the plots
```{r ggplot theme}
theme_personal <-  theme(
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    axis.title.y = element_blank(), 
    legend.background = element_blank(),
    legend.box.background = element_blank(),
    panel.background = element_blank(), 
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(
      colour = "gray",
      linetype = "dashed",
      size = 0.2
      ),
    axis.ticks = element_blank()
    )
```

# Psychiatric disorder hierarchy

control_numeric == 1 ~ 0,
depressive_disorders_numeric == 1 ~ 1,
anxiety_disorders_numeric == 1 ~ 2,
mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 3,
eating_disorders_numeric == 1 ~ 4,
obsessive_compulsive_disorders_numeric == 1 ~ 5,
mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 6,
mhd.personality_disorder_numeric == 1 ~ 7,
mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric == 1 ~ 8,
mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 9,
psychotic_disorders_numeric == 1 ~ 10

psychotic_disorders_numeric == 1 ~ 10
mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 9,
mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric == 1 ~ 8,
mhd.personality_disorder_numeric == 1 ~ 7,
mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 6,
obsessive_compulsive_disorders_numeric == 1 ~ 5,
eating_disorders_numeric == 1 ~ 4,
mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 3,
anxiety_disorders_numeric == 1 ~ 2,
depressive_disorders_numeric == 1 ~ 1,
control_numeric == 1 ~ 0,


```{r Psychiatric disorders hierarchy}
dat <- dat %>%
  mutate(
    Disorder_numeric =
      case_when(
        psychotic_disorders_numeric == 1 ~ 11,
        mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 10,
        mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric == 1 ~ 9,
        mhd.personality_disorder_numeric == 1 ~ 8,
        mhd.attention_deficit_hyperactivity_disorder_numeric == 1 ~ 7,
        obsessive_compulsive_disorders_numeric == 1 ~ 6,
        eating_disorders_numeric == 1 ~ 5,
        mhd.posttraumatic_stress_disorder_ptsd_numeric == 1 ~ 4,
        (anxiety_disorders_numeric == 1 &
        depressive_disorders_numeric == 1) ~ 3,
        anxiety_disorders_numeric == 1 ~ 2,
        depressive_disorders_numeric == 1 ~ 1,
        control_numeric == 1 ~ 0
      )
  )

dat <- dat %>%
  mutate(
    Disorder =
      recode_factor(
        Disorder_numeric,
        `0` = "Controls",
        `1` = "Depressive disorders",
        `2` = "Anxiety disorders",
        `3` = "Depressive & anxiety disorders",
        `4` = "PTSD",
        `5` = "Eating disorders",
        `6` = "OCDs",
        `7` = "ADHD",
        `8` = "Personality disorders",
        `9` = "Autism",
        `10` = "Bipolar disorders",
        `11` = "Psychotic disorders"
      )
  )


dat %>%
  freq(Disorder)
```

```{r}
dat %>%
  filter(is.na(Disorder)) %>%
  freq(Sample)
```


# Age
```{r descriptives Ages}
dat %>%
  group_by(Sample) %>%
  summarise(Mean = mean(Age),
            SD = sd(Age),
            Min = min(Age),
            Max = max(Age))
```

+++ADD CHUNK FOR AGE CATEGORIES HERE
```{r Age categories}

```


# Psychiatric disorders
```{r vector with psychiatric disorders}
disorder_columns <- c(
    "depressive_disorders_numeric",
    "anxiety_disorders_numeric",
    "eating_disorders_numeric",
    "obsessive_compulsive_disorders_numeric",
    "psychotic_disorders_numeric",
    "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
    "mhd.posttraumatic_stress_disorder_ptsd_numeric",
    "mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric",
    "mhd.attention_deficit_hyperactivity_disorder_numeric",
    "mhd.personality_disorder_numeric",
    "control_numeric"
)
```



```{r gather to long format Disorder}
dat.long.psych <- dat %>%
  gather(
    key = "Disorder_inc_raw",
    value = "Diagnosis",
    all_of(disorder_columns)) %>%
  select(
    ID,
    Sample,
    Gender,
    Ethnicity,
    all_of(diff_score_cols),
    Disorder_inc_raw,
    Diagnosis
  ) %>%
  mutate(Disorder_inc =
           recode_factor(
             Disorder_inc_raw,
             anxiety_disorders_numeric = "Anxiety disorders",
             depressive_disorders_numeric = "Depressive disorders",
             eating_disorders_numeric = "Eating disorders",
             obsessive_compulsive_disorders_numeric = "OCDs",
             psychotic_disorders_numeric = "Psychotic disorders",
             mhd.mania_hypomania_bipolar_or_manicdepression_numeric = "Bipolar disorders",
             mhd.posttraumatic_stress_disorder_ptsd_numeric = "PTSD",
             mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric = "Autism",
             mhd.attention_deficit_hyperactivity_disorder_numeric = "ADHD",
             mhd.personality_disorder_numeric = "Personality disorders",
             control_numeric = "Controls"
           ))

head(dat.long.psych)
```

Define disorder columns in vector

```{r Disorder_inc by Gender}
Disorder_by_Gender <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Gender) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Gender
```

```{r Disorder_inc by Gender}
Disorder_inc_by_Gender <- dat.long.psych %>%
  group_by(Disorder_inc) %>%
  filter(Diagnosis == 1) %>%
  count(Gender) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Gender
```


```{r Disorder_inc by Gender plot}
Disorder_inc_by_Gender %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
    ) +
  geom_bar(
    aes(fill = Gender),
#    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Gender") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4,
#    labels = c("Prepandemic", "Retrospective")
    ) +
  coord_flip()
```


```{r Disorder_inc by Sample}
Disorder_inc_by_Sample <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Sample)
```

```{r Disorder_inc by Sample plot}
Disorder_inc_by_Sample %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
    ) +
  geom_bar(
    aes(fill = Sample),
#    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4,
#    labels = c("Prepandemic", "Retrospective")
    ) +
  coord_flip()
```



Ethnicity should be recoded
European
Mixed or multiple ethnic origins
African or African British
Asian or Asian British
Arab
```{r Disorder_inc by Ethnicity}
Disorder_inc_by_Ethnicity <- dat.long.psych %>%
  filter(Diagnosis == 1) %>%
  count(Disorder_inc, Ethnicity) %>%
  mutate(Prop = round(n/sum(n), 2))

Disorder_inc_by_Ethnicity
```

```{r Disorder_inc by Ethnicity plot}
Disorder_inc_by_Ethnicity %>%
  ggplot(mapping = aes(
    x = Disorder_inc,
    y = n)
  ) +
  geom_bar(
    aes(fill = Ethnicity),
    #    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Disorders",
    y = "Number of participants",
    fill = "Ethnicity") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6,
    #    labels = c("Prepandemic", "Retrospective")
  ) +
  coord_flip()
```


Compare the GLAD/EDGI and COPING cohorts as a whole
+++CH: Diagnosis, ethnicity, gender, 
+++MD: May not be possible for NBR; potentially send them code to run it for us

# Ethnicity
```{r Ethnicity per Sample}
Ethnicity_by_Sample <- dat %>%
  count(Ethnicity, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))

Ethnicity_by_Sample
```

```{r Ethnicity by Sample plot}
Ethnicity_by_Sample %>%
  ggplot(mapping = aes(
    x = Ethnicity,
    y = n)
  ) +
  geom_bar(
    aes(fill = Sample),
    #    position = "dodge",
    stat="identity",
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Ethnicity",
    y = "Number of participants",
    fill = "Sample") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette6,
    #    labels = c("Prepandemic", "Retrospective")
  ) +
  coord_flip()
```

# Gender
```{r Gender per Sample prop per total}
dat %>%
  count(Gender, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

```{r Gender per Sample prop per Sample}
dat %>%
  group_by(Sample) %>%
  count(Gender, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

```{r Gender per Sample prop cross table}
dat %>%
  group_by(Sample) %>%
  count(Gender, Sample) %>%
  mutate(Prop = round(n/sum(n), 2)) %>%
  pivot_wider(names_from = Sample, values_from = c(n, Prop))
```


```{r Gender per Sample count cross table}
dat %>%
  count(Gender, Sample) %>%
  spread(key = Sample, value = n)
```


```{r}
dat %>%
  count(Gender, Sample) %>%
  spread(key = Sample, value = n) %>%
  select(-Gender) %>%
  chisq.test() %>%
  glance()
```


# highest_education
```{r highest_education per Sample}
dat %>%
  count(highest_education, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

# Key worker status
```{r Key worker status per sample}
dat %>%
  count(key_worker, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

# COVID
## COVID swab test positive
```{r COVID positive swap}
dat %>%
  count(respiratory.throat_swab_test_nose, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```

## antibody test
```{r COVID positive antibody test}
dat %>%
  count(respiratory.results_antibody_test, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```


## COVID probable diagnosis
```{r COVID probable diagnosis}
dat %>%
  count(covid_probable_case_incl_screening, Sample) %>%
  mutate(Prop = round(n/sum(n), 2))
```


# Questionnaire comparions

## gad

```{r descriptives gad.diff_score_cols}
gad.numeric_table <- dat %>% 
#  group_by(dem.sex) %>%
  summarise_at( 
    vars(
      "Base - prepan" = gad.diff_score_base_prepan,
      "Base - retro" = gad.diff_score_base_retro,
      "Prepan - retro" = gad.diff_score_prepan_retro,
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

gad.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
gad.numeric_summary_table_reshaped <- gad.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
    ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 
  
gad.numeric_summary_table_reshaped
```

Table for knitting
gad diff summary table
```{r gad diff summary table}
kable(gad.numeric_summary_table_reshaped)
```



```{r gad gather to long format Time_points}
dat.long.gad.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "gad.diff_score",
    all_of(gad.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender,
    Ethnicity,
    Time_point_raw,
    gad.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "gad.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.gad.diff)
```

makes this into percentages
```{r gad absolut plot}
dat.long.gad.diff %>%
  ggplot(mapping = aes(y = gad.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```

```{r gad percentage plot prepan_retro}
dat.long.gad.diff %>%
  filter(Time_point != "prepan_retro") %>%
  ggplot(mapping = aes(
    x = gad.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference GAD7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```

```{r gad plot prepan_retro diff}
dat.long.gad.diff %>%
  filter(Time_point == "prepan_retro") %>%
  ggplot(mapping = aes(
    x = gad.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference GAD7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nPrepandemic vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Retrospective"))
```



## phq

```{r descriptives phq.diff_score_cols}
phq.numeric_table <- dat %>% 
  #  group_by(dem.sex) %>%
  summarise_at( 
    vars(
      "Base - prepan" = phq.diff_score_base_prepan,
      "Base - retro" = phq.diff_score_base_retro,
      "Prepan - retro" = phq.diff_score_prepan_retro,
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

phq.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
phq.numeric_summary_table_reshaped <- phq.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

phq.numeric_summary_table_reshaped
```

Table for knitting
phq diff summary table
```{r phq diff summary table}
kable(phq.numeric_summary_table_reshaped)
```



```{r phq gather to long format Time_points}
dat.long.phq.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "phq.diff_score",
    all_of(phq.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender,
    Ethnicity,
    Time_point_raw,
    phq.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "phq.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.phq.diff)
```

makes this into percentages
```{r phq absolut plot}
dat.long.phq.diff %>%
  ggplot(mapping = aes(y = phq.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```

```{r phq percentage plot prepan_retro}
dat.long.phq.diff %>%
  filter(Time_point != "prepan_retro") %>%
  ggplot(mapping = aes(
    x = phq.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference phq7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```

```{r phq plot prepan_retro diff}
dat.long.phq.diff %>%
  filter(Time_point == "prepan_retro") %>%
  ggplot(mapping = aes(
    x = phq.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference phq7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nPrepandemic vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Retrospective"))
```


## ocir

```{r descriptives ocir.diff_score_cols}
ocir.numeric_table <- dat %>% 
  #  group_by(dem.sex) %>%
  summarise_at( 
    vars(
      "Base - prepan" = ocir.diff_score_base_prepan,
      "Base - retro" = ocir.diff_score_base_retro,
      "Prepan - retro" = ocir.diff_score_prepan_retro,
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

ocir.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
ocir.numeric_summary_table_reshaped <- ocir.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

ocir.numeric_summary_table_reshaped
```

Table for knitting
ocir diff summary table
```{r ocir diff summary table}
kable(ocir.numeric_summary_table_reshaped)
```



```{r ocir gather to long format Time_points}
dat.long.ocir.diff <- dat %>%
  gather(
    key = "Time_point_raw",
    value = "ocir.diff_score",
    all_of(ocir.diff_score_cols)) %>%
  select(
    ID,
    Sample,
    Gender,
    Ethnicity,
    Time_point_raw,
    ocir.diff_score
  ) %>%
  mutate(Time_point = str_replace(Time_point_raw, "ocir.diff_score_", "")) %>%
  select(-Time_point_raw)

head(dat.long.ocir.diff)
```

makes this into percentages
```{r ocir absolut plot}
dat.long.ocir.diff %>%
  ggplot(mapping = aes(y = ocir.diff_score)) +
  geom_bar() +
  theme_minimal() +
  facet_wrap(facets = vars(Time_point))
```

```{r ocir percentage plot prepan_retro}
dat.long.ocir.diff %>%
  filter(Time_point != "prepan_retro") %>%
  ggplot(mapping = aes(
    x = ocir.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference ocir7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nBaseline vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Prepandemic", "Retrospective"))
```

```{r ocir plot prepan_retro diff}
dat.long.ocir.diff %>%
  filter(Time_point == "prepan_retro") %>%
  ggplot(mapping = aes(
    x = ocir.diff_score,
    y = stat(density*width),
    fill = Time_point)) +
  geom_histogram(
    binwidth = 1,
    position = position_dodge2(preserve = "single")
  ) +
  labs(
    x = "Difference ocir7 score",
    y = "Percentage of participants",
    fill = "Comparison:\nPrepandemic vs") +
  theme_personal +
  scale_fill_manual(values = palette, labels = c("Retrospective"))
```



+++ Everything underneath here is only SCRATCH

```{r RUBBISH 1}
gad.diff_score_prepan_base_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_prepan_base)) +
  geom_bar() +
  theme_minimal()

gad.diff_score_prepan_retro_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_prepan_retro)) +
  geom_bar() +
  theme_minimal()

gad.diff_score_prepan_base_plot <- dat %>%
  ggplot(mapping = aes(y = gad.diff_score_prepan_base)) +
  geom_bar() +
  theme_minimal()

```

```{r RUBBISH 2 fig.height=5, fig.width=5}
gad.diff_score_prepan_base_plot /
  gad.diff_score_prepan_retro_plot /
  gad.diff_score_prepan_base_plot +
  plot_layout(guides = "collect", heights = c(1,1,1)) +
  plot_annotation(tag_levels = "A")
```


Calculate mean change per disorder group 
Disorders (9) 
Sex 
Age (13; RAMP; potentially collapse above 65 depending on group sizes) 
Ethnicity groups (5; White European, Black (British), Asian, Arab, Mixed) 

```{r RUBBISH }
#ADD
```


Rank the disorders by the size of the change 


# Regression
Regress covariates out of the change? Which? 

Model 0: Disorders
```{r}
model0 <- lm(
  formula = gad.diff_score_prepan_retro ~ Disorder,
  data = dat)

summary(model0)
```

```{r}
tidy(model0)
```


Model 1: Model 0 + Sex + Age + Ethnicity + Time registration and baseline
```{r}
model1 <- lm(
  formula = gad.diff_score_base_retro ~ Disorder + Gender + Age + Ethnicity + time_diff_sign_up_coping,
  data = dat)

summary(model1)
```


PCL:  
Calculate the total GLAD, COPING, RAMP baseline 
## pcl

```{r descriptives pcl.diff_score_cols}
pcl.numeric_table <- dat %>% 
#    group_by(Sample) %>%
  summarise_at( 
    vars(
      "Base - prepan" = pcl.diff_score_base_prepan
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

pcl.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
pcl.numeric_summary_table_reshaped <- pcl.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

pcl.numeric_summary_table_reshaped
```

Table for knitting
pcl diff summary table
```{r pcl diff summary table}
kable(pcl.numeric_summary_table_reshaped)
```


```{r descriptives pcl.diff_score_cols}
pcl.numeric_table <- dat %>% 
#    group_by(Sample) %>%
  summarise_at( 
    vars(
      "Prepan" = pcl.sum_score_prepan,
      "Base" = pcl.sum_score_base
    ),
    .funs =
      list(
        ~mean(., na.rm = T),
        ~sd(., na.rm = T),
        ~median(., na.rm = T),
        ~min(., na.rm = T),
        ~max(., na.rm = T),
        ~skew(., na.rm = T),
        kurtosis = ~kurtosi(., na.rm = T)
      )
  )

pcl.numeric_table
```

```{r smart numeric summary tables}
# reshape the table
pcl.numeric_summary_table_reshaped <- pcl.numeric_table %>% 
  gather(key, value) %>% 
  separate(key, c("variable", "measure"), sep = "_") %>%
  mutate(measure = factor(
    x = measure,
    levels =  c( # this is the order I want my columns to appear in
      "missing",
      "min",
      "max",
      "mean", 
      "median", 
      "mode",
      "sd",
      "skew",
      "kurtosis"
    ))) %>% 
  spread(measure, value) %>% 
  # we can apply a function to all variables to edit them so that they are publication ready
  rename_all(
    .funs = ~str_to_title(.)
  ) %>% 
  # or we can individually rename variables 
  rename(
    SD = Sd
  ) 

pcl.numeric_summary_table_reshaped
```

Table for knitting
pcl diff summary table
```{r pcl diff summary table}
kable(pcl.numeric_summary_table_reshaped)
```





For each item 
present percentages of how say that this is due to the pandemic 
```{r}

```


Calculate a variable PCL pandemic score 
```{r}

```


If one item is highly endorsed due to pandemic -> exclude in sensitivity analysis 
```{r}

```

 


Descriptives for reporting: "How different are these feelings to how you felt before the pandemic?’ on a 5-point scale (much worse, a little worse, no different, a little better, much better)."
+++KLP: Discuss during the meeting if we use 3 or 5 categories
```{r}

```


Replicate chunk above for retrospective reports. This will only be for people who say that have reported that there is a change in their scores. 
*Discuss if we should include people who reported "no change" as repition of their current GAD, PHQ, PCL report*
```{r}

```


```{r}

```

