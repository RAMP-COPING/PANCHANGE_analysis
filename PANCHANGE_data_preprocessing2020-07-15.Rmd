---
title: "PANCHANGE_data_preprocessing"
author: "Katie Thompson, Topher Huebel, Molly Davies, Kirstin Purves"
date: Sys.Date()
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

This is the preprocessing script to prepare the data to run analyses for the project "Anxiety, depression and trauma symptom change during the COVID-19 pandemic: retrospective versus objective assessment" - Young et al (2020)

Script written by K Purves, K Thompson, C Huebel and M Davies.
Email: kirstin.purves@kcl.ac.uk, katie.thompson@kcl.ac.uk, christopher.1.huebel@kcl.ac.uk, molly.davies@kcl.ac.uk

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)


options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

# Specify cohort
```{r Specify cohort}
GLAD = FALSE
EDGI = FALSE
NBR = FALSE
RAMP = TRUE
```


#Packages
Install packages (if they are not available in your version of R)
```{r Installing packages}
#install.packages("summarytools")
#install.packages("tidyverse")
#install.packages("psych")
#install.packages("eeptools")
#install.packages("skimr")
```

Load packages
```{r Load packages}
library(knitr)
library(summarytools)
library(psych)
library(eeptools) # Needed to calculate age from birthdate
library(tidyverse)
```

# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```

#Add_numeric function
Function used to convert character variables into numeric variables. 
```{r add_numeric function}
add_numeric <- function(dat, exclude = NULL) {
  dat_fct <- sjlabelled::as_label(dat)

  dat <- dat[!colnames(dat) %in% exclude]
  colnames(dat) <- paste(colnames(dat), "numeric", sep = "_")
  return(bind_cols(dat_fct, dat))
}
```

# Data import and merging

Note: GLAD only receives current measures and RAMP questionnaire
Note: All COPING surveys are separate surveys

# Source data file paths 

```{r source file path}
#source raw data directory: data.raw_path
source("../PANCHANGE_raw_path.R")
```

# Demographics
## GLAD
### Read in data
```{r glad dem cols}
if(GLAD == TRUE){
glad.dem.raw <- readRDS(file = paste0(data.raw_path, "/glad/dem_glad.rds"))
dim(glad.dem.raw)
colnames(glad.dem.raw)
}
```

### Select variables
```{r glad dem cleaning}
if(GLAD == TRUE){
exclude_cols_dem <- c("ID",
                  "Sample",
                  "startDate.prepandemic",
                  "Age_uncleaned",
                  "EduYrs")

glad.dem.raw.id <- glad.dem.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
         Sample, # Sample
         ID, # ID
         startDate.prepandemic = startDate, #Date when participant signed up to glad
         Age_uncleaned = demographics.how_old_are_you_now.txt, # Age
         Gender_unc = demographics.which_gender_do_you_identify_with, # Gender
         Sex = demographics.select_questionnaire_items_medical, #Sex
         EduYrs = demographics.school_education_school_years.txt, # Years in education
         demographics.college_or_university_degree, # level of education - univeristy
         demographics.a_levelsas_levels_or_equivalent, # level of education - alevel
         demographics.o_levelsgcses_or_equivalent, # level of education - gcse
         demographics.cses_or_equivalent, # level of education - cse
         demographics.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
         Ethnicity_unc = demographics.questions_based_ethnic_origin # Ethnicity
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.dem.raw.id)
# Inspect colnames
colnames(glad.dem.raw.id)
#Differences
dim(glad.dem.raw)[1]-dim(glad.dem.raw.id)[1]
}
```

```{r glad copy dem}
if(GLAD == TRUE){
dem.raw.id <- glad.dem.raw.id
}
```

```{r glad dem summary}
if(GLAD == TRUE) {
summarytools::dfSummary(
  dem.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
}
```

## EDGI
### Read in data
```{r edgi dem cols}
if(EDGI == TRUE){
  edgi.dem.raw <- readRDS(file = paste0(data.raw_path, "/edgi/dem_edgi.rds"))
  dim(edgi.dem.raw)
  colnames(edgi.dem.raw)
}
```

### Select variables
```{r edgi dem cleaning}
if(EDGI == TRUE){
  exclude_cols_dem <- c("ID",
                        "Sample",
                        "startDate.prepandemic",
                        "Age_uncleaned",
                        "EduYrs")
  
  edgi.dem.raw.id <- edgi.dem.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
      startDate.prepandemic = startDate, #Date when participant signed up to edgi
      Age_uncleaned = demographics.how_old_are_you_now.txt, # Age
      Gender_unc = demographics.what_gender_do_you_identify_with, # Gender (which [GLAD] vs what [EDGI])
      Sex = demographics.select_questionnaire_items_birth, #Sex (different to GLAD)
      EduYrs = demographics.university_education_attend_school.txt, # Years in education (different to GLAD)
      demographics.college_or_university_degree, # level of education - univeristy
      demographics.a_levelsas_levels_or_equivalent, # level of education - alevel
      demographics.o_levelsgcses_or_equivalent, # level of education - gcse
      demographics.cses_or_equivalent, # level of education - cse
      demographics.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
      Ethnicity_unc = demographics.what_is_your_ethnic_origin # Ethnicity (different to GLAD)
    ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(edgi.dem.raw.id)
  # Inspect colnames
  colnames(edgi.dem.raw.id)
  #Differences
  dim(edgi.dem.raw)[1]-dim(edgi.dem.raw.id)[1]
}
```

```{r edgi copy dem}
if(EDGI == TRUE){
  dem.raw.id <- edgi.dem.raw.id
}
```

```{r edgi dem summary}
if(EDGI == TRUE) {
summarytools::dfSummary(
  dem.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
}
```

## NBR
### Read in data
```{r nbr dem cols}
if(NBR == TRUE){
  nbr.dem.raw <- readRDS(file = paste0(data.raw_path, "/nbr/dem_nbr.rds"))
  dim(nbr.dem.raw)
  colnames(nbr.dem.raw)
}
```

### Select variables
```{r nbr dem cleaning}
if(NBR == TRUE){
  exclude_cols_dem <- c("ID",
                        "Sample",
                        "Age_uncleaned",
                        "EduYrs")
  
  nbr.dem.raw.id <- nbr.dem.raw %>%
    drop_na(subjectid) %>% # Drop NAs
    distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
    separate(ID.intm, into = "ID", sep = 7) %>%
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
#      startDate.coping, # Date when participant signed up to nbr (is in the coping gad chunk)
#      Age_uncleaned = demographics.how_old_are_you_now.txt, # Age
      Birthyear_unc = demographics.year, # Birthyear
      Birthmonth = demographics.month, #Birthmonth
      Birthday = demographics.day, #Birthday
      Gender_unc = demographics.which_gender_do_you_identify_with, # Gender
      Sex = demographics.select_questionnaire_items_medical, #Sex
#      Ethnicity = demographics.questions_based_ethnic_origin # Ethnicity
    ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(nbr.dem.raw.id)
  # Inspect colnames
  colnames(nbr.dem.raw.id)
  #Differences
  dim(nbr.dem.raw)[1]-dim(nbr.dem.raw.id)[1]
}
```

```{r nbr dem calculating age from birthday}
if(NBR == TRUE) {
#add 1900 to birthyear
nbr.dem.raw.id$Birthyear_numeric <- nbr.dem.raw.id$Birthyear_unc_numeric + 1900
  
#create dob as date format
nbr.dem.raw.id$Birthdate <- as.Date(paste(nbr.dem.raw.id$Birthyear_numeric,
                                  nbr.dem.raw.id$Birthmonth_numeric,
                                  nbr.dem.raw.id$Birthday_numeric,
                                  sep = "-"))

head(nbr.dem.raw.id$Birthdate)

#Calculate dem.age(remove NAs as it throws an error)
ages <- age_calc(na.omit(nbr.dem.raw.id$Birthdate), enddate = Sys.Date(), units = "years")

#Create dem.agecolumn
nbr.dem.raw.id$Age_uncleaned<- NA

#Populate with values (excluding NAs)
nbr.dem.raw.id$Age_uncleaned[!is.na(nbr.dem.raw.id$Birthdate)] <- ages

#Round age down
nbr.dem.raw.id$Age_uncleaned <- floor(nbr.dem.raw.id$Age_uncleaned)

#Visualise
head(nbr.dem.raw.id$Age_uncleaned)
head(nbr.dem.raw.id$Birthdate)
}
```


### Cohort information
Information on INTERVAL, COMPARE, and STRIDES
http://www.donorhealth-btru.nihr.ac.uk/studies/
```{r nbr cohort information}
if(NBR == TRUE){
  nbr.cohort.raw <- readxl::read_xlsx(
    path = paste0(data.raw_path, "/nbr/coping_participants_export_20200730.xlsx")
    )

  dim(nbr.cohort.raw)
  colnames(nbr.cohort.raw)
  }
```


```{r nbr cohort cleaning}
if(NBR == TRUE) {
exclude_cols_cohort_nbr <- c("ID",
                  "Sample",
                  "Age_uncleaned",
                  "EduYrs")

nbr.cohort.raw.id <- nbr.cohort.raw %>%
  drop_na(`NBR ID`) %>% # Drop NAs
  distinct(`NBR ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`NBR ID`, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(
    ID = as.numeric(ID)) %>%
  select(
         Sample, # Sample
         ID, # ID
         Cohort = cohort, #cohort information
#         startDate.coping, #Date when participant signed up to NBR COPING (is in the coping gad chunk)
#         Age_uncleaned = age, # Age
#         Gender = gender, # Gender
#         Sex = demographics.select_questionnaire_items_medical, #Sex
#         EduYrs = demographics.school_education_school_years.txt, # Years in education
#         demographics.college_or_university_degree, # level of education - univeristy
#         demographics.a_levelsas_levels_or_equivalent, # level of education - alevel
#         demographics.o_levelsgcses_or_equivalent, # level of education - gcse
#         demographics.cses_or_equivalent, # level of education - cse
#         demographics.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
         Ethnicity.unc = ethnicity # Ethnicity
         ) %>%
  add_numeric(., exclude = exclude_cols_cohort_nbr) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(nbr.cohort.raw.id)
# Inspect colnames
colnames(nbr.cohort.raw.id)
#Differences
dim(nbr.cohort.raw)[1]-dim(nbr.cohort.raw.id)[1]
}
```

```{r nbr cohort recode ethnicity}
if(NBR == TRUE) {
#Recode details ethnicity info
nbr.cohort.raw.id$Ethnicity_full <- recode_factor(nbr.cohort.raw.id$Ethnicity.unc,
                                             "A" = "White - British",
                                             "B" = "White - Irish",
                                             "C" = "White - Other",
                                             "D" = "Mixed - White & Black Caribbean",
                                             "E" = "Mixed - White & Black African",
                                             "F" = "Mixed - White & Asian",
                                             "G" = "Mixed - Other",
                                             "H" = "Asian - Indian",
                                             "J" = "Asian - Pakistani",
                                             "K" = "Asian - Bangladeshi",
                                             "L" = "Asian - Other",
                                             "M" = "Black - Caribbean",
                                             "N" = "Black - African",
                                             "P" = "Black - Other",
                                             "R" = "Chinese - Chinese",
                                             "S" = "Chinese - Other",
                                             "W" = NULL, ## Asking NBR what this level means
                                             "Z" = NULL,
                                             "99" = NULL)

#Match GLAD/EDGI/RAMP categories
nbr.cohort.raw.id$Ethnicity_unc <- recode_factor(nbr.cohort.raw.id$Ethnicity.unc,
                                             "A" = "White, white European or Caucasian",
                                             "B" = "White, white European or Caucasian",
                                             "C" = "White, white European or Caucasian",
                                             "D" = "Mixed or multiple ethnic origins",
                                             "E" = "Mixed or multiple ethnic origins",
                                             "F" = "Mixed or multiple ethnic origins",
                                             "G" = "Mixed or multiple ethnic origins",
                                             "H" = "Asian or Asian British (including Chinese)",
                                             "J" = "Asian or Asian British (including Chinese)",
                                             "K" = "Asian or Asian British (including Chinese)",
                                             "L" = "Asian or Asian British (including Chinese)",
                                             "M" = "Black or Black British",
                                             "N" = "Black or Black British",
                                             "P" = "Black or Black British",
                                             "R" = "Asian or Asian British (including Chinese)",
                                             "S" = "Asian or Asian British (including Chinese)",
                                             "W" = NULL, ## Asking NBR what this level means
                                             "Z" = NULL,
                                             "99" = NULL)
}
```


```{r nbr combine demographics}
if(NBR == TRUE){
dem.raw.id <- left_join(nbr.dem.raw.id, nbr.cohort.raw.id, by = c("Sample", "ID"))

# Inspect dimensions
dim(dem.raw.id)
# Inspect colnames
colnames(dem.raw.id)
#Differences
dim(nbr.dem.raw.id)[1]-dim(dem.raw.id)[1]
}
```

```{r nbr dem summary}
if(NBR == TRUE) {
summarytools::dfSummary(
  dem.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
}
```

## RAMP
### Read in data
```{r ramp dem cols}
if(RAMP == TRUE){
  ramp.dem.raw <- readRDS(file = paste0(data.raw_path, "/ramp/dem_ramp.rds"))
  dim(ramp.dem.raw)
  colnames(ramp.dem.raw)
}
```


### Select variables
```{r ramp dem cleaning}
if(RAMP == TRUE){
  exclude_cols_dem <- c("ID",
                        "Sample")
  
  ramp.dem.raw.id <- ramp.dem.raw %>%
    drop_na(`Login ID`) %>% # Drop NAs
    distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
#      startDate.coping, #Date when participant signed up to ramp  (is in the coping gad chunk)
      age_category = demographics.how_old_are_you, # Age
      Gender = demographics.which_gender_do_you_identify_with, # Gender (what [GLAD] vs which [RAMP])
#     EduYrs = demographics.university_education_attend_school.txt, # Years in education - not in RAMP dataset
#     demographics.college_or_university_degree, # level of education - univeristy - level of education is in employment file
#     demographics.a_levelsas_levels_or_equivalent, # level of education - alevel
#     demographics.o_levelsgcses_or_equivalent, # level of education - gcse
#     demographics.cses_or_equivalent, # level of education - cse
#     demographics.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
      Transgender_uncleaned = demographics.do_you_identify_as_transgender,
      Ethnicity_unc = demographics.what_is_your_ethnic_origin # Ethnicity
    ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(ramp.dem.raw.id)
  # Inspect colnames
  colnames(ramp.dem.raw.id)
  #Differences
  dim(ramp.dem.raw)[1]-dim(ramp.dem.raw.id)[1]
}
```

```{r ramp copy dem}
if(RAMP == TRUE){
  dem.raw.id <- ramp.dem.raw.id
}
```


## Demographics variable creation

# Gender categories synchronised
RAMP has the correct Gender categories so does not need editing. 
```{r gender recoding for GLAD}
if(GLAD == TRUE | NBR == TRUE) {

dem.raw.id <- dem.raw.id %>%
  mutate(
    Gender = 
      recode_factor(Gender_unc,
        "Male" = "Male",
        "Female" = "Female",
        "Non-binary" = "Non-binary",
        "Prefer to self-define (please tell us more)" = "Prefer to self-define"
      )
  ) %>%
  rename(
    Gender_numeric = Gender_unc_numeric
  )
}
```

```{r gender recoding for EDGI}
if(EDGI == TRUE) {

dem.raw.id <- dem.raw.id %>%
  mutate(
    Gender = 
      recode_factor(Gender_unc,
        "Male" = "Male",
        "Female" = "Female",
        "Non-binary" = "Non-binary",
        "Prefer to self-define (please tell us more):" = "Prefer to self-define"
      )
  ) %>%
  rename(
    Gender_numeric = Gender_unc_numeric
  )
}
```

# Ethnicity recoding

```{r ethnicity recoding for EDGI}
if(EDGI == TRUE) {

dem.raw.id <- dem.raw.id %>%
  mutate(
    Ethnicity = 
      recode_factor(Ethnicity_unc,
        "White" = "European",
        "Mixed" = "Mixed or multiple ethnic origins",
        "Asian or Asian British" = "Asian or Asian British",
        "Black or Black British" = "African or African British",
        "Arab" = "Arab",
        "Other ethnic group:" = "Other ethnic group"
      )
  ) %>%
  rename(
    Ethnicity_numeric = Ethnicity_unc_numeric
  )
}
```

```{r ethnicity recoding for GLAD and RAMP}
if(GLAD == TRUE | RAMP == TRUE) {

dem.raw.id <- dem.raw.id %>%
  mutate(
    Ethnicity = 
      recode_factor(Ethnicity_unc,
        "White, white European or Caucasian" = "European",
        "Mixed or multiple ethnic origins" = "Mixed or multiple ethnic origins",
        "Asian or Asian British (including Chinese)" = "Asian or Asian British",
        "Black or Black British" = "African or African British",
        "Arab" = "Arab",
        "Other ethnic group (please specify)" = "Other ethnic group"
      )
  ) %>%
  rename(
    Ethnicity_numeric = Ethnicity_unc_numeric
  )
}
```

```{r ethnicity recoding for NBR}
if(NBR == TRUE) {

dem.raw.id <- dem.raw.id %>%
  mutate(
    Ethnicity = 
      recode_factor(Ethnicity_unc,
        "White, white European or Caucasian" = "European",
        "Mixed or multiple ethnic origins" = "Mixed or multiple ethnic origins",
        "Asian or Asian British (including Chinese)" = "Asian or Asian British",
        "Black or Black British" = "African or African British",
        "Arab" = "Arab",
        "Other ethnic group (please specify)" = "Other ethnic group"
      )
  ) %>%
  mutate(
    Ethnicity_numeric = 
      recode(Ethnicity_unc,
        "European" = 1,
        "Mixed or multiple ethnic origins" = 2,
        "Asian or Asian British" = 3,
        "African or African British" = 4,
        "Arab" = 5,
        "Other ethnic group" = 6
      )
  )
}
```



# Clean Age variable
Age outlier
```{r age outlier}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE ) {
# Define age limits 
age_upper_limit = 117 # The oldest person in the world is 117 years
age_lower_limit = 16

# identify number of outliers
length(
  which(
  dem.raw.id$Age_uncleaned > age_upper_limit |
    dem.raw.id$Age_uncleaned < age_lower_limit
     )
)

# remove age outliers
dem.raw.id <- dem.raw.id %>%
  mutate(
    Age = 
      if_else(
        Age_uncleaned > age_upper_limit | 
        Age_uncleaned < age_lower_limit, 
        true = NA_real_,
        false = Age_uncleaned,
        missing = NA_real_
      )
  )

# Inspect variable
dem.raw.id %>%
  descr(
    Age,
    #stats = "common"
    )
}
```

## Categorise age into groups 
In RAMP, age is indicated categorically: 16-18, 19-25, 26-35, 36-45, 46-55, 56-65, 66-70, 71-75, 76-80, 81-85, 86-90, 91-100, 100+
Age categories in GLAD, EDGI and NBR have been created to reflect this
```{r Age groups}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE) {
# Create categorical age groups per 10 years
dem.raw.id <- dem.raw.id %>%
  mutate(
    age_category_numeric =
      case_when(
          Age >= 16 & Age <= 18 ~ 1,
          Age >= 19 & Age <= 25 ~ 2,
          Age >= 26 & Age <= 35 ~ 3,
          Age >= 36 & Age <= 45 ~ 4,
          Age >= 46 & Age <= 55 ~ 5,
          Age >= 56 & Age <= 65 ~ 6,
          Age >= 66 & Age <= 70 ~ 7,
          Age >= 71 & Age <= 75 ~ 8,
          Age >= 76 & Age <= 80 ~ 9,
          Age >= 81 & Age <= 85 ~ 10,
          Age >= 86 & Age <= 90 ~ 11,
          Age >= 91 & Age <= 100 ~ 12,
          Age >= 101 & Age <= 120 ~ 13 # oldest person in the world is 117 years
                )
      )



dem.raw.id <- dem.raw.id %>%
    mutate(
      age_category =
        recode_factor(
          age_category_numeric, 
          "1" = "16-18",
          "2" = "19-25",
          "3" = "26-35",
          "4" = "36-45",
          "5" = "46-55",
          "6" = "56-65",
          "7" = "66-70",
          "8" = "71-75",
          "9" = "76-80",
          "10" = "81-85",
          "11" = "86-90",
          "12" = "91-100",
          "13" = "100+"
          )
    )

dem.raw.id %>%
  freq(age_category)
}
```

## Highest education (prepandemic, GLAD & EDGI)

Proceed along qualifications fields. If field is not blank, take that as highest qual. If field is blank, check next field. If all fields are blank, NA
Assumes University degree > A level > NVQ > GCSE/O Level/CSE
```{r Highest education prepandemic}
if(GLAD == TRUE | EDGI == TRUE) {
#create numeric version of the highest education variable
dem.raw.id <- dem.raw.id %>%
  mutate(
    highest_education_prepan_numeric =
      case_when(
        demographics.college_or_university_degree_numeric == "1" ~ 4,
        demographics.a_levelsas_levels_or_equivalent_numeric == "1" ~ 3,
        demographics.nvq_or_hnd_or_hnc_or_equivalent_numeric == "1" ~ 2,
        demographics.o_levelsgcses_or_equivalent_numeric == "1" ~ 1,
        demographics.cses_or_equivalent_numeric == "1" ~ 1)
    )

#recode the numeric version into a factor
dem.raw.id <- dem.raw.id %>%
  mutate(
    highest_education_prepan =
      recode_factor(
        highest_education_prepan_numeric,
        `1` = "GCSE/CSE",
        `2` = "NVQ",
        `3` = "A-levels",
        `4` = "University")
    )

dem.raw.id %>%
  freq(highest_education_prepan)
}
```

Check highest education coding
```{r Highest education prepandemic check}
if(GLAD == TRUE | EDGI == TRUE) {
dem.raw.id %>%
  select(highest_education_prepan,
        demographics.college_or_university_degree_numeric,
        demographics.a_levelsas_levels_or_equivalent_numeric,
        demographics.nvq_or_hnd_or_hnc_or_equivalent_numeric,
        demographics.o_levelsgcses_or_equivalent_numeric,
        demographics.cses_or_equivalent_numeric
  )
}
```

```{r dem summary}
if(GLAD == TRUE | EDGI == TRUE) {
summarytools::dfSummary(
  dem.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
}
```

# Employment

## GLAD
### Read in data
```{r glad employment cols}
if(GLAD == TRUE){
glad.employment.raw <- readRDS(file = paste0(data.raw_path, "/glad/employment_coping_glad.rds"))
dim(glad.employment.raw)
colnames(glad.employment.raw)
}
```

### Select variables
```{r glad employment cleaning}
if(GLAD == TRUE){
exclude_cols_employment <- c("ID",
                  "Sample")

glad.employment.raw.id <- glad.employment.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(
    ID = as.numeric(ID)
    ) %>%
  select(
         Sample, # Sample
         ID, # ID
         employment.phd, # level of education - univeristy
         employment.masters_degree_or_equivalent, # level of education - univeristy
         employment.postgraduate_degree_or_equivalent, # level of education - univeristy
         employment.bachelors_degree_or_equivalent, # level of education - univeristy
         employment.a_levelsas_levels_or_equivalent, # level of education - alevel
         employment.o_levelsgcses_or_equivalent, # level of education - gcse
         employment.cses_or_equivalent, # level of education - cse
         employment.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
         employment.government_work_key_workers # key worker status
         ) %>%
  add_numeric(., exclude = exclude_cols_employment) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.employment.raw.id)
# Inspect colnames
colnames(glad.employment.raw.id)
#Differences
dim(glad.employment.raw)[1]-dim(glad.employment.raw.id)[1]
}
```

```{r glad copy employment}
if(GLAD == TRUE){
  employment.raw.id <- glad.employment.raw.id
}
```

## EDGI
### Read in data
```{r edgi employment cols}
if(EDGI == TRUE){
edgi.employment.raw <- readRDS(file = paste0(data.raw_path, "/edgi/employment_coping_edgi.rds"))
dim(edgi.employment.raw)
colnames(edgi.employment.raw)
}
```

### Select variables
```{r edgi employment cleaning}
if(EDGI == TRUE){
exclude_cols_employment_edgi <- c("ID",
                  "Sample",
                  "COPING_ID")

edgi.employment.raw.id <- edgi.employment.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
#  separate("Login ID", into = c("COPING_Sample", "COPING_ID"), sep = 6) %>% # Split ID in Sample and Number
  mutate(
    ID = as.numeric(ID),
#    COPING_ID = as.numeric(COPING_ID)
    ) %>%
  select(
         Sample, # Sample
         ID, # ID
         COPING_ID = "Login ID",
         employment.phd, # level of education - univeristy
         employment.masters_degree_or_equivalent, # level of education - univeristy
         employment.postgraduate_degree_or_equivalent, # level of education - univeristy
         employment.bachelors_degree_or_equivalent, # level of education - univeristy
         employment.a_levelsas_levels_or_equivalent, # level of education - alevel
         employment.o_levelsgcses_or_equivalent, # level of education - gcse
         employment.cses_or_equivalent, # level of education - cse
         employment.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
         employment.government_work_key_workers # key worker status
         ) %>%
  add_numeric(., exclude = exclude_cols_employment_edgi) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(edgi.employment.raw.id)
# Inspect colnames
colnames(edgi.employment.raw.id)
#Differences
dim(edgi.employment.raw)[1]-dim(edgi.employment.raw.id)[1]
}
```

```{r edgi copy employment}
if(EDGI == TRUE){
  employment.raw.id <- edgi.employment.raw.id
}
```

## NBR
### Read in data
```{r nbr employment cols}
if(NBR == TRUE){
nbr.employment.raw <- readRDS(file = paste0(data.raw_path, "/nbr/employment_coping_nbr.rds"))
dim(nbr.employment.raw)
colnames(nbr.employment.raw)
}
```

### Select variables
```{r nbr employment cleaning}
if(NBR == TRUE){
exclude_cols_employment <- c("ID",
                  "Sample")

nbr.employment.raw.id <- nbr.employment.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(
    ID = as.numeric(ID)) %>%
  select(
         Sample, # Sample
         ID, # ID
         employment.phd, # level of education - univeristy
         employment.masters_degree_or_equivalent, # level of education - univeristy
         employment.postgraduate_degree_or_equivalent, # level of education - univeristy
         employment.bachelors_degree_or_equivalent, # level of education - univeristy
         employment.a_levelsas_levels_or_equivalent, # level of education - alevel
         employment.o_levelsgcses_or_equivalent, # level of education - gcse
         employment.cses_or_equivalent, # level of education - cse
         employment.nvq_or_hnd_or_hnc_or_equivalent, # level of education - nvq
         employment.government_work_key_workers # key worker status
         ) %>%
  add_numeric(., exclude = exclude_cols_employment) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(nbr.employment.raw.id)
# Inspect colnames
colnames(nbr.employment.raw.id)
#Differences
dim(nbr.employment.raw)[1]-dim(nbr.employment.raw.id)[1]
head(nbr.employment.raw.id
     )
}
```

```{r nbr copy employment}
if(NBR == TRUE){
  employment.raw.id <- nbr.employment.raw.id
}
```

## RAMP
### Read in data
```{r ramp employment cols}
if(RAMP == TRUE){
ramp.employment.raw <- readRDS(file = paste0(data.raw_path, "/ramp/employment_ramp.rds"))
dim(ramp.employment.raw)
colnames(ramp.employment.raw)
}
```

### Select variables
```{r ramp employment cleaning}
if(RAMP == TRUE){
exclude_cols_employment <- c("ID",
                  "Sample")

ramp.employment.raw.id <- ramp.employment.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(
    ID = as.numeric(ID)
    ) %>%
  select(
         Sample, # Sample
         ID, # ID
         employment.what_is_your_highest_level_of_education, #highest level of edcuation
         employment.government_work_key_workers # key worker status
         ) %>%
  add_numeric(., exclude = exclude_cols_employment) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ramp.employment.raw.id)
# Inspect colnames
colnames(ramp.employment.raw.id)
#Differences
dim(ramp.employment.raw)[1]-dim(ramp.employment.raw.id)[1]
}
```

```{r ramp copy employment}
if(RAMP == TRUE){
  employment.raw.id <- ramp.employment.raw.id
}
```

## Highest education (baseline, GLAD, EDGI, NBR)
Proceed along qualifications fields. If field is not blank, take that as highest qual. If field is blank, check next field. If all fields are blank, NA
Assumes University degree > A level > NVQ > GCSE/O Level/CSE
```{r Highest education baseline}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE) {
#create numeric version of the highest education variable
employment.raw.id <- employment.raw.id %>%
  mutate(
    highest_education_numeric =
      case_when(
        employment.phd_numeric == "1" ~ 4,
        employment.masters_degree_or_equivalent_numeric == "1" ~ 4,
        employment.postgraduate_degree_or_equivalent_numeric == "1" ~ 4,
        employment.bachelors_degree_or_equivalent_numeric == "1" ~ 4,
        employment.a_levelsas_levels_or_equivalent_numeric == "1" ~ 3,
        employment.nvq_or_hnd_or_hnc_or_equivalent_numeric == "1" ~ 2,
        employment.o_levelsgcses_or_equivalent_numeric == "1" ~ 1,
        employment.cses_or_equivalent_numeric == "1" ~ 1
      )
    )

#recode the numeric version into a factor
employment.raw.id <- employment.raw.id %>%
  mutate(
    highest_education =
      recode_factor(
        highest_education_numeric,
        `1` = "GCSE/CSE",
        `2` = "NVQ",
        `3` = "A-levels",
        `4` = "University")
    )

employment.raw.id %>%
  freq(highest_education)
}
```

Check highest education coding
```{r Highest education check}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE) {
employment.raw.id %>%
  select(highest_education,
         highest_education_numeric,
         employment.phd_numeric,
         employment.masters_degree_or_equivalent_numeric,
         employment.postgraduate_degree_or_equivalent_numeric,
         employment.bachelors_degree_or_equivalent_numeric,
         employment.a_levelsas_levels_or_equivalent_numeric,
         employment.nvq_or_hnd_or_hnc_or_equivalent_numeric,
         employment.o_levelsgcses_or_equivalent_numeric,
         employment.cses_or_equivalent_numeric
  )
}
```

## Highest education (baseline, RAMP)
```{r highest level of education for ramp}
if(RAMP == TRUE) {
#create numeric version of the highest education variable
employment.raw.id <- employment.raw.id %>%
  mutate(
    highest_education_numeric =
      case_when(
        employment.what_is_your_highest_level_of_education == "PhD" ~ 4,
        employment.what_is_your_highest_level_of_education == "Postgraduate degree or equivalent" ~ 4,
        employment.what_is_your_highest_level_of_education == "Master's degree or equivalent" ~ 4,
        employment.what_is_your_highest_level_of_education == "Bachelor's degree or equivalent" ~ 4,
        employment.what_is_your_highest_level_of_education == "A-level or equivalent" ~ 3,
        employment.what_is_your_highest_level_of_education == "GCSE or equivalent" ~ 1,
        employment.what_is_your_highest_level_of_education == "None of these" ~ 5
      )
    )

#recode the numeric version into a factor
employment.raw.id <- employment.raw.id %>%
  mutate(
    highest_education =
      recode_factor(
        highest_education_numeric,
        `1` = "GCSE/CSE",
        `2` = NA_character_,
        `3` = "A-levels",
        `4` = "University",
        `5` = NA_character_)
    )

employment.raw.id %>%
  freq(highest_education)
}
```

Check highest education coding for RAMP
```{r Highest education check for RAMP}
if(RAMP == TRUE) {
employment.raw.id %>%
  select(highest_education,
         highest_education_numeric,
         employment.what_is_your_highest_level_of_education,
         employment.what_is_your_highest_level_of_education_numeric
  )
}
```


## Key worker status
```{r Key worker}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
#create numeric version of the variable
employment.raw.id <- employment.raw.id %>%
  mutate(
    key_worker_numeric =
      case_when(
        employment.government_work_key_workers_numeric == "0" ~ 0,
        employment.government_work_key_workers_numeric > 0 ~ 1
      )
    )

#recode the numeric version into a factor
employment.raw.id <- employment.raw.id %>%
  mutate(
    key_worker =
      recode_factor(
        key_worker_numeric,
        `0` = "No key worker",
        `1` = "Key worker"
        )
    )

employment.raw.id %>%
  freq(key_worker)
}
```

# Columns to exclude from add_numeric

```{r cols to exclude}
exclude_cols <- c("Sample",
                  "ID")
```

# mhd

## GLAD
```{r glad mhd cols}
if(GLAD == TRUE) {
glad.mhd.raw <- readRDS(file = paste0(data.raw_path,"/glad/mhd_glad.rds"))
dim(glad.mhd.raw)
colnames(glad.mhd.raw)
}
```

```{r glad mhd cleaning}
if(GLAD == TRUE) {
glad.mhd.raw.id <- glad.mhd.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    starts_with("mhd."),
    mhd.bingeeating_disorder = mhd.psychological_overeating_or_bingeeating
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.mhd.raw.id)
# Inspect colnames
colnames(glad.mhd.raw.id)
#Differences
dim(glad.mhd.raw)[1]-dim(glad.mhd.raw.id)[1]
}
```

```{r glad mhd copy}
if(GLAD == TRUE) {
  mhd.raw.id <- glad.mhd.raw.id
}
```

## EDGI
```{r edgi mhd cols}
if(EDGI == TRUE) {
edgi.mhd.raw <- readRDS(file = paste0(data.raw_path,"/edgi/mhd_edgi.rds"))
dim(edgi.mhd.raw)
colnames(edgi.mhd.raw)
}
```

```{r edgi mhd cleaning}
if(EDGI == TRUE) {
  exclude_cols <- c("Sample",
                  "ID")
  
edgi.mhd.raw.id <- edgi.mhd.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    mhd.anorexia_nervosa,
    mhd.atypical_anorexia_nervosa,
    mhd.bulimia_nervosa,
    mhd.atypical_bulimia_nervosa,
    mhd.bingeeating_disorder,
    mhd.atypical_bingeeating_disorder,
    mhd.ed_none_of_the_above = mhd.none_of_the_above
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(edgi.mhd.raw.id)
# Inspect colnames
colnames(edgi.mhd.raw.id)
#Differences
dim(edgi.mhd.raw)[1]-dim(edgi.mhd.raw.id)[1]
}
```

```{r edgi mhd2 cols}
if(EDGI == TRUE) {
edgi.mhd2.raw <- readRDS(file = paste0(data.raw_path,"/edgi/dem_edgi.rds"))
dim(edgi.mhd2.raw)
colnames(edgi.mhd2.raw)
}
```

```{r edgi mhd2 cleaning}
if(EDGI == TRUE){
  exclude_cols_mhd2 <- c("ID",
                        "Sample",
                        "startDate.prepandemic",
                        "Age_uncleaned",
                        "EduYrs")
  
  edgi.mhd2.raw.id <- edgi.mhd2.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
    mhd.depression = demographics.depression,
    mhd.pregnancy_depression = demographics.pregnancy_depression,
    mhd.premenstrual_dysphoric_disorder_pmdd = demographics.premenstrual_dysphoric_disorder_pmdd,
    mhd.anxiety_nerves_or_generalised_anxiety_disorder = demographics.anxiety_nerves_or_generalised_anxiety_disorder,
    mhd.social_anxiety_or_social_phobia = demographics.social_anxiety_or_social_phobia,
    mhd.specific_phobia_e.g._phobia_of_flying = demographics.specific_phobia_e.g._fear_of_flying, # fear instead of phobia
    mhd.agoraphobia = demographics.agoraphobia,
    mhd.panic_disorder = demographics.panic_disorder,
    mhd.panic_attacks = demographics.panic_attacks,
    mhd.obsessivecompulsive_disorder_ocd = demographics.obsessivecompulsive_disorder_ocd,
    mhd.obsessive_compulsive_related_disorders = demographics.obsessive_compulsive_related_disorders,
    mhd.body_dysmorphic_disorder_bdd = demographics.body_dysmorphic_disorder,
    mhd.mania_hypomania_bipolar_or_manicdepression = demographics.mania_hypomania_bipolar_or_manicdepression,
    mhd.schizophrenia = demographics.schizophrenia,
    mhd.type_psychosis_psychotic_illness = demographics.psychosis_type_psychotic_illness, # word type psychosis changed order compared to GLAD 
    mhd.personality_disorder_diagnosed = demographics.diagnosed_personality_disorder, # named differently in EDGI
    mhd.posttraumatic_stress_disorder_ptsd = demographics.posttraumatic_stress_disorder_ptsd,
    mhd.autism_aspergers_or_autistic_spectrum_disorder = demographics.autism_spectrum_disorder_asd, # different name in EDGI
    mhd.body_dysmorphic_disorder_bdd = demographics.body_dysmorphic_disorder,
    mhd.personality_disorder = demographics.personality_disorder, # routing variable in EDGI is named differently; renamed here to match GLAD
    mhd.attention_deficit_hyperactivity_disorder = demographics.attention_deficit_hyperactivity_disorder,
    mhd.none_of_the_above = demographics.none_of_the_above.1,
    mhd.none_of_the_above.1 = demographics.none_of_the_above.8
    ) %>%
    add_column(
      mhd.schizoaffective_disorder = NA_character_
    ) %>%
    add_numeric(., exclude = exclude_cols_mhd2) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(edgi.mhd2.raw.id)
  # Inspect colnames
  colnames(edgi.mhd2.raw.id)
  #Differences
  dim(edgi.mhd2.raw)[1]-dim(edgi.mhd2.raw.id)[1]
}
```

```{r edgi combine mhd copy}
if(EDGI == TRUE){
mhd.raw.id <- left_join(
  x = edgi.mhd.raw.id,
  y = edgi.mhd2.raw.id,
  by = c("Sample", "ID")
  )

# Inspect dimensions
dim(mhd.raw.id)
# Inspect colnames
colnames(mhd.raw.id)
}
```


## NBR
```{r nbr mhd cols}
if(NBR == TRUE) {
nbr.mhd.raw <- readRDS(file = paste0(data.raw_path,"/nbr/mhd_nbr.rds"))
dim(nbr.mhd.raw)
colnames(nbr.mhd.raw)
}
```


```{r nbr mhd cleaning}
if(NBR == TRUE) {
exclude_cols <- c("Sample",
                  "ID")
  
nbr.mhd.raw.id <- nbr.mhd.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(
    ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    starts_with("mhd."),
    mhd.specific_phobia_e.g._phobia_of_flying = mhd.specific_phobia_e.g._fear_of_flying,
    mhd.type_psychosis_psychotic_illness = mhd.psychosis_type_psychotic_illness,
    mhd.autism_aspergers_or_autistic_spectrum_disorder = mhd.autism_spectrum_disorder_asd,
    mhd.anorexia_nervosa_unc = mhd.anorexia_nervosa,
    mhd.atypical_anorexia_nervosa_unc = mhd.atypical_anorexia_nervosa,
    mhd.bulimia_nervosa_unc = mhd.bulimia_nervosa,
    mhd.bingeeating_disorder_unc = mhd.bingeeating_disorder,
    mhd.ed_none_of_the_above = mhd.none_of_the_above.2
  ) %>%
  add_column(
    mhd.schizoaffective_disorder = NA #NBR doesn't ask about schizoaffective disorder. This means the column das not exist in the data set
  ) %>% 
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(nbr.mhd.raw.id)
# Inspect colnames
colnames(nbr.mhd.raw.id)
#Differences
dim(nbr.mhd.raw)[1]-dim(nbr.mhd.raw.id)[1]
}
```

```{r nbr mhd copy}
if(NBR == TRUE) {
  mhd.raw.id <- nbr.mhd.raw.id
}
```


## RAMP
```{r ramp mhd cols}
if(RAMP == TRUE) {
ramp.mhd.raw <- readRDS(file = paste0(data.raw_path,"/ramp/mhd_ramp.rds"))
dim(ramp.mhd.raw)
colnames(ramp.mhd.raw)
}
```

```{r ramp mhd cleaning}
if(RAMP == TRUE) {
exclude_cols <- c("Sample",
                  "ID")
  
ramp.mhd.raw.id <- ramp.mhd.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  separate(ID, into = "ID", sep = 7) %>%
  mutate(
    ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    mhd.depression = NA.30.depression,
    mhd.pregnancy_depression = NA.30.pregnancy_depression,
    mhd.premenstrual_dysphoric_disorder_pmdd = NA.30.premenstrual_dysphoric_disorder_pmdd,
    mhd.mania_hypomania_bipolar_or_manicdepression = NA.30.mania_hypomania_bipolar_or_manicdepression,
    mhd.anxiety_nerves_or_generalised_anxiety_disorder = NA.30.anxiety_nerves_or_generalised_anxiety_disorder,
    mhd.social_anxiety_or_social_phobia = NA.30.social_anxiety_or_social_phobia,
    mhd.specific_phobia_e.g._phobia_of_flying = NA.30.specific_phobia_e.g._phobia_of_flying,
    mhd.agoraphobia = NA.30.agoraphobia,
    mhd.panic_disorder = NA.30.panic_disorder,
    mhd.panic_attacks = NA.30.panic_attacks,
    mhd.posttraumatic_stress_disorder_ptsd = NA.30.posttraumatic_stress_disorder_ptsd,
    mhd.obsessivecompulsive_disorder_ocd = NA.30.obsessivecompulsive_disorder_ocd, 
    mhd.body_dysmorphic_disorder_bdd = NA.30.body_dysmorphic_disorder_bdd,
    mhd.skin_picking_obsessive_compulsive = NA.30.skin_picking_obsessive_compulsive,
    mhd.anorexia_nervosa = NA.30.anorexia_nervosa,
    mhd.atypical_anorexia_nervosa = NA.30.atypical_anorexia_nervosa,
    mhd.bulimia_nervosa = NA.30.bulimia_nervosa,
    mhd.bingeeating_disorder = NA.30.psychological_overeating_or_bingeeating_disorder,
    mhd.schizophrenia = NA.30.schizophrenia,
    mhd.schizoaffective_disorder = NA.30.schizoaffective_disorder,
    mhd.type_psychosis_psychotic_illness = NA.30.psychosis_type_psychotic_illness,
    mhd.personality_disorder = NA.30.personality_disorder,
    mhd.autism_aspergers_or_autistic_spectrum_disorder = NA.30.autism_aspergers_or_autistic_spectrum_disorder,
    mhd.attention_deficit_hyperactivity_disorder = NA.30.attention_deficit_hyperactivity_disorder,
    mhd.personality_disorder_diagnosed = NA.30.personality_disorder_diagnosed,
    mhd.none_of_the_above = NA.30.none_of_these,
    mhd.dont_know = NA.30.dont_know,
    mhd.prefer_not_to_answer = NA.30.prefer_not_to_answer,
    mhd.none_of_the_above.1 = NA.30.none_of_these.1,
    mhd.dont_know.1 = NA.30.dont_know.1,
    mhd.prefer_not_to_answer.1 = NA.30.prefer_not_to_answer.1,
    mhd.other_please_tell_us_more = NA.30.other_please_tell_us_more
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ramp.mhd.raw.id)
# Inspect colnames
colnames(ramp.mhd.raw.id)
#Differences
dim(ramp.mhd.raw)[1]-dim(ramp.mhd.raw.id)[1]
}
```

```{r ramp mhd copy}
if(RAMP == TRUE) {
  mhd.raw.id <- ramp.mhd.raw.id
}
```

## Grouping mental health disorders
*#Disorder groupings - from COPING/RAMP analysis minutes*
1. Depressive disorder group: major depression, antenatal/postnatal depression, premenstrual depression. The logic for this has been double checked for males - KT/MD. 
2. Anxiety group: generalised anxiety, social anxiety, specific phobia, agoraphobia, panic_disorder, panic_attacks. 
3. Agoraphobia and panic_disorder group: panic_disorder, agoraphobia, panic_attacks.
4. Eating disorders group: anorexianervosa, atypical anorexia nervosa, bulimia nervosa, overeating or bingeeating.
5. Obsessive complusive disorders: obsessive compulaive disorder, obsessive compulsive related disorders. 
6. Psychotic disorders: schizophrenia, schizoaffective disorder, general psychosis or psychotic illness. 
7. Personality disorders: cluster A, cluster B, cluster C
8. Control group: no diagnosed disorders. 

*Disorders of interest*
MDD and other depressive disorders
Anxiety, nerves or generalised anxiety disorder
Social anxiety 
Specific phobia 
Agoraphobia/panic disorder/panic attacks
OCD (& OCD-related disorders e.g., skin picking?)
PTSD 
Bipolar 
Eating disorders (Anorexia, BE-type EDs) 
Personality disorder: Clusters A, B, and C 
No-diagnosis group

*Analysis plan of Disorders: KY and KP analysis plan*
1. Basic: any anxiety or unipolar depressive disorder vs. those with no prior diagnosis
2. Specific: breakdown by type of prior anxiety (& related) disorder diagnosis
3. Breakdown by COVID or not (using COVIDENCE/Zoe algorithm)

### Depressive disorders
```{r mhd depressive_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE)
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    depressive_disorders_numeric =
      case_when(
        (mhd.depression_numeric == "0" &
        (mhd.pregnancy_depression_numeric == "0" | is.na(mhd.pregnancy_depression_numeric)) & 
        (mhd.premenstrual_dysphoric_disorder_pmdd_numeric == "0" | is.na(mhd.premenstrual_dysphoric_disorder_pmdd_numeric))) ~ 0,
        mhd.depression_numeric == "1" ~ 1,
        mhd.pregnancy_depression_numeric == "1" ~ 1,
        mhd.premenstrual_dysphoric_disorder_pmdd_numeric == "1" ~ 1))

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    depressive_disorders =
      recode_factor(depressive_disorders_numeric,
                    "0" = "No depressive disorder",
                    "1" = "Depressive disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(depressive_disorders,
       cumul = F)
```

```{r Check depressive_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    depressive_disorders,
    depressive_disorders_numeric,
    mhd.depression_numeric,
    mhd.pregnancy_depression_numeric,
    mhd.premenstrual_dysphoric_disorder_pmdd_numeric,
    mhd.depression,
    mhd.pregnancy_depression,
    mhd.premenstrual_dysphoric_disorder_pmdd
  )
}
```

### Anxiety disorders
```{r mhd anxiety_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    anxiety_disorders_numeric =
      case_when(
        mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric == "1" ~ 1,
        mhd.social_anxiety_or_social_phobia_numeric == "1" ~ 1,
        mhd.specific_phobia_e.g._phobia_of_flying_numeric == "1" ~ 1,
        mhd.agoraphobia_numeric == "1" ~ 1,
        mhd.panic_disorder_numeric == "1" ~ 1,
        mhd.panic_attacks_numeric == "1" ~ 1,
        (mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric == "0" &
        mhd.social_anxiety_or_social_phobia_numeric == "0" &
        mhd.specific_phobia_e.g._phobia_of_flying_numeric == "0" &
        mhd.agoraphobia_numeric == "0" &
        mhd.panic_disorder_numeric == "0" &
        mhd.panic_attacks_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    anxiety_disorders =
      recode_factor(anxiety_disorders_numeric,
                    "0" = "No anxiety disorder",
                    "1" = "Anxiety disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(anxiety_disorders,
       cumul = F)
}
```

```{r Check anxiety_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    anxiety_disorders,
    anxiety_disorders_numeric,
    mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric,
    mhd.social_anxiety_or_social_phobia_numeric,
    mhd.specific_phobia_e.g._phobia_of_flying_numeric,
    mhd.agoraphobia_numeric,
    mhd.panic_disorder_numeric,
    mhd.panic_attacks_numeric,
    mhd.anxiety_nerves_or_generalised_anxiety_disorder,
    mhd.social_anxiety_or_social_phobia,
    mhd.specific_phobia_e.g._phobia_of_flying,
    mhd.agoraphobia,
    mhd.panic_disorder,
    mhd.panic_attacks
  )
}
```

Agoraphobia and panic disorder group
```{r mhd agoraphobia_panic_disorder}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    agoraphobia_panic_disorder_numeric =
      case_when(
        mhd.agoraphobia_numeric == "1" ~ 1,
        mhd.panic_disorder_numeric == "1" ~ 1,
        mhd.panic_attacks_numeric == "1" ~ 1,
        (mhd.agoraphobia_numeric == "0" &
        mhd.panic_disorder_numeric == "0" &
        mhd.panic_attacks_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    agoraphobia_panic_disorder =
      recode_factor(agoraphobia_panic_disorder_numeric,
                    "0" = "No agoraphobia/panic disorder",
                    "1" = "Agoraphobia/panic disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(agoraphobia_panic_disorder)
}
```

```{r Check agoraphobia_panic_disorder}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    agoraphobia_panic_disorder,
    agoraphobia_panic_disorder_numeric,
    mhd.agoraphobia_numeric,
    mhd.panic_disorder_numeric,
    mhd.panic_attacks_numeric,
    mhd.agoraphobia,
    mhd.panic_disorder,
    mhd.panic_attacks
  )
}
```

Depression and anxiety comorbidity
```{r mhd depression_anxiety}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    depression_and_anxiety_numeric =
      case_when(
        depressive_disorders_numeric == 0 &
          anxiety_disorders_numeric == 0 ~ 0,
        depressive_disorders_numeric == 1 &
          anxiety_disorders_numeric == 1 ~ 1,
        depressive_disorders_numeric == 1 &
          anxiety_disorders_numeric == 0 ~ 2,
        depressive_disorders_numeric == 0 &
          anxiety_disorders_numeric == 1 ~ 3
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    depression_and_anxiety =
      recode_factor(depression_and_anxiety_numeric,
                    "0" = "No depressive or anxiety disorder",
                    "1" = "Depressive and anxiety disorder",
                    "2" = "Only depressive disorder",
                    "3" = "Only anxiety disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(depression_and_anxiety,
       cumul = F)
}
```

### Eating disorders

There is routing questionnaire if participants have been diagnosed with an eating disorder and afterwards they get asked the specific disorders. Therefore, mhd.suspected_eating_disorder_diagnosed_numeric needs to be recoded as 0 otherwise they would be NAs.
```{r nbr cleaning eating disorders}
if(NBR == TRUE) {
#Recode as 0 if ppt responds no to screening question (mhd.suspected_eating_disorder_diagnosed_numeric)
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    mhd.anorexia_nervosa_numeric =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ 0,
                mhd.anorexia_nervosa_unc_numeric == "0" ~ 0,
                mhd.anorexia_nervosa_unc_numeric == "1" ~ 1),
    mhd.atypical_anorexia_nervosa_numeric =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ 0,
                mhd.atypical_anorexia_nervosa_unc_numeric == "0" ~ 0,
                mhd.atypical_anorexia_nervosa_unc_numeric == "1" ~ 1),
    mhd.bulimia_nervosa_numeric =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ 0,
                mhd.bulimia_nervosa_unc_numeric == "0" ~ 0,
                mhd.bulimia_nervosa_unc_numeric == "1" ~ 1),
    mhd.bingeeating_disorder_numeric =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ 0,
                mhd.bingeeating_disorder_unc_numeric == "0" ~ 0,
                mhd.bingeeating_disorder_unc_numeric == "1" ~ 1),
    mhd.anorexia_nervosa =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ "Not Anorexia nervosa",
                mhd.anorexia_nervosa_unc_numeric == "0" ~ "Not Anorexia nervosa",
                mhd.anorexia_nervosa_unc_numeric == "1" ~ "Anorexia nervosa"),
    mhd.atypical_anorexia_nervosa =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ "Not Atypical anorexia nervosa",
                mhd.atypical_anorexia_nervosa_unc_numeric == "0" ~ "Not Atypical anorexia nervosa",
                mhd.atypical_anorexia_nervosa_unc_numeric == "1" ~ "Atypical anorexia nervosa"),
    mhd.bulimia_nervosa =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ "Not Bulimia nervosa",
                mhd.bulimia_nervosa_unc_numeric == "0" ~ "Not Bulimia nervosa",
                mhd.bulimia_nervosa_unc_numeric == "1" ~ "Bulimia nervosa"),
    mhd.bingeeating_disorder =
      case_when(mhd.suspected_eating_disorder_diagnosed_numeric == "0" ~ "Not Binge-eating disorder",
                mhd.bingeeating_disorder_unc_numeric == "0" ~ "Not Binge-eating disorder",
                mhd.bingeeating_disorder_unc_numeric == "1" ~ "Binge-eating disorder")
    )
}

```

```{r mhd eating_disorders}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    eating_disorders_numeric =
      case_when(
        mhd.anorexia_nervosa_numeric == "1" ~ 1,
        mhd.atypical_anorexia_nervosa_numeric == "1" ~ 1,
        mhd.bulimia_nervosa_numeric == "1" ~ 1,
        mhd.bingeeating_disorder_numeric == "1" ~ 1,
        (mhd.anorexia_nervosa_numeric == "0" &
        mhd.atypical_anorexia_nervosa_numeric == "0" &
        mhd.bulimia_nervosa_numeric == "0" &
        mhd.bingeeating_disorder_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    eating_disorders =
      recode_factor(eating_disorders_numeric,
                    "0" = "No eating disorder",
                    "1" = "Eating disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(eating_disorders,
       cumul = F)
}
```

For EDGI does not include other eating disorders, such as purging disorder, rumination disorder, ARFID, or Pica
```{r edgi mhd eating_disorders}
if(EDGI == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    eating_disorders_numeric =
      case_when(
        mhd.anorexia_nervosa_numeric == "1" ~ 1,
        mhd.atypical_anorexia_nervosa_numeric == "1" ~ 1,
        mhd.bulimia_nervosa_numeric == "1" ~ 1,
        mhd.atypical_bulimia_nervosa_numeric == "1" ~ 1, # additional diagnosis in EDGI but not in GLAD
        mhd.bingeeating_disorder_numeric == "1" ~ 1,
        mhd.atypical_bingeeating_disorder_numeric == "1" ~ 1, # additional diagnosis in EDGI
        (mhd.anorexia_nervosa_numeric == "0" &
        mhd.atypical_anorexia_nervosa_numeric == "0" &
          mhd.atypical_anorexia_nervosa_numeric == "0" &
        mhd.bulimia_nervosa_numeric == "0" &
          mhd.atypical_bulimia_nervosa_numeric == "0" &
        mhd.bingeeating_disorder_numeric == "0" &
          mhd.atypical_bingeeating_disorder_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    eating_disorders =
      recode_factor(eating_disorders_numeric,
                    "0" = "No eating disorder",
                    "1" = "Eating disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(eating_disorders,
       cumul = F)
}
```


Eating disorders with binge eating vs eating disorders without
Caveat: Anorexia nervosa can have binge eating as well. Therefore, this would need an additional variable from the ED100K
```{r mhd restricting_vs_binge_eating_eating_disorders}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    restricting_vs_binge_eating_eating_disorders_numeric =
      case_when(
        mhd.anorexia_nervosa_numeric == "1" ~ 1,
        mhd.atypical_anorexia_nervosa_numeric == "1" ~ 1,
        mhd.bulimia_nervosa_numeric == "1" ~ 2,
        mhd.bingeeating_disorder_numeric == "1" ~ 2,
        (mhd.anorexia_nervosa_numeric == "0" &
        mhd.atypical_anorexia_nervosa_numeric == "0" &
        mhd.bulimia_nervosa_numeric == "0" &
        mhd.bingeeating_disorder_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    restricting_vs_binge_eating_eating_disorders =
      recode_factor(restricting_vs_binge_eating_eating_disorders_numeric,
                    "0" = "No eating disorder",
                    "1" = "Anorexia nervosa",
                    "2" = "Eating disorder with binge eating",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(restricting_vs_binge_eating_eating_disorders,
       cumul = F)
}
```

```{r mhd restricting_vs_binge_eating_eating_disorders}
if(EDGI == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    restricting_vs_binge_eating_eating_disorders_numeric =
      case_when(
        mhd.anorexia_nervosa_numeric == "1" ~ 1,
        mhd.atypical_anorexia_nervosa_numeric == "1" ~ 1,
        mhd.bulimia_nervosa_numeric == "1" ~ 2,
        mhd.atypical_bulimia_nervosa_numeric == "1" ~ 2, # additional diagnosis in EDGI but not in GLAD
        mhd.bingeeating_disorder_numeric == "1" ~ 2,
        mhd.atypical_bingeeating_disorder_numeric == "1" ~ 2, # additional diagnosis in EDGI
        (mhd.anorexia_nervosa_numeric == "0" &
        mhd.atypical_anorexia_nervosa_numeric == "0" &
          mhd.atypical_anorexia_nervosa_numeric == "0" &
        mhd.bulimia_nervosa_numeric == "0" &
          mhd.atypical_bulimia_nervosa_numeric == "0" &
        mhd.bingeeating_disorder_numeric == "0" &
          mhd.atypical_bingeeating_disorder_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    restricting_vs_binge_eating_eating_disorders =
      recode_factor(restricting_vs_binge_eating_eating_disorders_numeric,
                    "0" = "No eating disorder",
                    "1" = "Anorexia nervosa",
                    "2" = "Eating disorder with binge eating",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(restricting_vs_binge_eating_eating_disorders,
       cumul = F)
}
```

```{r Check eating_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    eating_disorders,
    eating_disorders_numeric,
    restricting_vs_binge_eating_eating_disorders,
    restricting_vs_binge_eating_eating_disorders_numeric,
    mhd.anorexia_nervosa_numeric,
    mhd.atypical_anorexia_nervosa_numeric,
    mhd.bulimia_nervosa_numeric,
    mhd.bingeeating_disorder_numeric,
    mhd.anorexia_nervosa,
    mhd.atypical_anorexia_nervosa,
    mhd.bulimia_nervosa,
    mhd.bingeeating_disorder
  )
}
```

```{r Check eating_disorders}
if(EDGI == TRUE) {
mhd.raw.id %>%
  select(
    eating_disorders,
    eating_disorders_numeric,
    restricting_vs_binge_eating_eating_disorders,
    restricting_vs_binge_eating_eating_disorders_numeric,
    mhd.anorexia_nervosa_numeric,
    mhd.atypical_anorexia_nervosa_numeric,
    mhd.bulimia_nervosa_numeric,
    mhd.bingeeating_disorder_numeric,
    mhd.anorexia_nervosa,
    mhd.atypical_anorexia_nervosa,
    mhd.bulimia_nervosa,
    mhd.atypical_bulimia_nervosa,
    mhd.bingeeating_disorder,
    mhd.atypical_bingeeating_disorder
  )
}
```

### Obsessive compulsive disorders
```{r mhd obsessive_compulsive_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    obsessive_compulsive_disorders_numeric =
      case_when(
        mhd.obsessivecompulsive_disorder_ocd_numeric == "1" ~ 1,
        mhd.obsessive_compulsive_related_disorders_numeric == "1" ~ 1,
        mhd.body_dysmorphic_disorder_bdd_numeric == "1" ~ 1,
        (mhd.obsessivecompulsive_disorder_ocd_numeric == "0" &
        mhd.obsessive_compulsive_related_disorders_numeric == "0" &
        mhd.body_dysmorphic_disorder_bdd_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    obsessive_compulsive_disorders =
      recode_factor(obsessive_compulsive_disorders_numeric,
                    "0" = "No obsessive compulsive disorder",
                    "1" = "Obsessive compulsive disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(obsessive_compulsive_disorders)
}
```

```{r mhd obsessive_compulsive_disorders for ramp}
if(RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    obsessive_compulsive_disorders_numeric =
      case_when(
        mhd.obsessivecompulsive_disorder_ocd_numeric == "1" ~ 1,
        mhd.skin_picking_obsessive_compulsive_numeric == "1" ~ 1,
        mhd.body_dysmorphic_disorder_bdd_numeric == "1" ~ 1,
        (mhd.obsessivecompulsive_disorder_ocd_numeric == "0" &
        mhd.skin_picking_obsessive_compulsive_numeric == "0" &
        mhd.body_dysmorphic_disorder_bdd_numeric == "0") ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    obsessive_compulsive_disorders =
      recode_factor(obsessive_compulsive_disorders_numeric,
                    "0" = "No obsessive compulsive disorder",
                    "1" = "Obsessive compulsive disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(obsessive_compulsive_disorders)
}
```

```{r Check obsessive_compulsive_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE) {
mhd.raw.id %>%
  select(
    obsessive_compulsive_disorders,
    obsessive_compulsive_disorders_numeric,
    mhd.obsessivecompulsive_disorder_ocd,
    mhd.obsessivecompulsive_disorder_ocd_numeric,
    mhd.obsessive_compulsive_related_disorders,
    mhd.obsessive_compulsive_related_disorders_numeric,
    mhd.body_dysmorphic_disorder_bdd,
    mhd.body_dysmorphic_disorder_bdd_numeric
  )
}
```

```{r Check obsessive_compulsive_disorders ramp}
if(RAMP == TRUE) {
mhd.raw.id %>%
  select(
    obsessive_compulsive_disorders,
    obsessive_compulsive_disorders_numeric,
    mhd.obsessivecompulsive_disorder_ocd,
    mhd.obsessivecompulsive_disorder_ocd_numeric,
    mhd.skin_picking_obsessive_compulsive,
    mhd.skin_picking_obsessive_compulsive_numeric,
    mhd.body_dysmorphic_disorder_bdd,
    mhd.body_dysmorphic_disorder_bdd_numeric
  )
}
```

### Psychotic disorders
"mhd.schizophrenia_numeric"                                 
"mhd.schizoaffective_disorder_numeric"                      
"mhd.type_psychosis_psychotic_illness_numeric" 
```{r mhd psychotic_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    psychotic_disorders_numeric =
      case_when(
        mhd.schizophrenia_numeric == "1" ~ 1,
        mhd.schizoaffective_disorder_numeric == "1" ~ 1,
        mhd.type_psychosis_psychotic_illness_numeric == "1" ~ 1,
        (mhd.schizophrenia_numeric == "0" &
        (mhd.schizoaffective_disorder_numeric == "0" | is.na(mhd.schizoaffective_disorder_numeric == "0") & #NA included because some cohorts don't have schizoaffective disorder
        mhd.type_psychosis_psychotic_illness_numeric == "0") ~ 0)
        )
    )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    psychotic_disorders =
      recode_factor(psychotic_disorders_numeric,
                    "0" = "No psychotic disorder",
                    "1" = "Psychotic disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(psychotic_disorders)
}
```


Overlap between self-report schizophrenia and bipolar disorder
+++CH: Check overlap between schizophrenia group and bipolar disorder
++KT: Only 63 with comorbid self-report bipolar disorder and schizophrenia. More likely to have shared symptoms, less likely to have confirmed diagnoses of both. Could be too severe to be in GLAD?
```{r mhd bipolar_and_schizophrenia_numeric}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    bipolar_and_schizophrenia_numeric =
      case_when(
        psychotic_disorders_numeric == 0 &
          mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 0 ~ 0,
        psychotic_disorders_numeric == 1 &
          mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 1,
        psychotic_disorders_numeric == 1 &
          mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 0 ~ 2,
        psychotic_disorders_numeric == 0 &
          mhd.mania_hypomania_bipolar_or_manicdepression_numeric == 1 ~ 3
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    bipolar_and_schizophrenia =
      recode_factor(bipolar_and_schizophrenia_numeric,
                    "0" = "No psychotic or bipolar disorder",
                    "1" = "Psychotic and bipolar disorder",
                    "2" = "Only psychotic disorder",
                    "3" = "Only bipolar disorder",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(bipolar_and_schizophrenia,
       cumul = F)
}
```

```{r Check psychotic_disorders}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    psychotic_disorders,
    psychotic_disorders_numeric,
    bipolar_and_schizophrenia,
    bipolar_and_schizophrenia_numeric,
    mhd.schizophrenia_numeric,
    mhd.schizoaffective_disorder_numeric,
    mhd.mania_hypomania_bipolar_or_manicdepression,
    mhd.mania_hypomania_bipolar_or_manicdepression_numeric,
    mhd.type_psychosis_psychotic_illness_numeric,
    mhd.schizophrenia,
    mhd.schizoaffective_disorder,
    mhd.type_psychosis_psychotic_illness
  )
}
```

### Autism spectrum disorder
```{r mhd autism_spectrum_disorder}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE){
  mhd.raw.id <- mhd.raw.id %>%
    mutate(
      autism_spectrum_disorder_numeric =
        case_when(
          mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric == 0 ~ 0,
          mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric == 1 ~ 1
        )
    )
  
  mhd.raw.id <- mhd.raw.id %>%
    mutate(
      autism_spectrum_disorder =
        recode_factor(
          autism_spectrum_disorder_numeric,
          `0` = "No autism spectrum disorder",
          `1` = "Autism spectrum disorder"
        )
    )
  
  mhd.raw.id %>%
    freq(autism_spectrum_disorder)
}
```

```{r Check autism_spectrum_disorder}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    autism_spectrum_disorder,
    autism_spectrum_disorder_numeric,
    mhd.autism_aspergers_or_autistic_spectrum_disorder,
    mhd.autism_aspergers_or_autistic_spectrum_disorder_numeric
  ) %>%
    filter(autism_spectrum_disorder == "Autism spectrum disorder")
}
```


### Personality disorders
++KT: For all cluster coding chunks - have added other clusters as == 0, so that they are not coerced into NAs. 
Cluster A
1. Paranoid                         28 ( 1.0%)
2. Schizoid                         15 ( 0.5%)
3. Schizotypal                      14 ( 0.5%)
```{r mhd personality_cluster_a}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_a_numeric =
      case_when(
        mhd.personality_disorder_diagnosed_numeric == "1" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "2" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "3" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "4" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "5" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "6" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "7" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "8" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "9" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "10" ~ 0,
        mhd.personality_disorder_numeric == "0" ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_a =
      recode_factor(personality_cluster_a_numeric,
                    "0" = "No personality disorder cluster A",
                    "1" = "Personality disorder cluster A",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(personality_cluster_a,
       cumul = F)
}
```

```{r Check personality_cluster_a}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    personality_cluster_a,
    personality_cluster_a_numeric,
    mhd.personality_disorder_diagnosed,
    mhd.personality_disorder_diagnosed_numeric
  )
}
```

Cluster B
4. Antisocial                       24 ( 0.8%)
5. Borderline                     2553 (89.4%)
6. Histrionic                        7 ( 0.2%)
7. Narcissistic                      8 ( 0.3%)

```{r mhd personality_cluster_b}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_b_numeric =
      case_when(
        mhd.personality_disorder_diagnosed_numeric == "1" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "2" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "3" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "4" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "5" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "6" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "7" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "8" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "9" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "10" ~ 0,
        mhd.personality_disorder_numeric == "0" ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_b =
      recode_factor(personality_cluster_b_numeric,
                    "0" = "No personality disorder cluster B",
                    "1" = "Personality disorder cluster B",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(personality_cluster_b,
       cumul = F)
}
```

```{r Check personality_cluster_b}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    personality_cluster_b,
    personality_cluster_b_numeric,
    mhd.personality_disorder_diagnosed,
    mhd.personality_disorder_diagnosed_numeric
  )
}
```

Cluster C
8. Avoidant/anxious                133 ( 4.7%)
9. Dependent                        29 ( 1.0%)
10. Obsessive-compulsive
```{r glad mhd personality_cluster_c}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_c_numeric =
      case_when(
        mhd.personality_disorder_diagnosed_numeric == "1" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "2" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "3" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "4" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "5" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "6" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "7" ~ 0,
        mhd.personality_disorder_diagnosed_numeric == "8" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "9" ~ 1,
        mhd.personality_disorder_diagnosed_numeric == "10" ~ 1,
        mhd.personality_disorder_numeric == "0" ~ 0
      )
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    personality_cluster_c =
      recode_factor(personality_cluster_c_numeric,
                    "0" = "No personality disorder cluster C",
                    "1" = "Personality disorder cluster C",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(personality_cluster_c,
       cumul = F)
}
```

```{r Check personality_cluster_c}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    personality_cluster_c,
    personality_cluster_c_numeric,
    mhd.personality_disorder_diagnosed,
    mhd.personality_disorder_diagnosed_numeric
  )
}
```

### Controls
These individuals have no self report diagnosis of any kind that we measure. 
```{r mhd control}
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    control_numeric =
      if_else(
    depressive_disorders_numeric == "0" &
    anxiety_disorders_numeric == "0" &
    eating_disorders_numeric == "0" &
    obsessive_compulsive_disorders_numeric == "0" &
    psychotic_disorders_numeric == "0" &
    mhd.mania_hypomania_bipolar_or_manicdepression_numeric == "0" &
    mhd.posttraumatic_stress_disorder_ptsd_numeric == "0" &
    autism_spectrum_disorder_numeric == "0" &
    mhd.attention_deficit_hyperactivity_disorder_numeric == "0" &
    mhd.personality_disorder_numeric == "0" &
      mhd.prefer_not_to_answer_numeric == "0" & # added 31. August 2020
      mhd.prefer_not_to_answer.1_numeric == "0" & # added 31. August 2020
      mhd.dont_know_numeric == "0" & # added 31. August 2020
      mhd.dont_know.1_numeric == "0" & # added 31. August 2020
      mhd.other_please_tell_us_more_numeric == "0",
    true = 1, 
    false = 0, 
    NA_real_)
  )

mhd.raw.id <- mhd.raw.id %>%
  mutate(
    control =
      recode_factor(control_numeric,
                    "0" = "No control",
                    "1" = "Control",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(control,
       cumul = F)
```

```{r mhd check none of the above}
if(RAMP == TRUE) {
mhd.raw.id %>%
  select(
    control,
    mhd.none_of_the_above,
    mhd.none_of_the_above.1
  )

mhd.raw.id %>%
  group_by(control) %>%
  count(
    mhd.none_of_the_above.1,
    mhd.none_of_the_above,
    mhd.other_please_tell_us_more
  )

#mhd.raw.id %>%
#  count(
#    control,
#    age_
#  )
}
```

Inspect the participants that do not qualify as double "None of these"
```{r RAMP none of these comparison}
if(RAMP == TRUE) {
mhd.raw.id %>%
  filter(
    (mhd.none_of_the_above.1 == "Not None of these" |
    mhd.none_of_the_above == "Not None of these") &
      control == "Control"
  ) %>%
    select(
      mhd.none_of_the_above_numeric,
      mhd.dont_know_numeric,
      mhd.prefer_not_to_answer_numeric,
      mhd.none_of_the_above.1_numeric,
      mhd.dont_know.1_numeric,
      mhd.prefer_not_to_answer.1_numeric,
      mhd.other_please_tell_us_more_numeric
      )
}
```


```{r Check control columns}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.id %>%
  select(
    control,
    depressive_disorders_numeric,
    anxiety_disorders_numeric,
    eating_disorders_numeric,
    obsessive_compulsive_disorders_numeric,
    psychotic_disorders_numeric,
    mhd.mania_hypomania_bipolar_or_manicdepression_numeric,
    mhd.posttraumatic_stress_disorder_ptsd_numeric,
    autism_spectrum_disorder_numeric,
    mhd.attention_deficit_hyperactivity_disorder_numeric,
    mhd.personality_disorder_numeric
  )
}
```



## Total disorder count
```{r disorders_total_count}
disorder_columns <- c(
    "depressive_disorders_numeric",
    "anxiety_disorders_numeric",
    "eating_disorders_numeric",
    "obsessive_compulsive_disorders_numeric",
    "psychotic_disorders_numeric",
    "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
    "mhd.posttraumatic_stress_disorder_ptsd_numeric",
    "autism_spectrum_disorder_numeric",
    "mhd.attention_deficit_hyperactivity_disorder_numeric",
    "mhd.personality_disorder_numeric"
)


mhd.raw.id <- mhd.raw.id %>%
  mutate(
    disorders_total_count =
      rowSums(.[disorder_columns])
  )

mhd.raw.id %>%
  freq(disorders_total_count,
       cumul = F)
```

## Comorbidity count
```{r cormorbidity_total_count}
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    comorbidity_total_count_numeric = 
      case_when(
        disorders_total_count == 1 ~ 0,
        disorders_total_count > 1 ~ disorders_total_count - 1
  )
  )

mhd.raw.id %>%
  freq(comorbidity_total_count_numeric,
       cumul = F)
```

```{r comordbitiy_total_count_factor}
mhd.raw.id <- mhd.raw.id %>%
  mutate(
    comorbidity_total_count_factor_numeric =
      case_when(
    comorbidity_total_count_numeric == "0" ~ 0,
    comorbidity_total_count_numeric == "1" ~ 1,
    comorbidity_total_count_numeric == "2" ~ 2,
    comorbidity_total_count_numeric > 2 ~ 3
    )
  )


mhd.raw.id <- mhd.raw.id %>%
  mutate(
    comorbidity_total_count_factor =
      recode_factor(comorbidity_total_count_factor_numeric,
                    "0" = "No comorbidity",
                    "1" = "1 comorbid disoder",
                    "2" = "2 comorbid disoders",
                    "3" = "3+ comorbid disoders",
                    missing = NA_character_
                    )
  )

mhd.raw.id %>%
  freq(comorbidity_total_count_factor,
       cumul = F)
```

## Inspection
```{r glad mhd head}
head(mhd.raw.id)
```

```{r mhd summary}
summarytools::dfSummary(
  mhd.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

Create new dataframe with the derived categories
```{r mhd categories}
if(GLAD == TRUE | NBR == TRUE | RAMP == TRUE) {
mhd.raw.categories <- mhd.raw.id %>%
  select(
    Sample,
    ID,
    anxiety_disorders_numeric,
    anxiety_disorders,
    mhd.specific_phobia_e.g._phobia_of_flying_numeric,
    mhd.specific_phobia_e.g._phobia_of_flying,
    mhd.social_anxiety_or_social_phobia_numeric,
    mhd.social_anxiety_or_social_phobia,
    agoraphobia_panic_disorder_numeric,
    agoraphobia_panic_disorder,
    depressive_disorders_numeric,
    depressive_disorders,
    eating_disorders_numeric,
    eating_disorders,
    obsessive_compulsive_disorders_numeric,
    obsessive_compulsive_disorders,
    psychotic_disorders_numeric,
    psychotic_disorders,
    mhd.mania_hypomania_bipolar_or_manicdepression_numeric,
    mhd.mania_hypomania_bipolar_or_manicdepression,
    mhd.posttraumatic_stress_disorder_ptsd_numeric,
    mhd.posttraumatic_stress_disorder_ptsd,
    autism_spectrum_disorder_numeric,
    autism_spectrum_disorder,
    mhd.attention_deficit_hyperactivity_disorder_numeric,
    mhd.attention_deficit_hyperactivity_disorder,
    mhd.personality_disorder_numeric,
    mhd.personality_disorder,
    personality_cluster_a_numeric,
    personality_cluster_a,
    personality_cluster_b_numeric,
    personality_cluster_b,
    personality_cluster_c_numeric,
    personality_cluster_c,
    depression_and_anxiety_numeric,
    depression_and_anxiety,
    restricting_vs_binge_eating_eating_disorders_numeric,
    restricting_vs_binge_eating_eating_disorders,
    bipolar_and_schizophrenia_numeric,
    bipolar_and_schizophrenia,
    control_numeric,
    control,
    disorders_total_count,
    comorbidity_total_count_numeric,
    comorbidity_total_count_factor_numeric,
    comorbidity_total_count_factor,
    mhd.none_of_the_above,
    mhd.none_of_the_above.1
    )
}
```

```{r mhd categories}
if(EDGI == TRUE) {
mhd.raw.categories <- mhd.raw.id %>%
  select(
    Sample,
    ID,
    anxiety_disorders_numeric,
    anxiety_disorders,
    mhd.specific_phobia_e.g._phobia_of_flying_numeric,
    mhd.specific_phobia_e.g._phobia_of_flying,
    mhd.social_anxiety_or_social_phobia_numeric,
    mhd.social_anxiety_or_social_phobia,
    agoraphobia_panic_disorder_numeric,
    agoraphobia_panic_disorder,
    depressive_disorders_numeric,
    depressive_disorders,
    eating_disorders_numeric,
    eating_disorders,
    obsessive_compulsive_disorders_numeric,
    obsessive_compulsive_disorders,
    psychotic_disorders_numeric,
    psychotic_disorders,
    mhd.mania_hypomania_bipolar_or_manicdepression_numeric,
    mhd.mania_hypomania_bipolar_or_manicdepression,
    mhd.posttraumatic_stress_disorder_ptsd_numeric,
    mhd.posttraumatic_stress_disorder_ptsd,
    autism_spectrum_disorder_numeric,
    autism_spectrum_disorder,
    mhd.attention_deficit_hyperactivity_disorder_numeric,
    mhd.attention_deficit_hyperactivity_disorder,
    mhd.personality_disorder_numeric,
    mhd.personality_disorder,
#    personality_cluster_a_numeric,
#    personality_cluster_a,
#    personality_cluster_b_numeric,
#    personality_cluster_b,
#    personality_cluster_c_numeric,
#    personality_cluster_c,
    depression_and_anxiety_numeric,
    depression_and_anxiety,
    restricting_vs_binge_eating_eating_disorders_numeric,
    restricting_vs_binge_eating_eating_disorders,
    bipolar_and_schizophrenia_numeric,
    bipolar_and_schizophrenia,
    control_numeric,
    control,
    disorders_total_count,
    comorbidity_total_count_numeric,
    comorbidity_total_count_factor_numeric,
    comorbidity_total_count_factor
    ) %>%
  add_column(
    personality_cluster_a_numeric = NA_real_,
    personality_cluster_a = NA_character_,
    personality_cluster_b_numeric = NA_real_,
    personality_cluster_b = NA_character_,
    personality_cluster_c_numeric = NA_real_,
    personality_cluster_c = NA_character_
  )
}
```


# Prepandemic

## GAD (prepan)

```{r glad gad prepan cols}
if(GLAD == TRUE){
glad.gad.raw <- readRDS(file = paste0(data.raw_path, "/glad/gad_glad.rds"))
dim(glad.gad.raw)
colnames(glad.gad.raw)
}
```

```{r glad gad prepan cleaning}
if(GLAD ==TRUE){
exclude_cols <- c("Sample",
                  "ID")
glad.gad.raw.id <- glad.gad.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    gad.feeling_nervous_anxious_or_on_edge_prepan = gad.feeling_nervous_anxious_or_on_edge,
    gad.control_worrying_stop_prepan = gad.control_worrying_stop,
    gad.worrying_too_much_about_different_things_prepan = gad.worrying_too_much_about_different_things,
    gad.trouble_relaxing_prepan = gad.trouble_relaxing,
    gad.sit_restless_hard_prepan = gad.sit_restless_hard,
    gad.becoming_easily_annoyed_or_irritable_prepan = gad.becoming_easily_annoyed_or_irritable,
    gad.awful_feeling_afraid_happen_prepan = gad.awful_feeling_afraid_happen
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.gad.raw.id)
# Inspect colnames
colnames(glad.gad.raw.id)
#Differences
dim(glad.gad.raw)[1]-dim(glad.gad.raw.id)[1]
}
```

```{r glad copy prepan gad}
if(GLAD == TRUE){
prepan.gad.raw.id <- glad.gad.raw.id
}
```

```{r edgi gad prepan cols}
if(EDGI == TRUE){
  edgi.gad.raw <- readRDS(file = paste0(data.raw_path, "/edgi/gad_edgi.rds"))
  dim(edgi.gad.raw)
  colnames(edgi.gad.raw)
}
```

```{r edgi gad prepan cleaning}
if(EDGI == TRUE){
exclude_cols <- c("Sample",
                  "ID")

edgi.gad.raw.id <- edgi.gad.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    gad.feeling_nervous_anxious_or_on_edge_prepan = gad.feeling_nervous_anxious_or_on_edge,
    gad.control_worrying_stop_prepan = gad.control_worrying_stop,
    gad.worrying_too_much_about_different_things_prepan = gad.worrying_too_much_about_different_things,
    gad.trouble_relaxing_prepan = gad.trouble_relaxing,
    gad.sit_restless_hard_prepan = gad.sit_restless_hard,
    gad.becoming_easily_annoyed_or_irritable_prepan = gad.becoming_easily_annoyed_or_irritable,
    gad.awful_feeling_afraid_happen_prepan = gad.awful_feeling_afraid_happen
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(edgi.gad.raw.id)
# Inspect colnames
colnames(edgi.gad.raw.id)
#Differences
dim(edgi.gad.raw)[1]-dim(edgi.gad.raw.id)[1]
}
```

```{r edgi copy prepan gad}
if(EDGI == TRUE){
  prepan.gad.raw.id <- edgi.gad.raw.id
}
```

Calculate sum score for GAD-7
Max should be 21.

*Note that scores with missingness will be changed to NA later in the script
```{r gad sum score prepan raw}
if(GLAD ==TRUE | EDGI == TRUE){
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
gad.items_key_prepan <- c(1,1,1,1,1,1,1)

# Create vector with items that are included in total score
gad.items_prepan <- c(
  "gad.feeling_nervous_anxious_or_on_edge_prepan_numeric",
  "gad.control_worrying_stop_prepan_numeric",
  "gad.worrying_too_much_about_different_things_prepan_numeric",
  "gad.trouble_relaxing_prepan_numeric",
  "gad.sit_restless_hard_prepan_numeric",
  "gad.becoming_easily_annoyed_or_irritable_prepan_numeric",
  "gad.awful_feeling_afraid_happen_prepan_numeric"
  )

# Calculate total score
gad.scored_items_prepan <- scoreItems(keys = gad.items_key_prepan,
                                        items = prepan.gad.raw.id[gad.items_prepan],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 3)
# Add in column to tibble
prepan.gad.raw.id$gad.sum_score_prepan_raw <- gad.scored_items_prepan$scores

# Look at values
prepan.gad.raw.id %>%
  descr(gad.sum_score_prepan_raw,
        stats = "common"
        )
}
```

missingness (NAs per person)

prepandemic
```{r gad prepan missingness}
if(GLAD ==TRUE | EDGI == TRUE){
prepan.gad.raw.id <- prepan.gad.raw.id %>%
  mutate(
    na_per_person_gad_prepan =         # variable for NA per person
      rowSums(                       
        is.na(.[gad.items_prepan])
      )
  )

prepan.gad.raw.id %>%
  freq(na_per_person_gad_prepan,
       cumul = F)
}
```


```{r gad prepan sum score if missigng items set to NA}
if(GLAD ==TRUE | EDGI == TRUE){
prepan.gad.raw.id <- prepan.gad.raw.id %>%
  mutate(
    gad.sum_score_prepan =
      if_else(condition = na_per_person_gad_prepan > 0,
              true = NA_real_,
              false = gad.sum_score_prepan_raw,
              missing = NA_real_
              )
  )

prepan.gad.raw.id %>%
  descr(gad.sum_score_prepan_raw, stats = "common")

prepan.gad.raw.id %>%
  descr(gad.sum_score_prepan, stats = "common")
}
```

```{r glad prepan gad head}
if(GLAD ==TRUE | EDGI == TRUE){
head(prepan.gad.raw.id)
}
```

```{r glad prepan gad summary}
if(GLAD ==TRUE | EDGI == TRUE){
summarytools::dfSummary(
  prepan.gad.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
}
```


## PCL (prepan)

```{r glad prepandemic pcl cols}
if(GLAD == TRUE) {
glad.pcl.raw <- readRDS(file = paste0(data.raw_path,"/glad/pcl_glad.rds"))
dim(glad.pcl.raw)
colnames(glad.pcl.raw)
}
```


```{r glad prepandemic pcl cleaning}
if(GLAD == TRUE) {
exclude_cols <- c("Sample",
                  "ID")
glad.pcl.raw.id <- glad.pcl.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    pcl.stressful_experience_repeated_images_prepan = pcl.stressful_experience_repeated_images,
    pcl.stressful_experience_upset_reminded_prepan = pcl.stressful_experience_upset_reminded,
    pcl.stressful_situation_avoiding_activities_prepan = pcl.stressful_situation_avoiding_activities,
    pcl.cut_people_feeling_distant_prepan = pcl.cut_people_feeling_distant,
    pcl.feeling_irritable_or_having_angry_outbursts_prepan = pcl.feeling_irritable_or_having_angry_outbursts,
    pcl.difficulty_concentrating_prepan = pcl.difficulty_concentrating
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.pcl.raw.id)
# Inspect colnames
colnames(glad.pcl.raw.id)
#Differences
dim(glad.pcl.raw)[1]-dim(glad.pcl.raw.id)[1]
}
```

```{r glad pcl prepan copy}
if(GLAD == TRUE) {
  prepan.pcl.raw.id <- glad.pcl.raw.id
}
```

```{r edgi pcl cols}
if(EDGI == TRUE) {
  edgi.pcl.raw <- readRDS(file = paste0(data.raw_path,"/edgi/pcl_edgi.rds"))
  dim(edgi.pcl.raw)
  colnames(edgi.pcl.raw)
}
```


```{r edgi pcl cleaning}
if(EDGI == TRUE) {
  edgi.pcl.raw.id <- edgi.pcl.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
      pcl.stressful_experience_repeated_images_prepan = pcl.stressful_experience_repeated_images,
      pcl.stressful_experience_upset_reminded_prepan = pcl.stressful_experience_upset_reminded,
      pcl.stressful_situation_avoiding_activities_prepan = pcl.stressful_situation_situations_reminded, # different to glad: pcl.stressful_situation_avoiding_activities,
      pcl.cut_people_feeling_distant_prepan = pcl.cut_people_feeling_distant,
      pcl.feeling_irritable_or_having_angry_outbursts_prepan = pcl.feeling_irritable_or_having_angry_outbursts,
      pcl.difficulty_concentrating_prepan = pcl.difficulty_concentrating
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(edgi.pcl.raw.id)
  # Inspect colnames
  colnames(edgi.pcl.raw.id)
  #Differences
  dim(edgi.pcl.raw)[1]-dim(edgi.pcl.raw.id)[1]
}
```


```{r edgi pcl prepan copy}
if(EDGI == TRUE) {
  prepan.pcl.raw.id <- edgi.pcl.raw.id
}
```


Calculate sum score for PCL-6

*Note that scores with missingness will be changed to NA later in the script
```{r pcl sum score prepan}
if(GLAD == TRUE | EDGI == TRUE){
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
pcl.items_key_prepan <- c(1,1,1,1,1,1)

# Create vector with items that are included in total score
pcl.items_prepan <- c(
  "pcl.stressful_experience_repeated_images_prepan_numeric",
  "pcl.stressful_experience_upset_reminded_prepan_numeric",
  "pcl.stressful_situation_avoiding_activities_prepan_numeric",
  "pcl.cut_people_feeling_distant_prepan_numeric",
  "pcl.feeling_irritable_or_having_angry_outbursts_prepan_numeric",
  "pcl.difficulty_concentrating_prepan_numeric"
  )

# Calculate total score
pcl.scored_items_prepan <- scoreItems(keys = pcl.items_key_prepan,
                                        items = prepan.pcl.raw.id[pcl.items_prepan],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 1, 
                                        max = 5)
# Add in column to tibble
prepan.pcl.raw.id$pcl.sum_score_prepan_raw <- pcl.scored_items_prepan$scores

# Look at values
prepan.pcl.raw.id %>%
  descr(pcl.sum_score_prepan_raw,
        stats = "common"
        )
}
```

Missigness

prepandemic
```{r pcl prepan missingness}
if(GLAD == TRUE | EDGI == TRUE){
prepan.pcl.raw.id <- prepan.pcl.raw.id %>%
  mutate(
    na_per_person_pcl_prepan =         # variable for NA per person
      rowSums(                       
        is.na(.[pcl.items_prepan])
      )
  )

prepan.pcl.raw.id %>%
  freq(na_per_person_pcl_prepan,
       cumul = F)
}
```

```{r pcl prepan sum score if missigng items set to NA}
if(GLAD == TRUE | EDGI == TRUE){
prepan.pcl.raw.id <- prepan.pcl.raw.id %>%
  mutate(
    pcl.sum_score_prepan =
      if_else(condition = na_per_person_pcl_prepan > 0,
              true = NA_real_,
              false = pcl.sum_score_prepan_raw,
              missing = NA_real_
      )
  )

prepan.pcl.raw.id %>%
  descr(pcl.sum_score_prepan_raw, stats = "common")

prepan.pcl.raw.id %>%
  descr(pcl.sum_score_prepan, stats = "common")
}
```

```{r pcl prepan head}
if(GLAD == TRUE | EDGI == TRUE){
head(prepan.pcl.raw.id)
}
```

```{r pcl prepan summary}
if(GLAD == TRUE | EDGI == TRUE){
summarytools::dfSummary(
  prepan.pcl.raw.id,
  graph.col = F,
  valid.col = F, labels.col = F)
}
```

## PHQ (prepan)

```{r glad phq cols}
if(GLAD == TRUE){
glad.phq.raw <- readRDS(file = paste0(data.raw_path, "/glad/phq_glad.rds"))
dim(glad.phq.raw)
colnames(glad.phq.raw)
}
```

```{r glad phq cleaning}
if(GLAD == TRUE){
glad.phq.raw.id <- glad.phq.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    phq.little_interest_or_pleasure_in_doing_things_prepan = phq.little_interest_or_pleasure_in_doing_things,
    phq.feeling_down_depressed_or_hopeless_prepan = phq.feeling_down_depressed_or_hopeless,
    phq.staying_asleep_sleeping_trouble_prepan = phq.staying_asleep_sleeping_trouble,
    phq.feeling_tired_or_having_little_energy_prepan = phq.feeling_tired_or_having_little_energy,
    phq.poor_appetite_or_overeating_prepan = phq.poor_appetite_or_overeating,
    phq.feeling_bad_failure_family_prepan = phq.feeling_bad_failure_family,
    phq.trouble_concentrating_reading_newspaper_prepan = phq.trouble_concentrating_reading_newspaper,
    phq.moving_fidgety_noticed_opposite_prepan = phq.moving_fidgety_noticed_opposite,
    phq.dead_hurting_thoughts_prepan = phq.dead_hurting_thoughts
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.phq.raw.id)
# Inspect colnames
colnames(glad.phq.raw.id)
#Differences
dim(glad.phq.raw)[1]-dim(glad.phq.raw.id)[1]
}
```

```{r glad phq prepan copy}
if(GLAD == TRUE) {
  prepan.phq.raw.id <- glad.phq.raw.id
}
```

```{r edgi phq cols}
if(EDGI == TRUE){
  edgi.phq.raw <- readRDS(file = paste0(data.raw_path, "/edgi/phq_edgi.rds"))
  dim(edgi.phq.raw)
  colnames(edgi.phq.raw)
}
```

```{r edgi phq cleaning}
if(EDGI == TRUE){
  edgi.phq.raw.id <- edgi.phq.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
      phq.little_interest_or_pleasure_in_doing_things_prepan = phq.little_interest_or_pleasure_in_doing_things,
      phq.feeling_down_depressed_or_hopeless_prepan = phq.feeling_down_depressed_or_hopeless,
      phq.staying_asleep_sleeping_trouble_prepan = phq.staying_asleep_sleeping_trouble,
      phq.feeling_tired_or_having_little_energy_prepan = phq.feeling_tired_or_having_little_energy,
      phq.poor_appetite_or_overeating_prepan = phq.poor_appetite_or_overeating,
      phq.feeling_bad_failure_family_prepan = phq.feeling_bad_failure_family,
      phq.trouble_concentrating_reading_newspaper_prepan = phq.trouble_concentrating_reading_newspaper,
      phq.moving_fidgety_noticed_opposite_prepan = phq.moving_fidgety_noticed_opposite,
      phq.dead_hurting_thoughts_prepan = phq.dead_hurting_thoughts
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(edgi.phq.raw.id)
  # Inspect colnames
  colnames(edgi.phq.raw.id)
  #Differences
  dim(edgi.phq.raw)[1]-dim(edgi.phq.raw.id)[1]
}
```

```{r edgi phq prepan copy}
if(EDGI == TRUE) {
  prepan.phq.raw.id <- edgi.phq.raw.id
}
```

Calculate sum score for PHQ-9

*Note that scores with missingness will be changed to NA later in the script
```{r phq sum score prepan}
if(GLAD == TRUE | EDGI == TRUE) {
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
phq.items_key_prepan <- c(1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in sum score
phq.items_prepan <- c(
  "phq.little_interest_or_pleasure_in_doing_things_prepan_numeric",
  "phq.feeling_down_depressed_or_hopeless_prepan_numeric",
  "phq.staying_asleep_sleeping_trouble_prepan_numeric",
  "phq.feeling_tired_or_having_little_energy_prepan_numeric",
  "phq.poor_appetite_or_overeating_prepan_numeric",
  "phq.feeling_bad_failure_family_prepan_numeric",
  "phq.trouble_concentrating_reading_newspaper_prepan_numeric",
  "phq.moving_fidgety_noticed_opposite_prepan_numeric",
  "phq.dead_hurting_thoughts_prepan_numeric"
  )

# Calculate sum score
phq.scored_items_prepan <- scoreItems(keys = phq.items_key_prepan,
                                        items = prepan.phq.raw.id[phq.items_prepan],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 3)
# Add in column to tibble
prepan.phq.raw.id$phq.sum_score_prepan_raw <- phq.scored_items_prepan$scores

# Look at values
prepan.phq.raw.id %>%
  descr(phq.sum_score_prepan_raw,
        stats = "common"
        )
}
```

PHQ missingness (NAs per person)

prepandemic
```{r phq prepan missingness}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.phq.raw.id <- prepan.phq.raw.id %>%
  mutate(
    na_per_person_phq_prepan =         # variable for NA per person
      rowSums(                       
        is.na(.[phq.items_prepan])
      )
  )

prepan.phq.raw.id %>%
  freq(na_per_person_phq_prepan,
       cumul = F)
}
```


```{r phq prepan missingness 8 items}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.phq.raw.id <- prepan.phq.raw.id %>%
  mutate(
    phq.missing_only_suicide_item_prepan = 
      if_else(
        condition = na_per_person_phq_prepan == 1 & 
          is.na(phq.dead_hurting_thoughts_prepan_numeric), 
        true = 1,
        false = 0,
        missing = NA_real_
      )
  )

prepan.phq.raw.id %>%
  freq(phq.missing_only_suicide_item_prepan,
       cumul = F)
}
```

all times
```{r phq prepan sum score if missigng items set to NA - all items}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.phq.raw.id <- prepan.phq.raw.id %>%
  mutate(
    phq.sum_score_prepan =
      if_else(condition = na_per_person_phq_prepan > 0,
              true = NA_real_,
              false = phq.sum_score_prepan_raw,
              missing = NA_real_
      )
  )

prepan.phq.raw.id %>%
  descr(phq.sum_score_prepan_raw, stats = "common")

prepan.phq.raw.id %>%
  descr(phq.sum_score_prepan, stats = "common")
}
```

+++CH: THINK ABOUT THIS!!!

8 items
```{r phq prepan sum score if missigng items set to NA - 8 items}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.phq.raw.id <- prepan.phq.raw.id %>%
  mutate(
    phq.sum_score_8items_prepan =
      if_else(condition = na_per_person_phq_prepan > 1 &
                phq.missing_only_suicide_item_prepan == 1,
              true = NA_real_,
              false = phq.sum_score_prepan_raw,
              missing = NA_real_
      )
  )

prepan.phq.raw.id %>%
  descr(phq.sum_score_8items_prepan, stats = "common")

prepan.phq.raw.id %>%
  descr(phq.sum_score_8items_prepan, stats = "common")
}
```


```{r phq prepan head}
if(GLAD == TRUE | EDGI == TRUE) {
head(prepan.phq.raw.id)
}
```

```{r phq prepan summary}
if(GLAD == TRUE | EDGI == TRUE) {
summarytools::dfSummary(
  prepan.phq.raw.id,
  graph.col = F,
  valid.col = F
  )
}
```

## OCIR (prepan)

```{r glad ocir prepan cols}
if(GLAD == TRUE){
glad.ocir.raw <- readRDS(file = paste0(data.raw_path, "/glad/ocir_glad.rds"))
dim(glad.ocir.raw)
colnames(glad.ocir.raw)
}
```

```{r glad ocir prepan cleaning}
if(GLAD == TRUE){
glad.ocir.raw.id <- glad.ocir.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID),) %>%
  select(
    Sample, # Sample
    ID, # ID
    ocir.i_repeatedly_check_doors_windows_drawers_etc_prepan = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
    ocir.arranged_things_change_upset_prepan = ocir.arranged_things_change_upset,
    ocir.repeat_feel_numbers_prepan = ocir.repeat_feel_numbers,
    ocir.clean_simply_wash_feel_prepan = ocir.clean_simply_wash_feel,
    ocir.mind_upset_unpleasant_thoughts_prepan = ocir.mind_upset_unpleasant_thoughts,
    ocir.afraid_avoid_throwing_things_prepan = ocir.afraid_avoid_throwing_things,
    ocir.light_switches_water_taps_prepan = ocir.light_switches_water_taps,
    ocir.arranged_things_prepan = ocir.arranged_things,
    ocir.good_feel_bad_numbers_prepan = ocir.good_feel_bad_numbers,
    ocir.hands_longer_wash_prepan = ocir.hands_longer_wash,
    ocir.saved_things_prepan = ocir.saved_things,
    ocir.frequently_difficulty_rid_nasty_prepan = ocir.frequently_difficulty_rid_nasty,
    ocir.i_check_things_more_often_than_necessary_prepan = ocir.i_check_things_more_often_than_necessary.,
    ocir.arranged_properly_objects_upset_prepan = ocir.arranged_properly_objects_upset,
    ocir.feel_compelled_count_things_prepan = ocir.feel_compelled_count_things,
    ocir.strangers_touch_touched_difficult_prepan = ocir.strangers_touch_touched_difficult,
    ocir.control_difficult_find_thoughts_prepan = ocir.control_difficult_find_thoughts,
    ocir.i_collect_things_i_dont_need_prepan = ocir.i_collect_things_i_dont_need
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(glad.ocir.raw.id)
# Inspect colnames
colnames(glad.ocir.raw.id)
#Differences
dim(glad.ocir.raw)[1]-dim(glad.ocir.raw.id)[1]
}
```

```{r glad ocir prepan copy}
if(GLAD == TRUE) {
  prepan.ocir.raw.id <- glad.ocir.raw.id
}
```

```{r edgi ocir prepan cols}
if(EDGI == TRUE){
  edgi.ocir.raw <- readRDS(file = paste0(data.raw_path, "/edgi/ocir_edgi.rds"))
  dim(edgi.ocir.raw)
  colnames(edgi.ocir.raw)
}
```

```{r edgi ocir prepan cleaning}
if(EDGI == TRUE){
  edgi.ocir.raw.id <- edgi.ocir.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)) %>%
    select(
      Sample, # Sample
      ID, # ID
      ocir.i_repeatedly_check_doors_windows_drawers_etc_prepan = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
      ocir.arranged_things_change_upset_prepan = ocir.arranged_properly_objects_upset, # different GLAD: ocir.arranged_things_change_upset,
      ocir.repeat_feel_numbers_prepan = ocir.repeat_feel_numbers.87, # ocir.repeat_feel_numbers,
      ocir.clean_simply_wash_feel_prepan = ocir.clean_simply_wash_feel.9, # ocir.clean_simply_wash_feel,
      ocir.mind_upset_unpleasant_thoughts_prepan = ocir.mind_upset_unpleasant_thoughts.11, # ocir.mind_upset_unpleasant_thoughts,
      ocir.afraid_avoid_throwing_things_prepan = ocir.afraid_avoid_throwing_things.7, # ocir.afraid_avoid_throwing_things,
      ocir.light_switches_water_taps_prepan = ocir.light_switches_water_taps.7, # ocir.light_switches_water_taps,
      ocir.arranged_things_prepan = ocir.arranged_things.32, # ocir.arranged_things,
      ocir.good_feel_bad_numbers_prepan = ocir.good_feel_bad_numbers.60, # ocir.good_feel_bad_numbers,
      ocir.hands_longer_wash_prepan = ocir.hands_longer_wash.23, # ocir.hands_longer_wash,
      ocir.saved_things_prepan = ocir.saved_things,
      ocir.frequently_difficulty_rid_nasty_prepan = ocir.frequently_difficulty_rid_nasty.16, # ocir.frequently_difficulty_rid_nasty,
      ocir.i_check_things_more_often_than_necessary_prepan = ocir.i_check_things_more_often_than_necessary.,
      ocir.arranged_properly_objects_upset_prepan = ocir.arranged_properly_objects_upset,
      ocir.feel_compelled_count_things_prepan = ocir.feel_compelled_count_things.27, # ocir.feel_compelled_count_things,
      ocir.strangers_touch_touched_difficult_prepan = ocir.strangers_touch_touched_difficult.33, # ocir.strangers_touch_touched_difficult,
      ocir.control_difficult_find_thoughts_prepan = ocir.control_difficult_find_thoughts.30, #ocir.control_difficult_find_thoughts,
      ocir.i_collect_things_i_dont_need_prepan = ocir.i_collect_things_i_dont_need.348, # ocir.i_collect_things_i_dont_need
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(edgi.ocir.raw.id)
  # Inspect colnames
  colnames(edgi.ocir.raw.id)
  #Differences
  dim(edgi.ocir.raw)[1]-dim(edgi.ocir.raw.id)[1]
}
```

```{r edgi ocir prepan copy}
if(EDGI == TRUE) {
  prepan.ocir.raw.id <- edgi.ocir.raw.id
}
```

Calculate sum score for OCI-R

*Note that scores with missingness will be changed to NA later in the script
```{r ocir sum score prepan}
if(GLAD == TRUE | EDGI == TRUE) {
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
ocir.items_key_prepan <- c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in sum score
ocir.items_prepan = c(
  "ocir.i_repeatedly_check_doors_windows_drawers_etc_prepan_numeric",
  "ocir.arranged_things_change_upset_prepan_numeric",
  "ocir.repeat_feel_numbers_prepan_numeric",
  "ocir.clean_simply_wash_feel_prepan_numeric",
  "ocir.mind_upset_unpleasant_thoughts_prepan_numeric",
  "ocir.afraid_avoid_throwing_things_prepan_numeric",
  "ocir.light_switches_water_taps_prepan_numeric",
  "ocir.arranged_things_prepan_numeric",
  "ocir.good_feel_bad_numbers_prepan_numeric",
  "ocir.hands_longer_wash_prepan_numeric",
  "ocir.saved_things_prepan_numeric",
  "ocir.frequently_difficulty_rid_nasty_prepan_numeric",
  "ocir.i_check_things_more_often_than_necessary_prepan_numeric",
  "ocir.arranged_properly_objects_upset_prepan_numeric",
  "ocir.feel_compelled_count_things_prepan_numeric",
  "ocir.strangers_touch_touched_difficult_prepan_numeric",
  "ocir.control_difficult_find_thoughts_prepan_numeric",
  "ocir.i_collect_things_i_dont_need_prepan_numeric"
  )

# Calculate sum score
ocir.scored_items_prepan <- scoreItems(keys = ocir.items_key_prepan,
                                        items = prepan.ocir.raw.id[ocir.items_prepan],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 4)

# Add in column to tibble
prepan.ocir.raw.id$ocir.sum_score_prepan_raw <- ocir.scored_items_prepan$scores

# Look at values
prepan.ocir.raw.id %>%
  descr(ocir.sum_score_prepan_raw,
        stats = "common"
        )
}
```

prepandemic
```{r ocir prepan missingness}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.ocir.raw.id <- prepan.ocir.raw.id %>%
  mutate(
    na_per_person_ocir_prepan =         # variable for NA per person
      rowSums(                       
        is.na(.[ocir.items_prepan])
      )
  )

prepan.ocir.raw.id %>%
  freq(na_per_person_ocir_prepan,
       cumul = F)
}
```

```{r ocir prepan sum score if missigng items set to NA - all items}
if(GLAD == TRUE | EDGI == TRUE) {
prepan.ocir.raw.id <- prepan.ocir.raw.id %>%
  mutate(
    ocir.sum_score_prepan =
      if_else(condition = na_per_person_ocir_prepan > 0,
              true = NA_real_,
              false = ocir.sum_score_prepan_raw,
              missing = NA_real_
      )
  )

prepan.ocir.raw.id %>%
  descr(ocir.sum_score_prepan_raw, stats = "common")

prepan.ocir.raw.id %>%
  descr(ocir.sum_score_prepan, stats = "common")
}
```

```{r ocir prepan head}
if(GLAD == TRUE | EDGI == TRUE) {
head(prepan.ocir.raw.id)
}
```

```{r ocir prepan summary}
if(GLAD == TRUE | EDGI == TRUE) {
summarytools::dfSummary(
  prepan.ocir.raw.id,
  graph.col = F,
  valid.col = F
  )
}
```

# COPING GAD-7
## GLAD
```{r coping glad gad cols}
if(GLAD == TRUE) {
coping.glad.gad.raw <- readRDS(file = paste0(data.raw_path,"/glad/gad_coping_glad.rds"))
dim(coping.glad.gad.raw)
colnames(coping.glad.gad.raw)
}
```

```{r coping glad gad summary}
if(GLAD == TRUE) {
summarytools::dfSummary(
  coping.glad.gad.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F
  )
}
```


```{r coping glad gad cleaning}
if(GLAD == TRUE) {
exclude_cols_coping_glad <- c(
  "Sample",
  "ID",
  "startDate.coping"
)

coping.glad.gad.raw.id <- coping.glad.gad.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)
         ) %>% 
  select(
    Sample, # Sample
    ID, # ID
    startDate.coping = startDate, # Rename startDate
    gad.problems_made_difficult_care, # Impairment
    gad.pandemic_felt_feelings, # Comparison to before the pandemic (retro)
    gad.feeling_nervous_anxious_or_on_edge_retro = gad.feeling_nervous_anxious_or_on_edge,
    gad.control_worrying_stop_retro = gad.control_worrying_stop,
    gad.worrying_too_much_about_different_things_retro = gad.worrying_too_much_about_different_things,
    gad.trouble_relaxing_retro = gad.trouble_relaxing,
    gad.sit_restless_hard_retro = gad.sit_restless_hard,
    gad.becoming_easily_annoyed_or_irritable_retro = gad.becoming_easily_annoyed_or_irritable,
    gad.awful_feeling_afraid_happen_retro = gad.awful_feeling_afraid_happen,
    gad.feeling_nervous_anxious_or_on_edge_base = gad.feeling_nervous_anxious_or_on_edge.1,
    gad.control_worrying_stop_base = gad.control_worrying_stop.1,
    gad.worrying_too_much_about_different_things_base = gad.worrying_too_much_about_different_things.1,
    gad.trouble_relaxing_base = gad.trouble_relaxing.1,
    gad.sit_restless_hard_base = gad.sit_restless_hard.1,
    gad.becoming_easily_annoyed_or_irritable_base = gad.becoming_easily_annoyed_or_irritable.1,
    gad.awful_feeling_afraid_happen_base = gad.awful_feeling_afraid_happen.1
  ) %>%
  add_numeric(., exclude = exclude_cols_coping_glad) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.glad.gad.raw.id)
# Inspect colnames
colnames(coping.glad.gad.raw.id)
#Differences
dim(coping.glad.gad.raw)[1]-dim(coping.glad.gad.raw.id)[1]
}
```

```{r coping glad gad copy}
if(GLAD == TRUE) {
  coping.gad.raw.id <- coping.glad.gad.raw.id
}
```

## EDGI
```{r coping edgi gad cols}
if(EDGI == TRUE) {
  coping.edgi.gad.raw <- readRDS(file = paste0(data.raw_path,"/edgi/gad_coping_edgi.rds"))
  dim(coping.edgi.gad.raw)
  colnames(coping.edgi.gad.raw)
}
```

```{r coping edgi gad summary}
if(EDGI == TRUE) {
  summarytools::dfSummary(
    coping.edgi.gad.raw,
    graph.col = F,
    valid.col = F,
    labels.col = T # to see what is baseline and what is retro
  )
}
```


```{r coping edgi gad cleaning}
if(EDGI == TRUE) {
  exclude_cols_coping_edgi <- c(
    "Sample",
    "ID",
    "startDate.coping"
  )
  
  coping.edgi.gad.raw.id <- coping.edgi.gad.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)
    ) %>% 
    select(
      Sample, # Sample
      ID, # ID
      startDate.coping = startDate, # Rename startDate
      gad.problems_made_difficult_care = gad.care_difficult_home_things, # Impairment (different to GLAD)
      gad.pandemic_felt_feelings = gad.pandemic_feelings_felt, # Comparison to before the pandemic (retro; different to GLAD)
      gad.feeling_nervous_anxious_or_on_edge_retro = gad.feeling_nervous_anxious_or_on_edge,
      gad.control_worrying_stop_retro = gad.control_worrying_stop,
      gad.worrying_too_much_about_different_things_retro = gad.worrying_too_much_about_different_things,
      gad.trouble_relaxing_retro = gad.trouble_relaxing,
      gad.sit_restless_hard_retro = gad.sit_restless_hard,
      gad.becoming_easily_annoyed_or_irritable_retro = gad.becoming_easily_annoyed_or_irritable,
      gad.awful_feeling_afraid_happen_retro = gad.feeling_afraid_awful_happen, # different to GLAD: gad.awful_feeling_afraid_happen,
      gad.feeling_nervous_anxious_or_on_edge_base = gad.feeling_nervous_anxious_or_on_edge.1,
      gad.control_worrying_stop_base = gad.control_worrying_stop.1,
      gad.worrying_too_much_about_different_things_base = gad.worrying_too_much_about_different_things.1,
      gad.trouble_relaxing_base = gad.trouble_relaxing.1,
      gad.sit_restless_hard_base = gad.sit_restless_hard.1,
      gad.becoming_easily_annoyed_or_irritable_base = gad.becoming_easily_annoyed_or_irritable.1,
      gad.awful_feeling_afraid_happen_base = gad.feeling_afraid_awful_happen.1 # different to GLAD: gad.awful_feeling_afraid_happen.1
    ) %>%
    add_numeric(., exclude = exclude_cols_coping_edgi) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(coping.edgi.gad.raw.id)
  # Inspect colnames
  colnames(coping.edgi.gad.raw.id)
  #Differences
  dim(coping.edgi.gad.raw)[1]-dim(coping.edgi.gad.raw.id)[1]
}
```

```{r coping edgi gad copy}
if(EDGI == TRUE) {
  coping.gad.raw.id <- coping.edgi.gad.raw.id
}
```

## NBR
```{r coping nbr gad cols}
if(NBR == TRUE) {
  coping.nbr.gad.raw <- readRDS(file = paste0(data.raw_path,"/nbr/gad_coping_nbr.rds"))
  dim(coping.nbr.gad.raw)
  colnames(coping.nbr.gad.raw)
}
```

```{r coping nbr gad summary}
if(NBR == TRUE) {
  summarytools::dfSummary(
    coping.nbr.gad.raw,
    graph.col = F,
    valid.col = F,
    labels.col = F
  )
}
```


```{r coping nbr gad cleaning}
if(NBR == TRUE) {
  exclude_cols_coping_nbr <- c(
    "Sample",
    "ID",
    "startDate.coping"
  )
  
  coping.nbr.gad.raw.id <- coping.nbr.gad.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(ID = as.numeric(ID)) %>% 
    select(
      Sample, # Sample
      ID, # ID
      startDate.coping = startDate, # Rename startDate
      gad.problems_made_difficult_care = gad.problems_made_care_difficult, # Impairment (different from GLAD)
      gad.pandemic_felt_feelings, # Comparison to before the pandemic (retro)
      gad.feeling_nervous_anxious_or_on_edge_retro = gad.feeling_nervous_anxious_or_on_edge,
      gad.control_worrying_stop_retro = gad.control_worrying_stop,
      gad.worrying_too_much_about_different_things_retro = gad.worrying_too_much_about_different_things,
      gad.trouble_relaxing_retro = gad.trouble_relaxing,
      gad.sit_restless_hard_retro = gad.sit_restless_hard,
      gad.becoming_easily_annoyed_or_irritable_retro = gad.becoming_easily_annoyed_or_irritable,
      gad.awful_feeling_afraid_happen_retro = gad.feeling_afraid_awful_happen, #Different from GLAD
      gad.feeling_nervous_anxious_or_on_edge_base = gad.feeling_nervous_anxious_or_on_edge.1,
      gad.control_worrying_stop_base = gad.control_worrying_stop.1,
      gad.worrying_too_much_about_different_things_base = gad.worrying_too_much_about_different_things.1,
      gad.trouble_relaxing_base = gad.trouble_relaxing.1,
      gad.sit_restless_hard_base = gad.sit_restless_hard.1,
      gad.becoming_easily_annoyed_or_irritable_base = gad.becoming_easily_annoyed_or_irritable.1,
      gad.awful_feeling_afraid_happen_base = gad.feeling_afraid_awful_happen.1 #Different from GLAD
    ) %>%
    add_numeric(., exclude = exclude_cols_coping_nbr) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(coping.nbr.gad.raw.id)
  # Inspect colnames
  colnames(coping.nbr.gad.raw.id)
  #Differences
  dim(coping.nbr.gad.raw)[1]-dim(coping.nbr.gad.raw.id)[1]
}
```

```{r coping nbr gad copy}
if(NBR == TRUE) {
  coping.gad.raw.id <- coping.nbr.gad.raw.id
}
```

## RAMP
```{r coping ramp gad cols}
if(RAMP == TRUE) {
  ramp.gad.raw <- readRDS(file = paste0(data.raw_path,"/ramp/gad_ramp.rds"))
  dim(ramp.gad.raw)
  colnames(ramp.gad.raw)
}
```

```{r coping ramp gad summary}
if(RAMP == TRUE) {
  summarytools::dfSummary(
    ramp.gad.raw,
    graph.col = F,
    valid.col = F,
    labels.col = F
  )
}
```


```{r coping ramp gad cleaning}
if(RAMP == TRUE) {
  exclude_cols_ramp <- c(
    "Sample",
    "ID",
    "startDate.coping"
  )
  
  ramp.gad.raw.id <- ramp.gad.raw %>%
    drop_na(`Login ID`) %>% # Drop NAs
    distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
    separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    mutate(ID = as.numeric(ID)
    ) %>% 
    select(
      Sample, # Sample
      ID, # ID
      startDate.coping = startDate, # Rename startDate
      gad.problems_made_difficult_care = gad.issues_made_carrying_daily, # Impairment
      gad.pandemic_felt_feelings = gad.feelings_pandemic_felt, # Comparison to before the pandemic (retro)
      gad.feeling_nervous_anxious_or_on_edge_retro = gad.feeling_nervous_anxious_or_on_edge.1, #retro and baseline coding are reversed for RAMP
      gad.control_worrying_stop_retro = gad.control_worrying_stop.1, #.1 = retro
      gad.worrying_too_much_about_different_things_retro = gad.worrying_too_much_about_different_things.1,
      gad.trouble_relaxing_retro = gad.trouble_relaxing.1,
      gad.sit_restless_hard_retro = gad.sit_hard_restless.1,
      gad.becoming_easily_annoyed_or_irritable_retro = gad.becoming_easily_annoyed_or_irritable.1,
      gad.awful_feeling_afraid_happen_retro = gad.awful_feeling_afraid_happen.1,
      gad.feeling_nervous_anxious_or_on_edge_base = gad.feeling_nervous_anxious_or_on_edge,
      gad.control_worrying_stop_base = gad.control_worrying_stop,
      gad.worrying_too_much_about_different_things_base = gad.worrying_too_much_about_different_things,
      gad.trouble_relaxing_base = gad.trouble_relaxing,
      gad.sit_restless_hard_base = gad.sit_hard_restless,
      gad.becoming_easily_annoyed_or_irritable_base = gad.becoming_easily_annoyed_or_irritable,
      gad.awful_feeling_afraid_happen_base = gad.awful_feeling_afraid_happen
    ) %>%
    add_numeric(., exclude = exclude_cols_ramp) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  
  # Inspect dimensions
  dim(ramp.gad.raw.id)
  # Inspect colnames
  colnames(ramp.gad.raw.id)
  #Differences
  dim(ramp.gad.raw)[1]-dim(ramp.gad.raw.id)[1]
}
```

```{r coping ramp gad copy}
if(RAMP == TRUE) {
  coping.gad.raw.id <- ramp.gad.raw.id
}
```

## Sum scores
Calculate sum score for GAD-7 retrospective
```{r coping gad sum score retro}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
gad.items_key_retro <- c(1,1,1,1,1,1,1)

# Create vector with items that are included in total score
gad.items_retro <- c(
  "gad.feeling_nervous_anxious_or_on_edge_retro_numeric",
  "gad.control_worrying_stop_retro_numeric",
  "gad.worrying_too_much_about_different_things_retro_numeric",
  "gad.trouble_relaxing_retro_numeric",
  "gad.sit_restless_hard_retro_numeric",
  "gad.becoming_easily_annoyed_or_irritable_retro_numeric",
  "gad.awful_feeling_afraid_happen_retro_numeric"
  )

# Calculate total score
gad.scored_items_retro <- scoreItems(keys = gad.items_key_retro,
                                        items = coping.gad.raw.id[gad.items_retro],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 3)
# Add in column to tibble
coping.gad.raw.id$gad.sum_score_retro_raw <- gad.scored_items_retro$scores

# Look at values
coping.gad.raw.id %>%
  descr(gad.sum_score_retro_raw,
        stats = "common"
        )
```

Calculate sum score for GAD-7 baseline
```{r coping gad sum score base}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
gad.items_key_base <- c(1,1,1,1,1,1,1)

# Create vector with items that are included in total score
gad.items_base <- c(
  "gad.feeling_nervous_anxious_or_on_edge_base_numeric",
  "gad.control_worrying_stop_base_numeric",
  "gad.worrying_too_much_about_different_things_base_numeric",
  "gad.trouble_relaxing_base_numeric",
  "gad.sit_restless_hard_base_numeric",
  "gad.becoming_easily_annoyed_or_irritable_base_numeric",
  "gad.awful_feeling_afraid_happen_base_numeric"
  )

# Calculate total score
gad.scored_items_base <- scoreItems(keys = gad.items_key_base,
                                        items = coping.gad.raw.id[gad.items_base],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 3)
# Add in column to tibble
coping.gad.raw.id$gad.sum_score_base_raw <- gad.scored_items_base$scores

# Look at values
coping.gad.raw.id %>%
  descr(gad.sum_score_base_raw,
        stats = "common"
        )
```

## Missingness

baseline
```{r coping gad baseline missingness}
coping.gad.raw.id <- coping.gad.raw.id %>%
  mutate(
    na_per_person_gad_base =         # variable for NA per person
      rowSums(                       
        is.na(.[gad.items_base])
      )
  )

coping.gad.raw.id %>%
  freq(na_per_person_gad_base, cumul = F) #have a look at the frequency
```

```{r coping gad retrospective missingness}
coping.gad.raw.id <- coping.gad.raw.id %>%
  mutate(
    na_per_person_gad_retro =         # variable for NA per person
      rowSums(
        is.na(.[gad.items_retro])
      )
  )

coping.gad.raw.id %>%
  freq(na_per_person_gad_retro, cumul = F) #have a look at the frequency
```

```{r coping gad base sum score if missing items set to NA}
coping.gad.raw.id <- coping.gad.raw.id %>%
  mutate(
    gad.sum_score_base =
      if_else(condition = na_per_person_gad_base > 0,
              true = NA_real_,
              false = gad.sum_score_base_raw,
              missing = NA_real_
      )
  )

coping.gad.raw.id %>%
  descr(gad.sum_score_base_raw, stats = "common")

coping.gad.raw.id %>%
  descr(gad.sum_score_base, stats = "common")
```


```{r coping gad retro sum score if missing items set to NA}
coping.gad.raw.id <- coping.gad.raw.id %>%
  mutate(
    gad.sum_score_retro =
      if_else(condition = na_per_person_gad_retro > 0,
              true = NA_real_,
              false = gad.sum_score_retro_raw,
              missing = NA_real_
      )
  )

coping.gad.raw.id %>%
  descr(gad.sum_score_retro_raw, stats = "common")

coping.gad.raw.id %>%
  descr(gad.sum_score_retro, stats = "common")
```

## Inspection
```{r coping glad gad head}
head(coping.gad.raw.id)
```

```{r coping glad gad summary 2}
summarytools::dfSummary(
  coping.gad.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# COPING: PCL-6

## GLAD
```{r coping glad pcl cols}
if(GLAD == TRUE) {
coping.glad.pcl.raw <- readRDS(file = paste0(data.raw_path,"/glad/pcl_coping_glad.rds"))
dim(coping.glad.pcl.raw)
colnames(coping.glad.pcl.raw)
}
```

```{r coping glad pcl summary labels}
if(GLAD == TRUE) {
summarytools::dfSummary(
  coping.glad.pcl.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F
)
}
```

Note: Retro for the PCL does not mean retrospective

```{r coping glad pcl cleaning}
if(GLAD == TRUE) {
coping.glad.pcl.raw.id <- coping.glad.pcl.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    pcl.stressful_experience_repeated_images_base = pcl.stressful_experience_repeated_images,
    pcl.stressful_experience_upset_reminded_base = pcl.stressful_experience_upset_reminded, # differ to GLAD prepan
    pcl.stressful_situation_avoiding_activities_base = pcl.avoiding_activities_stressful_experience, # differ to GLAD prepan
    pcl.cut_people_feeling_distant_base = pcl.cut_people_feeling_distant,
    pcl.feeling_irritable_or_having_angry_outbursts_base = pcl.feeling_irritable_or_having_angry_outbursts,
    pcl.difficulty_concentrating_base = pcl.difficulty_concentrating,
    pcl.stressful_experience_repeated_images_retro = pcl.stressful_experience_repeated_images.1,
    pcl.stressful_experience_upset_reminded_retro = pcl.stressful_experience_upset_reminded.1,
    pcl.stressful_situation_avoiding_activities_retro = pcl.avoiding_activities_stressful_experience.1,
    pcl.cut_people_feeling_distant_retro = pcl.cut_people_feeling_distant.1,
    pcl.feeling_irritable_or_having_angry_outbursts_retro = pcl.feeling_irritable_or_having_angry_outbursts.1,
    pcl.difficulty_concentrating_retro = pcl.difficulty_concentrating.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.glad.pcl.raw.id)
# Inspect colnames
colnames(coping.glad.pcl.raw.id)
#Differences
dim(coping.glad.pcl.raw)[1]-dim(coping.glad.pcl.raw.id)[1]
}
```

```{r coping glad pcl copy}
if(GLAD == TRUE) {
  coping.pcl.raw.id <- coping.glad.pcl.raw.id
}
```

## EDGI
```{r coping edgi pcl cols}
if(EDGI == TRUE) {
coping.edgi.pcl.raw <- readRDS(file = paste0(data.raw_path,"/edgi/pcl_coping_edgi.rds"))
dim(coping.edgi.pcl.raw)
colnames(coping.edgi.pcl.raw)
}
```

```{r coping edgi pcl summary labels}
if(EDGI == TRUE) {
summarytools::dfSummary(
  coping.edgi.pcl.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F
)
}
```

Note: Retro for the PCL does not mean retrospective

```{r coping edgi pcl cleaning}
if(EDGI == TRUE) {
coping.edgi.pcl.raw.id <- coping.edgi.pcl.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    pcl.stressful_experience_repeated_images_base = pcl.repeated_images_thoughts_past, # different pcl.stressful_experience_repeated_images,
    pcl.stressful_experience_upset_reminded_base = pcl.upset_reminded_past_feeling, # differ to EDGI prepan
    pcl.stressful_situation_avoiding_activities_base = pcl.avoiding_activities_reminded_situations, # differ to EDGI prepan
    pcl.cut_people_feeling_distant_base = pcl.cut_people_feeling_distant,
    pcl.feeling_irritable_or_having_angry_outbursts_base = pcl.feeling_irritable_or_having_angry_outbursts,
    pcl.difficulty_concentrating_base = pcl.difficulty_concentrating,
    pcl.stressful_experience_repeated_images_retro = pcl.repeated_images_thoughts_past.1,
    pcl.stressful_experience_upset_reminded_retro = pcl.upset_reminded_past_feeling.1,
    pcl.stressful_situation_avoiding_activities_retro = pcl.avoiding_activities_reminded_situations.1,
    pcl.cut_people_feeling_distant_retro = pcl.cut_people_feeling_distant.1,
    pcl.feeling_irritable_or_having_angry_outbursts_retro = pcl.feeling_irritable_or_having_angry_outbursts.1,
    pcl.difficulty_concentrating_retro = pcl.difficulty_concentrating.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.edgi.pcl.raw.id)
# Inspect colnames
colnames(coping.edgi.pcl.raw.id)
#Differences
dim(coping.edgi.pcl.raw)[1]-dim(coping.edgi.pcl.raw.id)[1]
}
```

```{r coping edgi pcl copy}
if(EDGI == TRUE) {
  coping.pcl.raw.id <- coping.edgi.pcl.raw.id
}
```

## NBR
```{r coping nbr pcl cols}
if(NBR == TRUE) {
coping.nbr.pcl.raw <- readRDS(file = paste0(data.raw_path,"/nbr/pcl_coping_nbr.rds"))
dim(coping.nbr.pcl.raw)
colnames(coping.nbr.pcl.raw)
}
```

```{r coping nbr pcl summary labels}
if(NBR == TRUE) {
summarytools::dfSummary(
  coping.nbr.pcl.raw,
  graph.col = F,
  valid.col = F,
  labels.col = F
)
}
```

Note: Retro for the PCL does not mean retrospective

```{r coping nbr pcl cleaning}
if(NBR == TRUE) {
coping.nbr.pcl.raw.id <- coping.nbr.pcl.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    pcl.stressful_experience_repeated_images_base = pcl.stressful_experience_repeated_images,
    pcl.stressful_experience_upset_reminded_base = pcl.stressful_experience_upset_reminded, # differ to NBR prepan
    pcl.stressful_situation_avoiding_activities_base = pcl.avoiding_activities_stressful_experience, # differ to NBR prepan
    pcl.cut_people_feeling_distant_base = pcl.cut_people_feeling_distant,
    pcl.feeling_irritable_or_having_angry_outbursts_base = pcl.feeling_irritable_or_having_angry_outbursts,
    pcl.difficulty_concentrating_base = pcl.difficulty_concentrating,
    pcl.stressful_experience_repeated_images_retro = pcl.stressful_experience_repeated_images.1,
    pcl.stressful_experience_upset_reminded_retro = pcl.stressful_experience_upset_reminded.1,
    pcl.stressful_situation_avoiding_activities_retro = pcl.avoiding_activities_stressful_experience.1,
    pcl.cut_people_feeling_distant_retro = pcl.cut_people_feeling_distant.1,
    pcl.feeling_irritable_or_having_angry_outbursts_retro = pcl.feeling_irritable_or_having_angry_outbursts.1,
    pcl.difficulty_concentrating_retro = pcl.difficulty_concentrating.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.nbr.pcl.raw.id)
# Inspect colnames
colnames(coping.nbr.pcl.raw.id)
#Differences
dim(coping.nbr.pcl.raw)[1]-dim(coping.nbr.pcl.raw.id)[1]
}
```

```{r coping nbr pcl copy}
if(NBR == TRUE) {
  coping.pcl.raw.id <- coping.nbr.pcl.raw.id
}
```

## RAMP
```{r coping ramp pcl cols}
if(RAMP == TRUE) {
coping.ramp.pcl.raw <- readRDS(file = paste0(data.raw_path,"/ramp/pcl_ramp.rds"))
dim(coping.ramp.pcl.raw)
colnames(coping.ramp.pcl.raw)
}
```

```{r coping ramp pcl summary labels}
if(RAMP == TRUE) {
summarytools::dfSummary(
  coping.ramp.pcl.raw,
  graph.col = F,
  valid.col = F,
  labels.col = T
)
}
```

Note: Retro for the PCL does not mean retrospective

```{r coping ramp pcl cleaning}
if(RAMP == TRUE) {
coping.ramp.pcl.raw.id <- coping.ramp.pcl.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    pcl.stressful_experience_repeated_images_base = pcl.stressful_experience_repeated_images,
    pcl.stressful_experience_upset_reminded_base = pcl.stressful_experience_reminded_upset, # differ to RAMP prepan
    pcl.stressful_situation_avoiding_activities_base = pcl.stressful_experience_avoiding_activities, # differ to RAMP prepan
    pcl.cut_people_feeling_distant_base = pcl.feeling_distant_cut_people, # differ
    pcl.feeling_irritable_or_having_angry_outbursts_base = pcl.feeling_irritable_or_having_angry_outbursts,
    pcl.difficulty_concentrating_base = pcl.difficulty_concentrating,
    pcl.stressful_experience_repeated_images_retro_unc = pcl.stressful_experience_repeated_images.1,
    pcl.stressful_experience_upset_reminded_retro_unc = pcl.stressful_experience_reminded_upset.1, # differ
    pcl.stressful_situation_avoiding_activities_retro_unc = pcl.stressful_experience_avoiding_activities.1, # differ
    pcl.cut_people_feeling_distant_retro_unc = pcl.feeling_distant_cut_people.1, # differ
    pcl.feeling_irritable_or_having_angry_outbursts_retro_unc = pcl.feeling_irritable_or_having_angry_outbursts.1,
    pcl.difficulty_concentrating_retro_unc = pcl.difficulty_concentrating.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.ramp.pcl.raw.id)
# Inspect colnames
colnames(coping.ramp.pcl.raw.id)
#Differences
dim(coping.ramp.pcl.raw)[1]-dim(coping.ramp.pcl.raw.id)[1]
}
```

```{r coping ramp pcl copy}
if(RAMP == TRUE) {
  coping.pcl.raw.id <- coping.ramp.pcl.raw.id
}
```

Recode RAMP PCL retro scores
```{r recode ramp pcl retro scores}
if(RAMP == TRUE) {
  
pcl_retro_numeric_recode_vars <- c(
    "pcl.stressful_experience_repeated_images_retro_unc_numeric",
    "pcl.stressful_experience_upset_reminded_retro_unc_numeric",
    "pcl.stressful_situation_avoiding_activities_retro_unc_numeric",
    "pcl.cut_people_feeling_distant_retro_unc_numeric",
    "pcl.feeling_irritable_or_having_angry_outbursts_retro_unc_numeric",
    "pcl.difficulty_concentrating_retro_unc_numeric"
)
  
#recode and rename numeric retro items
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate_at(vars(all_of(pcl_retro_numeric_recode_vars)),
    ~ recode(.,
           `1` = 1, # 1 = Yes = 1
           `2` = 0, # 2 = No = 0
           `3` = NA_real_ # NA = 3 = NA
                   )) %>%
  rename_at(vars(ends_with("_retro_unc_numeric")), 
            funs(str_replace(., 
                             "_retro_unc_numeric", 
                             "_retro_numeric")
                 )
            )

pcl_retro_recode_vars <- c(
    "pcl.stressful_experience_repeated_images_retro_numeric",
    "pcl.stressful_experience_upset_reminded_retro_numeric",
    "pcl.stressful_situation_avoiding_activities_retro_numeric",
    "pcl.cut_people_feeling_distant_retro_numeric",
    "pcl.feeling_irritable_or_having_angry_outbursts_retro_numeric",
    "pcl.difficulty_concentrating_retro_numeric"
)

#create factor versions 
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate_at(vars(
    all_of(pcl_retro_recode_vars)),
    list("factor" = 
            ~ recode_factor(.,
           "1" = "Yes", # 1 = Yes = 1
           "0" = "No" # 2 = No = 0
                   ))) %>%
  rename_at(vars(ends_with( "retro_numeric_factor")), 
            list(~gsub(
              pattern = "_retro_numeric_factor",
              replacement = "_retro",
              .)
              )
            ) %>%
  select(
    -ends_with("unc")
  )
}

colnames(coping.pcl.raw.id)
```

## Sum scores
Calculate sum score for PCL-6 retro
```{r coping pcl sum score retro}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
pcl.items_key_retro <- c(1,1,1,1,1,1)

# Create vector with items that are included in total score
pcl.items_retro <- c(
  "pcl.stressful_experience_repeated_images_retro_numeric",
  "pcl.stressful_experience_upset_reminded_retro_numeric",
  "pcl.stressful_situation_avoiding_activities_retro_numeric",
  "pcl.cut_people_feeling_distant_retro_numeric",
  "pcl.feeling_irritable_or_having_angry_outbursts_retro_numeric",
  "pcl.difficulty_concentrating_retro_numeric"
)

# Calculate total score
pcl.scored_items_retro <- scoreItems(keys = pcl.items_key_retro,
                                     items = coping.pcl.raw.id[pcl.items_retro],
                                     totals = TRUE, 
                                     missing = TRUE, 
                                     impute = 'none', 
                                     min = 0, 
                                     max = 1)
# Add in column to tibble
coping.pcl.raw.id$pcl.sum_score_retro_raw <- pcl.scored_items_retro$scores

# Look at values
coping.pcl.raw.id %>%
  descr(pcl.sum_score_retro_raw,
        stats = "common"
  )
```


Calculate sum score for PCL-6 base
The sum scores here will not be accurate if we are using complete cases. Only use sum scores here for complete cases, otherwise the minimum will be 0 where it should be 6. 
```{r coping pcl sum score base}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
pcl.items_key_base <- c(1,1,1,1,1,1)

# Create vector with items that are included in total score
pcl.items_base <- c(
  "pcl.stressful_experience_repeated_images_base_numeric",
  "pcl.stressful_experience_upset_reminded_base_numeric",
  "pcl.stressful_situation_avoiding_activities_base_numeric",
  "pcl.cut_people_feeling_distant_base_numeric",
  "pcl.feeling_irritable_or_having_angry_outbursts_base_numeric",
  "pcl.difficulty_concentrating_base_numeric"
)

# Calculate total score
pcl.scored_items_base <- scoreItems(keys = pcl.items_key_base,
                                    items = coping.pcl.raw.id[pcl.items_base],
                                    totals = TRUE, 
                                    missing = TRUE, 
                                    impute = "none", 
                                    min = 1, 
                                    max = 5)
# Add in column to tibble
coping.pcl.raw.id$pcl.sum_score_base_raw <- pcl.scored_items_base$scores

# Look at values
coping.pcl.raw.id %>%
  descr(pcl.sum_score_base_raw,
        stats = "common"
  )


```


## Missingness
PCL missingness (NAs per person)

baseline
```{r coping pcl baseline missingness}
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate(
    na_per_person_pcl_base =         # variable for NA per person
      rowSums(                       
        is.na(.[pcl.items_base])
      )
  )

coping.pcl.raw.id %>%
  freq(na_per_person_pcl_base, cumul = F) #have a look at the frequency
```


retrospective
```{r coping pcl retrospective missingness}
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate(
    na_per_person_pcl_retro =         # variable for NA per person
      rowSums(
        is.na(.[pcl.items_retro])
      )
  )

coping.pcl.raw.id %>%
  freq(na_per_person_pcl_retro, cumul = F) #have a look at the frequency
```


```{r coping pcl base sum score if missing items set to NA}
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate(
    pcl.sum_score_base =
      if_else(condition = na_per_person_pcl_base > 0,
              true = NA_real_,
              false = pcl.sum_score_base_raw,
              missing = NA_real_
      )
  )

coping.pcl.raw.id %>%
  descr(pcl.sum_score_base_raw, stats = "common")

coping.pcl.raw.id %>%
  descr(pcl.sum_score_base, stats = "common")
```

```{r coping pcl retro sum score if missing items set to NA}
coping.pcl.raw.id <- coping.pcl.raw.id %>%
  mutate(
    pcl.sum_score_retro =
      if_else(condition = na_per_person_pcl_retro > 0,
              true = NA_real_,
              false = pcl.sum_score_retro_raw,
              missing = NA_real_
      )
  )

coping.pcl.raw.id %>%
  descr(pcl.sum_score_retro_raw, stats = "common")

coping.pcl.raw.id %>%
  descr(pcl.sum_score_retro, stats = "common")
```


## Inspection
```{r coping glad pcl head}
head(coping.pcl.raw.id)
```

```{r coping glad pcl summary}
summarytools::dfSummary(
  coping.pcl.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# COPING: PHQ

## GLAD
```{r coping glad phq cols}
if(GLAD == TRUE) {
coping.glad.phq.raw <- readRDS(file = paste0(data.raw_path, "/glad/phq_coping_glad.rds"))
dim(coping.glad.phq.raw)
colnames(coping.glad.phq.raw)
}
```

```{r coping glad phq summary labels}
if(GLAD == TRUE) {
summarytools::dfSummary(
  coping.glad.phq.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```


Will need to double check these namings once we have the new cleaned data -- KT. 
```{r coping glad phq cleaning}
if(GLAD == TRUE) {
coping.glad.phq.raw.id <- coping.glad.phq.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)
         ) %>%
  select(
    Sample, # Sample
    ID, # ID
    phq.problems_made_difficult_care,
    phq.pandemic_felt_feelings,
    phq.little_interest_or_pleasure_in_doing_things_retro = phq.little_interest_or_pleasure_in_doing_things,
    phq.feeling_down_depressed_or_hopeless_retro = phq.feeling_down_depressed_or_hopeless,
    phq.staying_asleep_sleeping_trouble_retro = phq.staying_asleep_sleeping_trouble,
    phq.feeling_tired_or_having_little_energy_retro = phq.feeling_tired_or_having_little_energy,
    phq.poor_appetite_or_overeating_retro = phq.poor_appetite_or_overeating,
    phq.feeling_bad_failure_family_retro = phq.feeling_bad_failure_family,
    phq.trouble_concentrating_reading_newspaper_retro = phq.trouble_concentrating_newspaper_reading, # differ GLAD prepandemic
    phq.moving_fidgety_noticed_opposite_retro = phq.moving_fidgety_opposite_slowly, # differ GLAD prepandemic
    phq.dead_hurting_thoughts_retro = phq.dead_hurting_thoughts,
    phq.little_interest_or_pleasure_in_doing_things_base = phq.little_interest_or_pleasure_in_doing_things.1,
    phq.feeling_down_depressed_or_hopeless_base = phq.feeling_down_depressed_or_hopeless.1,
    phq.staying_asleep_sleeping_trouble_base = phq.staying_asleep_sleeping_trouble.1,
    phq.feeling_tired_or_having_little_energy_base = phq.feeling_tired_or_having_little_energy.1,
    phq.poor_appetite_or_overeating_base = phq.poor_appetite_or_overeating.1,
    phq.feeling_bad_failure_family_base = phq.feeling_bad_failure_family.1,
    phq.trouble_concentrating_reading_newspaper_base = phq.trouble_concentrating_newspaper_reading.1, # differ GLAD prepandemic
    phq.moving_fidgety_noticed_opposite_base = phq.moving_fidgety_opposite_slowly.1, # differ GLAD prepandemic
    phq.dead_hurting_thoughts_base = phq.dead_hurting_thoughts.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.glad.phq.raw.id)
# Inspect colnames
colnames(coping.glad.phq.raw.id)
#Differences
dim(coping.glad.phq.raw)[1]-dim(coping.glad.phq.raw.id)[1]
}
```

```{r coping glad gad copy}
if(GLAD == TRUE) {
  coping.phq.raw.id <- coping.glad.phq.raw.id
}
```

## EDGI
```{r coping edgi phq cols}
if(EDGI == TRUE) {
coping.edgi.phq.raw <- readRDS(file = paste0(data.raw_path, "/edgi/phq_coping_edgi.rds"))
dim(coping.edgi.phq.raw)
colnames(coping.edgi.phq.raw)
}
```

```{r coping edgi phq summary labels}
if(EDGI == TRUE) {
summarytools::dfSummary(
  coping.edgi.phq.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```


```{r coping edgi phq cleaning}
if(EDGI == TRUE) {
coping.edgi.phq.raw.id <- coping.edgi.phq.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)
  ) %>%
  select(
    Sample, # Sample
    ID, # ID
    phq.problems_made_difficult_care = phq.care_difficult_home_things,
    phq.pandemic_felt_feelings = phq.pandemic_feelings_felt,
    phq.little_interest_or_pleasure_in_doing_things_retro = phq.little_interest_or_pleasure_in_doing_things,
    phq.feeling_down_depressed_or_hopeless_retro = phq.feeling_down_depressed_or_hopeless,
    phq.staying_asleep_sleeping_trouble_retro = phq.staying_asleep_sleeping_trouble,
    phq.feeling_tired_or_having_little_energy_retro = phq.feeling_tired_or_having_little_energy,
    phq.poor_appetite_or_overeating_retro = phq.poor_appetite_or_overeating,
    phq.feeling_bad_failure_family_retro = phq.family_feeling_bad_failure, # differ GLAD phq.feeling_bad_failure_family,
    phq.trouble_concentrating_reading_newspaper_retro = phq.trouble_concentrating_newspaper_reading, # differ EDGI prepandemic
    phq.moving_fidgety_noticed_opposite_retro = phq.moving_fidgety_opposite_slowly, # differ EDGI prepandemic
    phq.dead_hurting_thoughts_retro = phq.dead_hurting_thoughts,
    phq.little_interest_or_pleasure_in_doing_things_base = phq.little_interest_or_pleasure_in_doing_things.1,
    phq.feeling_down_depressed_or_hopeless_base = phq.feeling_down_depressed_or_hopeless.1,
    phq.staying_asleep_sleeping_trouble_base = phq.staying_asleep_sleeping_trouble.1,
    phq.feeling_tired_or_having_little_energy_base = phq.feeling_tired_or_having_little_energy.1,
    phq.poor_appetite_or_overeating_base = phq.poor_appetite_or_overeating.1,
    phq.feeling_bad_failure_family_base = phq.family_feeling_bad_failure.1, # differ GLAD
    phq.trouble_concentrating_reading_newspaper_base = phq.trouble_concentrating_newspaper_reading.1, # differ EDGI prepandemic
    phq.moving_fidgety_noticed_opposite_base = phq.moving_fidgety_opposite_slowly.1, # differ EDGI prepandemic
    phq.dead_hurting_thoughts_base = phq.dead_hurting_thoughts.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.edgi.phq.raw.id)
# Inspect colnames
colnames(coping.edgi.phq.raw.id)
#Differences
dim(coping.edgi.phq.raw)[1]-dim(coping.edgi.phq.raw.id)[1]
}
```

```{r coping edgi gad copy}
if(EDGI == TRUE) {
  coping.phq.raw.id <- coping.edgi.phq.raw.id
}
```

## NBR
```{r coping nbr phq cols}
if(NBR == TRUE) {
coping.nbr.phq.raw <- readRDS(file = paste0(data.raw_path, "/nbr/phq_coping_nbr.rds"))
dim(coping.nbr.phq.raw)
colnames(coping.nbr.phq.raw)
}
```

```{r coping nbr phq summary labels}
if(NBR == TRUE) {
summarytools::dfSummary(
  coping.nbr.phq.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```


Will need to double check these namings once we have the new cleaned data -- KT. 
```{r coping nbr phq cleaning}
if(NBR == TRUE) {
coping.nbr.phq.raw.id <- coping.nbr.phq.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    phq.problems_made_difficult_care = phq.problems_made_care_difficult,
    phq.pandemic_felt_feelings,
    phq.little_interest_or_pleasure_in_doing_things_retro = phq.little_interest_or_pleasure_in_doing_things,
    phq.feeling_down_depressed_or_hopeless_retro = phq.feeling_down_depressed_or_hopeless,
    phq.staying_asleep_sleeping_trouble_retro = phq.staying_asleep_sleeping_trouble,
    phq.feeling_tired_or_having_little_energy_retro = phq.feeling_tired_or_having_little_energy,
    phq.poor_appetite_or_overeating_retro = phq.poor_appetite_or_overeating,
    phq.feeling_bad_failure_family_retro = phq.family_feeling_bad_failure,
    phq.trouble_concentrating_reading_newspaper_retro = phq.trouble_concentrating_newspaper_reading, # differ NBR prepandemic
    phq.moving_fidgety_noticed_opposite_retro = phq.moving_fidgety_opposite_slowly, # differ NBR prepandemic
    phq.dead_hurting_thoughts_retro = phq.dead_hurting_thoughts,
    phq.little_interest_or_pleasure_in_doing_things_base = phq.little_interest_or_pleasure_in_doing_things.1,
    phq.feeling_down_depressed_or_hopeless_base = phq.feeling_down_depressed_or_hopeless.1,
    phq.staying_asleep_sleeping_trouble_base = phq.staying_asleep_sleeping_trouble.1,
    phq.feeling_tired_or_having_little_energy_base = phq.feeling_tired_or_having_little_energy.1,
    phq.poor_appetite_or_overeating_base = phq.poor_appetite_or_overeating.1,
    phq.feeling_bad_failure_family_base = phq.family_feeling_bad_failure.1,
    phq.trouble_concentrating_reading_newspaper_base = phq.trouble_concentrating_newspaper_reading.1, # differ NBR prepandemic
    phq.moving_fidgety_noticed_opposite_base = phq.moving_fidgety_opposite_slowly.1, # differ NBR prepandemic
    phq.dead_hurting_thoughts_base = phq.dead_hurting_thoughts.1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.nbr.phq.raw.id)
# Inspect colnames
colnames(coping.nbr.phq.raw.id)
#Differences
dim(coping.nbr.phq.raw)[1]-dim(coping.nbr.phq.raw.id)[1]
}
```

```{r coping nbr gad copy}
if(NBR == TRUE) {
  coping.phq.raw.id <- coping.nbr.phq.raw.id
}
```

## RAMP
```{r coping ramp phq cols}
if(RAMP == TRUE) {
ramp.phq.raw <- readRDS(file = paste0(data.raw_path, "/ramp/phq_ramp.rds"))
dim(ramp.phq.raw)
colnames(ramp.phq.raw)
}
```

```{r coping ramp phq summary labels}
if(RAMP == TRUE) {
summarytools::dfSummary(
  ramp.phq.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```


Will need to double check these namings once we have the new cleaned data -- KT. 
```{r coping ramp phq cleaning}
if(RAMP == TRUE) {
ramp.phq.raw.id <- ramp.phq.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)
  ) %>%
  select(
    Sample, # Sample
    ID, # ID
    phq.problems_made_difficult_care = phq.issues_made_carrying_daily, #impact
    phq.pandemic_felt_feelings = phq.feelings_pandemic_felt, #before the pandemic question
    phq.little_interest_or_pleasure_in_doing_things_retro = phq.little_interest_or_pleasure_in_doing_things.1,
    phq.feeling_down_depressed_or_hopeless_retro = phq.feeling_down_depression_or_hopeless, #THIS IS CORRECT - strange naming in raw dataset
    phq.staying_asleep_sleeping_trouble_retro = phq.staying_asleep_sleeping_trouble.1,
    phq.feeling_tired_or_having_little_energy_retro = phq.feeling_tired_or_having_little_energy.1,
    phq.poor_appetite_or_overeating_retro = phq.poor_appetite_or_overeating.1,
    phq.feeling_bad_failure_family_retro = phq.failure_family_feeling_bad.1,
    phq.trouble_concentrating_reading_newspaper_retro = phq.trouble_concentrating_newspaper_reading.1, 
    phq.moving_fidgety_noticed_opposite_retro = phq.moving_fidgety_opposite_slowly.1, 
    phq.dead_hurting_thoughts_retro = phq.dead_hurting_thoughts.1,
    phq.little_interest_or_pleasure_in_doing_things_base = phq.little_interest_or_pleasure_in_doing_things,
    phq.feeling_down_depressed_or_hopeless_base = phq.feeling_down_depressed_or_hopeless,
    phq.staying_asleep_sleeping_trouble_base = phq.staying_asleep_sleeping_trouble,
    phq.feeling_tired_or_having_little_energy_base = phq.feeling_tired_or_having_little_energy,
    phq.poor_appetite_or_overeating_base = phq.poor_appetite_or_overeating,
    phq.feeling_bad_failure_family_base = phq.failure_family_feeling_bad,
    phq.trouble_concentrating_reading_newspaper_base = phq.trouble_concentrating_newspaper_reading, # differ RAMP prepandemic
    phq.moving_fidgety_noticed_opposite_base = phq.moving_fidgety_opposite_slowly, # differ RAMP prepandemic
    phq.dead_hurting_thoughts_base = phq.dead_hurting_thoughts
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ramp.phq.raw.id)
# Inspect colnames
colnames(ramp.phq.raw.id)
#Differences
dim(ramp.phq.raw)[1]-dim(ramp.phq.raw.id)[1]
}
```

```{r coping ramp gad copy}
if(RAMP == TRUE) {
  coping.phq.raw.id <- ramp.phq.raw.id
}
```

## Sum scores

Calculate sum score for PHQ-9 retro
```{r coping phq sum score retro}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
phq.items_key_retro <- c(1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in total score
phq.items_retro <- c(
  "phq.little_interest_or_pleasure_in_doing_things_retro_numeric",
"phq.feeling_down_depressed_or_hopeless_retro_numeric",
"phq.staying_asleep_sleeping_trouble_retro_numeric",
"phq.feeling_tired_or_having_little_energy_retro_numeric",
"phq.poor_appetite_or_overeating_retro_numeric",
"phq.feeling_bad_failure_family_retro_numeric",
"phq.trouble_concentrating_reading_newspaper_retro_numeric",
"phq.moving_fidgety_noticed_opposite_retro_numeric",
"phq.dead_hurting_thoughts_retro_numeric"
)

# Calculate total score
phq.scored_items_retro <- scoreItems(keys = phq.items_key_retro,
                                     items = coping.phq.raw.id[phq.items_retro],
                                     totals = TRUE, 
                                     missing = TRUE, 
                                     impute = 'none', 
                                     min = 0, 
                                     max = 3)
# Add in column to tibble
coping.phq.raw.id$phq.sum_score_retro_raw <- phq.scored_items_retro$scores

# Look at values
coping.phq.raw.id %>%
  descr(phq.sum_score_retro_raw,
        stats = "common"
  )
```

Calculate sum score for PHQ-9 base
```{r coping phq sum score base}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
phq.items_key_base <- c(1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in total score
phq.items_base <- c(
  "phq.little_interest_or_pleasure_in_doing_things_base_numeric",
"phq.feeling_down_depressed_or_hopeless_base_numeric",
"phq.staying_asleep_sleeping_trouble_base_numeric",
"phq.feeling_tired_or_having_little_energy_base_numeric",
"phq.poor_appetite_or_overeating_base_numeric",
"phq.feeling_bad_failure_family_base_numeric",
"phq.trouble_concentrating_reading_newspaper_base_numeric",
"phq.moving_fidgety_noticed_opposite_base_numeric",
"phq.dead_hurting_thoughts_base_numeric"
)

# Calculate total score
phq.scored_items_base <- scoreItems(keys = phq.items_key_base,
                                    items = coping.phq.raw.id[phq.items_base],
                                    totals = TRUE, 
                                    missing = TRUE, 
                                    impute = 'none', 
                                    min = 0, 
                                    max = 3)
# Add in column to tibble
coping.phq.raw.id$phq.sum_score_base_raw <- phq.scored_items_base$scores

# Look at values
coping.phq.raw.id %>%
  descr(phq.sum_score_base_raw,
        stats = "common"
  )
```


# Missingness

retrospective
```{r coping phq retro missingness}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    na_per_person_phq_retro =         # variable for NA per person
      rowSums(
        is.na(.[phq.items_retro])
      )
  )

coping.phq.raw.id %>%
  freq(na_per_person_phq_retro, cumul = F) #have a look at the frequency
```


```{r coping phq retro missingness 8 items}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.missing_only_suicide_item_retro = 
      if_else(
        condition = na_per_person_phq_retro == 1 & 
          is.na(phq.dead_hurting_thoughts_retro_numeric), 
        true = 1,
        false = 0,
        missing = NA_real_
      )
  )

coping.phq.raw.id %>%
  freq(phq.missing_only_suicide_item_retro,
       cumul = F)
```


baseline
```{r coping phq base missingness}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    na_per_person_phq_base =         # variable for NA per person
      rowSums(                       
        is.na(.[phq.items_base])
      )
  )

coping.phq.raw.id %>%
  freq(na_per_person_phq_base, cumul = F) #have a look at the frequency
```


We need to identify those who have all items APART from the suicide ideation item - to still include these individuals. 
```{r coping phq base missingness 8 items}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.missing_only_suicide_item_base = 
      if_else(
        condition = na_per_person_phq_base == 1 & 
          is.na(phq.dead_hurting_thoughts_base_numeric), 
        true = 1,
        false = 0,
        missing = NA_real_
      )
  )

coping.phq.raw.id %>%
  freq(phq.missing_only_suicide_item_base,
       cumul = F)
```


```{r coping phq base sum score if missing items set to NA}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.sum_score_base =
      if_else(condition = na_per_person_phq_base > 0,
              true = NA_real_,
              false = phq.sum_score_base_raw,
              missing = NA_real_
      )
  )

coping.phq.raw.id %>%
  descr(phq.sum_score_base_raw, stats = "common")

coping.phq.raw.id %>%
  descr(phq.sum_score_base, stats = "common")
```

8 items
```{r phq base sum score if missing items set to NA - 8 items}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.sum_score_8items_base =
      if_else(condition = na_per_person_phq_base > 1 &
                phq.missing_only_suicide_item_base == 1,
              true = NA_real_,
              false = phq.sum_score_base_raw,
              missing = NA_real_
      )
  )

coping.phq.raw.id %>%
  descr(phq.sum_score_8items_base, stats = "common")
```


```{r coping phq retro sum score if missing items set to NA}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.sum_score_retro =
      if_else(condition = na_per_person_phq_retro > 0,
              true = NA_real_,
              false = phq.sum_score_retro_raw,
              missing = NA_real_
      )
  )

coping.phq.raw.id %>%
  descr(phq.sum_score_retro_raw, stats = "common")

coping.phq.raw.id %>%
  descr(phq.sum_score_retro, stats = "common")
```

8 items
```{r phq retro sum score if missing items set to NA - 8 items}
coping.phq.raw.id <- coping.phq.raw.id %>%
  mutate(
    phq.sum_score_8items_retro =
      if_else(condition = na_per_person_phq_retro > 1 &
                phq.missing_only_suicide_item_retro == 1,
              true = NA_real_,
              false = phq.sum_score_retro_raw,
              missing = NA_real_
      )
  )


coping.phq.raw.id %>%
  descr(phq.sum_score_8items_retro, stats = "common")
```

## Inspection

```{r coping glad phq head}
head(coping.phq.raw.id)
```

```{r coping glad phq summary}
summarytools::dfSummary(
  coping.phq.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# COPING: OCI-R

## GLAD
```{r coping glad ocir cols}
if(GLAD == TRUE) {
coping.glad.ocir.raw <- readRDS(file = paste0(data.raw_path, "/glad/ocir_coping_glad.rds"))
dim(coping.glad.ocir.raw)
colnames(coping.glad.ocir.raw)
}
```

```{r coping glad ocir summary labels}
if(GLAD == TRUE) {
summarytools::dfSummary(
  coping.glad.ocir.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```

*Note that the COPING GLAD OCI-R ID numbers are stored under recipientFirstName (rather than ExternalDataReference)
```{r coping glad ocir cleaning}
if(GLAD == TRUE) {
  
  
  
coping.glad.ocir.raw.id <- coping.glad.ocir.raw %>%
  drop_na(recipientFirstName) %>% # Drop NAs
  distinct(recipientFirstName, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(recipientFirstName, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    ocir.felt_pandemic_feelings, # Comparison to before the pandemic
    ocir.i_repeatedly_check_doors_windows_drawers_etc_retro = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
    ocir.arranged_things_change_upset_retro = ocir.arranged_things_change_upset,
    ocir.repeat_feel_numbers_retro = ocir.numbers_repeat_feel, ## Different from GLAD prepandemic
    ocir.clean_simply_wash_feel_retro = ocir.feel_contaminated_clean_simply, ## Different from GLAD prepandemic
    ocir.mind_upset_unpleasant_thoughts_retro = ocir.mind_upset_unpleasant_thoughts,
    ocir.afraid_avoid_throwing_things_retro = ocir.afraid_avoid_throwing_things,
    ocir.light_switches_water_taps_retro = ocir.light_switches_water_taps,
    ocir.arranged_things_retro = ocir.arranged_things,
    ocir.good_feel_bad_numbers_retro = ocir.bad_numbers_good_feel, ## Different from GLAD prepandemic
    ocir.hands_longer_wash_retro = ocir.longer_hands_wash, ## Different from GLAD prepandemic
    ocir.saved_things_retro = ocir.saved_things,
    ocir.frequently_difficulty_rid_nasty_retro = ocir.frequently_rid_difficulty_nasty, ## Different from GLAD prepandemic
    ocir.i_check_things_more_often_than_necessary_retro = ocir.i_check_things_more_often_than_necessary.,
    ocir.arranged_properly_objects_upset_retro = ocir.arranged_properly_objects_upset,
    ocir.feel_compelled_count_things_retro = ocir.feel_compelled_count_things,
    ocir.strangers_touch_touched_difficult_retro = ocir.strangers_touch_touched_object, ## Different from GLAD prepandemic
    ocir.control_difficult_find_thoughts_retro = ocir.control_find_difficult_thoughts, ## Different from GLAD prepandemic
    ocir.i_collect_things_i_dont_need_retro = ocir.i_collect_things_i_dont_need., ## Different from GLAD prepandemic
    ocir.i_repeatedly_check_doors_windows_drawers_etc_base = ocir.i_repeatedly_check_doors_windows_drawers_etc..1,
    ocir.arranged_things_change_upset_base = ocir.arranged_things_change_upset.1,
    ocir.repeat_feel_numbers_base = ocir.numbers_repeat_feel.1, ## Different from GLAD prepandemic
    ocir.clean_simply_wash_feel_base = ocir.feel_contaminated_clean_simply.1, ## Different from GLAD prepandemic
    ocir.mind_upset_unpleasant_thoughts_base = ocir.mind_upset_unpleasant_thoughts.1,
    ocir.afraid_avoid_throwing_things_base = ocir.afraid_avoid_throwing_things.1,
    ocir.light_switches_water_taps_base = ocir.light_switches_water_taps.1,
    ocir.arranged_things_base = ocir.arranged_things.1,
    ocir.good_feel_bad_numbers_base = ocir.bad_numbers_good_feel.1, ## Different from GLAD prepandemic
    ocir.hands_longer_wash_base = ocir.longer_hands_wash.1, ## Different from GLAD prepandemic
    ocir.saved_things_base = ocir.saved_things.1,
    ocir.frequently_difficulty_rid_nasty_base = ocir.frequently_rid_difficulty_nasty.1, ## Different from GLAD prepandemic
    ocir.i_check_things_more_often_than_necessary_base = ocir.i_check_things_more_often_than_necessary..1,
    ocir.arranged_properly_objects_upset_base = ocir.arranged_properly_objects_upset.1,
    ocir.feel_compelled_count_things_base = ocir.feel_compelled_count_things.1,
    ocir.strangers_touch_touched_difficult_base = ocir.strangers_touch_touched_object.1, ## Different from GLAD prepandemic
    ocir.control_difficult_find_thoughts_base = ocir.control_find_difficult_thoughts.1, ## Different from GLAD prepandemic
    ocir.i_collect_things_i_dont_need_base = ocir.i_collect_things_i_dont_need..1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.glad.ocir.raw.id)
# Inspect colnames
colnames(coping.glad.ocir.raw.id)
#Differences
dim(coping.glad.ocir.raw)[1]-dim(coping.glad.ocir.raw.id)[1]
}
```

```{r coping glad ocir copy}
if(GLAD == TRUE) {
  coping.ocir.raw.id <- coping.glad.ocir.raw.id
}
```

## EDGI
```{r coping edgi ocir cols}
if(EDGI == TRUE) {
coping.edgi.ocir.raw <- readRDS(file = paste0(data.raw_path, "/edgi/ocir_coping_edgi.rds"))
dim(coping.edgi.ocir.raw)
colnames(coping.edgi.ocir.raw)
}
```

```{r coping edgi ocir summary labels}
if(EDGI == TRUE) {
summarytools::dfSummary(
  coping.edgi.ocir.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```

*Note that the COPING EDGI OCI-R ID numbers are stored under recipientFirstName (rather than ExternalDataReference)
```{r coping edgi ocir cleaning}
exclude_cols_coping_edgi_ocir <- c(
  "COPING_Sample",
  "COPING_ID")

if(EDGI == TRUE) {
coping.edgi.ocir.raw.id <- coping.edgi.ocir.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
#  separate(externalDataReference, into = c("COPING_Sample", "COPING_ID"), sep = 6) %>% # Split ID in Sample and Number
#  mutate(COPING_ID = as.numeric(COPING_ID)) %>%
  select(
#    Sample, # Sample
    COPING_ID = externalDataReference, # ID
    ocir.felt_pandemic_feelings, # Comparison to before the pandemic
    ocir.i_repeatedly_check_doors_windows_drawers_etc_retro = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
    ocir.arranged_things_change_upset_retro = ocir.arranged_things_change_upset,
    ocir.repeat_feel_numbers_retro = ocir.repeat_numbers_feel, # Different from EDGI prepandemic ocir.numbers_repeat_feel,
    ocir.clean_simply_wash_feel_retro = ocir.feel_contaminated_clean_simply, ## Different from EDGI prepandemic
    ocir.mind_upset_unpleasant_thoughts_retro = ocir.mind_upset_unpleasant_thoughts,
    ocir.afraid_avoid_throwing_things_retro = ocir.afraid_avoid_throwing_things,
    ocir.light_switches_water_taps_retro = ocir.water_taps_light_switches, #  differ ocir.light_switches_water_taps,
    ocir.arranged_things_retro = ocir.arranged_things,
    ocir.good_feel_bad_numbers_retro = ocir.bad_numbers_good_feel, ## Different from EDGI prepandemic
    ocir.hands_longer_wash_retro = ocir.longer_hands_wash, ## Different from EDGI prepandemic
    ocir.saved_things_retro = ocir.saved_things,
    ocir.frequently_difficulty_rid_nasty_retro = ocir.frequently_rid_difficulty_nasty, ## Different from EDGI prepandemic
    ocir.i_check_things_more_often_than_necessary_retro = ocir.i_check_things_more_often_than_necessary.,
    ocir.arranged_properly_objects_upset_retro = ocir.arranged_properly_objects_upset,
    ocir.feel_compelled_count_things_retro = ocir.feel_compelled_count_things,
    ocir.strangers_touch_touched_difficult_retro = ocir.strangers_touch_touched_object, ## Different from EDGI prepandemic
    ocir.control_difficult_find_thoughts_retro = ocir.control_difficult_thoughts_find, # Differ to EDGI prepan ocir.control_find_difficult_thoughts,
    ocir.i_collect_things_i_dont_need_retro = ocir.i_collect_things_i_dont_need., ## Different from EDGI prepandemic
    ocir.i_repeatedly_check_doors_windows_drawers_etc_base = ocir.i_repeatedly_check_doors_windows_drawers_etc..1,
    ocir.arranged_things_change_upset_base = ocir.arranged_things_change_upset.1,
    ocir.repeat_feel_numbers_base = ocir.repeat_numbers_feel.1, ## Different from EDGI prepandemic
    ocir.clean_simply_wash_feel_base = ocir.feel_contaminated_clean_simply.1, ## Different from EDGI prepandemic
    ocir.mind_upset_unpleasant_thoughts_base = ocir.mind_upset_unpleasant_thoughts.1,
    ocir.afraid_avoid_throwing_things_base = ocir.afraid_avoid_throwing_things.1,
    ocir.light_switches_water_taps_base = ocir.water_taps_light_switches.1, # differ
    ocir.arranged_things_base = ocir.arranged_things.1,
    ocir.good_feel_bad_numbers_base = ocir.bad_numbers_good_feel.1, ## Different from EDGI prepandemic
    ocir.hands_longer_wash_base = ocir.longer_hands_wash.1, ## Different from EDGI prepandemic
    ocir.saved_things_base = ocir.saved_things.1,
    ocir.frequently_difficulty_rid_nasty_base = ocir.frequently_rid_difficulty_nasty.1, ## Different from EDGI prepandemic
    ocir.i_check_things_more_often_than_necessary_base = ocir.i_check_things_more_often_than_necessary..1,
    ocir.arranged_properly_objects_upset_base = ocir.arranged_properly_objects_upset.1,
    ocir.feel_compelled_count_things_base = ocir.feel_compelled_count_things.1,
    ocir.strangers_touch_touched_difficult_base = ocir.strangers_touch_touched_object.1, ## Different from EDGI prepandemic
    ocir.control_difficult_find_thoughts_base = ocir.control_difficult_thoughts_find.1, ## Different from EDGI prepandemic
    ocir.i_collect_things_i_dont_need_base = ocir.i_collect_things_i_dont_need..1
  ) %>%
  add_numeric(., exclude = exclude_cols_coping_edgi_ocir) %>%
  add_column(Sample = "EDGI") %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.edgi.ocir.raw.id)
# Inspect colnames
colnames(coping.edgi.ocir.raw.id)
#Differences
dim(coping.edgi.ocir.raw)[1]-dim(coping.edgi.ocir.raw.id)[1]
}
```

```{r coping edgi ocir copy}
if(EDGI == TRUE) {
  coping.ocir.raw.id <- coping.edgi.ocir.raw.id
}
```

## NBR
```{r coping nbr ocir cols}
if(NBR == TRUE) {
coping.nbr.ocir.raw <- readRDS(file = paste0(data.raw_path, "/nbr/ocir_coping_nbr.rds"))
dim(coping.nbr.ocir.raw)
colnames(coping.nbr.ocir.raw)
}
```

```{r coping nbr ocir summary labels}
if(NBR == TRUE) {
summarytools::dfSummary(
  coping.nbr.ocir.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```

*Note that the COPING NBR OCI-R ID numbers are stored under recipientFirstName (rather than ExternalDataReference)

++MD: One NBR ID is being converted to NA by the as.numeric(ID) line of code.
```{r coping nbr ocir cleaning}
if(NBR == TRUE) {
coping.nbr.ocir.raw.id <- coping.nbr.ocir.raw %>%
  drop_na(recipientFirstName) %>% # Drop NAs
  distinct(recipientFirstName, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(recipientFirstName, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    ocir.felt_pandemic_feelings, # Comparison to before the pandemic
    ocir.i_repeatedly_check_doors_windows_drawers_etc_retro = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
    ocir.arranged_things_change_upset_retro = ocir.arranged_things_change_upset,
    ocir.repeat_feel_numbers_retro = ocir.repeat_numbers_feel, ## Different from GLAD
    ocir.clean_simply_wash_feel_retro = ocir.feel_contaminated_clean_simply,
    ocir.mind_upset_unpleasant_thoughts_retro = ocir.mind_upset_unpleasant_thoughts,
    ocir.afraid_avoid_throwing_things_retro = ocir.afraid_avoid_throwing_things,
    ocir.light_switches_water_taps_retro = ocir.water_taps_light_switches, ## Different from GLAD
    ocir.arranged_things_retro = ocir.arranged_things,
    ocir.good_feel_bad_numbers_retro = ocir.bad_numbers_good_feel,
    ocir.hands_longer_wash_retro = ocir.longer_hands_wash, 
    ocir.saved_things_retro = ocir.saved_things,
    ocir.frequently_difficulty_rid_nasty_retro = ocir.frequently_rid_difficulty_nasty, 
    ocir.i_check_things_more_often_than_necessary_retro = ocir.i_check_things_more_often_than_necessary.,
    ocir.arranged_properly_objects_upset_retro = ocir.arranged_properly_objects_upset,
    ocir.feel_compelled_count_things_retro = ocir.feel_compelled_count_things,
    ocir.strangers_touch_touched_difficult_retro = ocir.strangers_touch_touched_object, 
    ocir.control_difficult_find_thoughts_retro = ocir.control_difficult_thoughts_find, ## Different from GLAD 
    ocir.i_collect_things_i_dont_need_retro = ocir.i_collect_things_i_dont_need., 
    ocir.i_repeatedly_check_doors_windows_drawers_etc_base = ocir.i_repeatedly_check_doors_windows_drawers_etc..1,
    ocir.arranged_things_change_upset_base = ocir.arranged_things_change_upset.1,
    ocir.repeat_feel_numbers_base = ocir.repeat_numbers_feel.1, ## Different from GLAD
    ocir.clean_simply_wash_feel_base = ocir.feel_contaminated_clean_simply.1,
    ocir.mind_upset_unpleasant_thoughts_base = ocir.mind_upset_unpleasant_thoughts.1,
    ocir.afraid_avoid_throwing_things_base = ocir.afraid_avoid_throwing_things.1,
    ocir.light_switches_water_taps_base = ocir.water_taps_light_switches.1, ## Different from GLAD
    ocir.arranged_things_base = ocir.arranged_things.1,
    ocir.good_feel_bad_numbers_base = ocir.bad_numbers_good_feel.1, 
    ocir.hands_longer_wash_base = ocir.longer_hands_wash.1, 
    ocir.saved_things_base = ocir.saved_things.1,
    ocir.frequently_difficulty_rid_nasty_base = ocir.frequently_rid_difficulty_nasty.1, 
    ocir.i_check_things_more_often_than_necessary_base = ocir.i_check_things_more_often_than_necessary..1,
    ocir.arranged_properly_objects_upset_base = ocir.arranged_properly_objects_upset.1,
    ocir.feel_compelled_count_things_base = ocir.feel_compelled_count_things.1,
    ocir.strangers_touch_touched_difficult_base = ocir.strangers_touch_touched_object.1, 
    ocir.control_difficult_find_thoughts_base = ocir.control_difficult_thoughts_find.1,
    ocir.i_collect_things_i_dont_need_base = ocir.i_collect_things_i_dont_need..1
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.nbr.ocir.raw.id)
# Inspect colnames
colnames(coping.nbr.ocir.raw.id)
#Differences
dim(coping.nbr.ocir.raw)[1]-dim(coping.nbr.ocir.raw.id)[1]
}
```

```{r coping nbr ocir copy}
if(NBR == TRUE) {
  coping.ocir.raw.id <- coping.nbr.ocir.raw.id
}
```

## RAMP
```{r coping ramp ocir cols}
if(RAMP == TRUE) {
ramp.ocir.raw <- readRDS(file = paste0(data.raw_path, "/ramp/ocir_ramp.rds"))
dim(ramp.ocir.raw)
colnames(ramp.ocir.raw)
}
```

```{r coping ramp ocir summary labels}
if(RAMP == TRUE) {
summarytools::dfSummary(
  ramp.ocir.raw,
  graph.col = F,
  valid.col = F
  #labels.col = F
)
}
```

*Note that the COPING RAMP OCI-R ID numbers are stored under recipientFirstName (rather than ExternalDataReference)
```{r coping ramp ocir cleaning}
if(RAMP == TRUE) {
ramp.ocir.raw.id <- ramp.ocir.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    ocir.felt_pandemic_feelings = ocir.feelings_pandemic_felt, # Comparison to before the pandemic
    ocir.saved_things_retro = ocir.saved_things.1, #reordered items to reflect questionnaire
    ocir.i_check_things_more_often_than_necessary_retro = ocir.i_check_things_more_often_than_necessary..1, #in RAMP .1 = retrospective
    ocir.arranged_properly_objects_upset_retro = ocir.arranged_properly_objects_upset.1,
    ocir.feel_compelled_count_things_retro = ocir.feel_compelled_count_things.1,
    ocir.strangers_touch_touched_difficult_retro = ocir.touch_touched_strangers_object.1,
    ocir.control_difficult_find_thoughts_retro = ocir.find_control_difficult_thoughts.1,
    ocir.i_collect_things_i_dont_need_retro = ocir.i_collect_things_i_dont_need..1,
    ocir.i_repeatedly_check_doors_windows_drawers_etc_retro = ocir.i_repeatedly_check_doors_windows_drawers_etc..1,
    ocir.arranged_things_change_upset_retro = ocir.arranged_things_change_upset.1,
    ocir.repeat_feel_numbers_retro = ocir.numbers_repeat_feel.1, 
    ocir.clean_simply_wash_feel_retro = ocir.feel_contaminated_clean_simply.1, 
    ocir.mind_upset_unpleasant_thoughts_retro = ocir.unpleasant_thoughts_mind_upset.1,
    ocir.afraid_avoid_throwing_things_retro = ocir.afraid_avoid_throwing_things.1,
    ocir.light_switches_water_taps_retro = ocir.repeatedly_check_gas_water.1,
    ocir.arranged_things_retro = ocir.arranged_things.1,
    ocir.good_feel_bad_numbers_retro = ocir.bad_numbers_good_feel.1, 
    ocir.hands_longer_wash_retro = ocir.longer_hands_wash.1, 
    ocir.frequently_difficulty_rid_nasty_retro = ocir.difficulty_rid_frequently_nasty.1, 
    ocir.saved_things_base = ocir.saved_things,
    ocir.i_check_things_more_often_than_necessary_base = ocir.i_check_things_more_often_than_necessary.,
    ocir.arranged_properly_objects_upset_base = ocir.arranged_properly_objects_upset,
    ocir.feel_compelled_count_things_base = ocir.feel_compelled_count_things,
    ocir.strangers_touch_touched_difficult_base = ocir.touch_touched_strangers_object, 
    ocir.control_difficult_find_thoughts_base = ocir.find_control_difficult_thoughts, 
    ocir.i_collect_things_i_dont_need_base = ocir.i_collect_things_i_dont_need.,
    ocir.i_repeatedly_check_doors_windows_drawers_etc_base = ocir.i_repeatedly_check_doors_windows_drawers_etc.,
    ocir.arranged_things_change_upset_base = ocir.arranged_things_change_upset,
    ocir.repeat_feel_numbers_base = ocir.numbers_repeat_feel, 
    ocir.clean_simply_wash_feel_base = ocir.feel_contaminated_clean_simply, 
    ocir.mind_upset_unpleasant_thoughts_base = ocir.unpleasant_thoughts_mind_upset,
    ocir.afraid_avoid_throwing_things_base = ocir.afraid_avoid_throwing_things,
    ocir.light_switches_water_taps_base = ocir.repeatedly_check_gas_water,
    ocir.arranged_things_base = ocir.arranged_things,
    ocir.good_feel_bad_numbers_base = ocir.bad_numbers_good_feel, 
    ocir.hands_longer_wash_base = ocir.longer_hands_wash, 
    ocir.frequently_difficulty_rid_nasty_base = ocir.difficulty_rid_frequently_nasty
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ramp.ocir.raw.id)
# Inspect colnames
colnames(ramp.ocir.raw.id)
#Differences
dim(ramp.ocir.raw)[1]-dim(ramp.ocir.raw.id)[1]
}
```

```{r coping ramp ocir copy}
if(RAMP == TRUE) {
  coping.ocir.raw.id <- ramp.ocir.raw.id
}
```


## Sum scores

Calculate sum score for OCI-R retro
```{r coping ocir sum score retro}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
ocir.items_key_retro <- c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in total score
ocir.items_retro = c(
  "ocir.i_repeatedly_check_doors_windows_drawers_etc_retro",
  "ocir.arranged_things_change_upset_retro",
  "ocir.repeat_feel_numbers_retro",
  "ocir.clean_simply_wash_feel_retro",
  "ocir.mind_upset_unpleasant_thoughts_retro",
  "ocir.afraid_avoid_throwing_things_retro",
  "ocir.light_switches_water_taps_retro",
  "ocir.arranged_things_retro",
  "ocir.good_feel_bad_numbers_retro",
  "ocir.hands_longer_wash_retro",
  "ocir.saved_things_retro",
  "ocir.frequently_difficulty_rid_nasty_retro",
  "ocir.i_check_things_more_often_than_necessary_retro",
  "ocir.arranged_properly_objects_upset_retro",
  "ocir.feel_compelled_count_things_retro",
  "ocir.strangers_touch_touched_difficult_retro",
  "ocir.control_difficult_find_thoughts_retro",
  "ocir.i_collect_things_i_dont_need_retro"
)

# Calculate total score
ocir.scored_items_retro <- scoreItems(keys = ocir.items_key_retro,
                                     items = coping.ocir.raw.id[ocir.items_retro],
                                     totals = TRUE, 
                                     missing = TRUE, 
                                     impute = 'none', 
                                     min = 0, 
                                     max = 4)
# Add in column to tibble
coping.ocir.raw.id$ocir.sum_score_retro_raw <- ocir.scored_items_retro$scores

# Look at values
coping.ocir.raw.id %>%
  descr(ocir.sum_score_retro_raw,
        stats = "common"
  )
```

Calculate sum score for OCI-R base
```{r coping ocir sum score base}
# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
ocir.items_key_base <- c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)

# Create vector with items that are included in total score
ocir.items_base = c(
  "ocir.i_repeatedly_check_doors_windows_drawers_etc_base",
  "ocir.arranged_things_change_upset_base",
  "ocir.repeat_feel_numbers_base",
  "ocir.clean_simply_wash_feel_base",
  "ocir.mind_upset_unpleasant_thoughts_base",
  "ocir.afraid_avoid_throwing_things_base",
  "ocir.light_switches_water_taps_base",
  "ocir.arranged_things_base",
  "ocir.good_feel_bad_numbers_base",
  "ocir.hands_longer_wash_base",
  "ocir.saved_things_base",
  "ocir.frequently_difficulty_rid_nasty_base",
  "ocir.i_check_things_more_often_than_necessary_base",
  "ocir.arranged_properly_objects_upset_base",
  "ocir.feel_compelled_count_things_base",
  "ocir.strangers_touch_touched_difficult_base",
  "ocir.control_difficult_find_thoughts_base",
  "ocir.i_collect_things_i_dont_need_base"
)

# Calculate total score
ocir.scored_items_base <- scoreItems(keys = ocir.items_key_base,
                                    items = coping.ocir.raw.id[ocir.items_base],
                                    totals = TRUE, 
                                    missing = TRUE, 
                                    impute = 'none', 
                                    min = 0, 
                                    max = 4)
# Add in column to tibble
coping.ocir.raw.id$ocir.sum_score_base_raw <- ocir.scored_items_base$scores

# Look at values
coping.ocir.raw.id %>%
  descr(ocir.sum_score_base_raw,
        stats = "common"
  )
```


# Missingness

retrospective
```{r coping ocir retro missingness}
coping.ocir.raw.id <- coping.ocir.raw.id %>%
  mutate(
    na_per_person_ocir_retro =         # variable for NA per person
      rowSums(
        is.na(.[ocir.items_retro])
      )
  )

coping.ocir.raw.id %>%
  freq(na_per_person_ocir_retro, cumul = F) #have a look at the frequency
```


baseline
```{r coping ocir base missingness}
coping.ocir.raw.id <- coping.ocir.raw.id %>%
  mutate(
    na_per_person_ocir_base =         # variable for NA per person
      rowSums(                       
        is.na(.[ocir.items_base])
      )
  )

coping.ocir.raw.id %>%
  freq(na_per_person_ocir_base, cumul = F) #have a look at the frequency
```

```{r coping ocir base sum score if missigng items set to NA}
coping.ocir.raw.id <- coping.ocir.raw.id %>%
  mutate(
    ocir.sum_score_base =
      if_else(condition = na_per_person_ocir_base > 0,
              true = NA_real_,
              false = ocir.sum_score_base_raw,
              missing = NA_real_
      )
  )

coping.ocir.raw.id %>%
  descr(ocir.sum_score_base_raw, stats = "common")

coping.ocir.raw.id %>%
  descr(ocir.sum_score_base, stats = "common")
```

```{r coping ocir retro sum score if missigng items set to NA}
coping.ocir.raw.id <- coping.ocir.raw.id %>%
  mutate(
    ocir.sum_score_retro =
      if_else(condition = na_per_person_ocir_retro > 0,
              true = NA_real_,
              false = ocir.sum_score_retro_raw,
              missing = NA_real_
      )
  )

coping.ocir.raw.id %>%
  descr(ocir.sum_score_retro_raw, stats = "common")

coping.ocir.raw.id %>%
  descr(ocir.sum_score_retro, stats = "common")
```

# Inspection

```{r coping glad ocir head}
head(coping.ocir.raw.id)
```

```{r coping glad ocir summary}
summarytools::dfSummary(
  coping.ocir.raw.id,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# Join tibbles together

```{r edgi employment and coping ocir}
if(EDGI == TRUE){
  dim(employment.raw.id)
  dim(coping.ocir.raw.id)
  
  
edgi.employment.coping.ocir <- left_join(
    x = employment.raw.id,
    y = coping.ocir.raw.id,
    by = c(
      "COPING_ID",
      "Sample")
)
    
    dim(edgi.employment.coping.ocir)
}
```

edgi data frame list
```{r edgi data frame list}
if(EDGI == TRUE) {
dfs.list <- list(
  dem.raw.id,
  edgi.employment.coping.ocir,
  mhd.raw.categories,
  prepan.gad.raw.id,
  prepan.pcl.raw.id,
  prepan.phq.raw.id,
  prepan.ocir.raw.id,
  coping.gad.raw.id,
  coping.pcl.raw.id,
  coping.phq.raw.id
#  coping.ocir.raw.id
)
}
```

glad data frame list
```{r glad/edgi data frame list}
if(GLAD == TRUE) {
dfs.list <- list(
  dem.raw.id,
  employment.raw.id,
  mhd.raw.categories,
  prepan.gad.raw.id,
  prepan.pcl.raw.id,
  prepan.phq.raw.id,
  prepan.ocir.raw.id,
  coping.gad.raw.id,
  coping.pcl.raw.id,
  coping.phq.raw.id,
  coping.ocir.raw.id
)
}
```


Removing all prepandemic dataframes from NBR/RAMP (prepandemic measures don't exist for these cohorts)
```{r nbr/ramp data frame list}
if(NBR == TRUE | RAMP == TRUE) {
dfs.list <- list(
  dem.raw.id,
  employment.raw.id,
  mhd.raw.categories,
  coping.gad.raw.id,
  coping.pcl.raw.id,
  coping.phq.raw.id,
  coping.ocir.raw.id
)
}
```

```{r Join all questionnaires}
dat.raw <- plyr::join_all(
  dfs.list,
  by = c("ID", "Sample") # Alternatively you can join by several columns EDGI -> "Age", "Sex", "Birthyear"
  )

#look at the data
skimr::skim(dat.raw)
```

Check duplicates again to be saved
+++KLP: RAMP: More than one column: Age, Sex, Login ID; if they match on all 3 then we treat them as a duplicate; otherwise we are going to rename the Login ID
+++KT: No duplicates identified by ID in GLAD. 
+++MD: Duplicates have been removed in cleaning script for NBR. No duplicates at this stage.
```{r Check duplicates}
dat.raw$ID.dup <- duplicated(dat.raw$ID)

summary(as.factor(dat.raw$ID.dup))

dat.dup <- dat.raw %>%
  filter(ID.dup == TRUE)

dat.raw.no.dup <- dat.raw %>%
  filter(ID.dup == FALSE)
```

#Exclusion
Exclude those without sex, gender, age and incomplete PHQ/GAD items
Create a new new object for each exclusion step, e.g., data.no_sex, data.no_gender and data.no_sex.no_age
```{r Exclude participants that do not report sex}
if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE){
dim(dat.raw)
dat.no.sex <- dat.raw %>%
  drop_na(Sex)
dim(dat.no.sex)

dim(dat.raw)[1]-dim(dat.no.sex)[1]
}
```
`r dim(dat.glad.raw)[1]-dim(dat.no.sex)[1]` were excluded because they did not report their sex

```{r Rename dataset for ramp}
if(RAMP == TRUE){
#there is no sex variable in ramp
dat.no.sex <- dat.raw
}
```

```{r Exclude participants that do not report gender}
dim(dat.no.sex)
dat.no.sex.no.gender <- dat.no.sex %>%
  drop_na(Gender)
dim(dat.no.sex.no.gender)

dim(dat.no.sex)[1]-dim(dat.no.sex.no.gender)[1]
```
`r dim(dat.no.sex)[1]-dim(dat.no.sex.no.gender)[1]` were excluded because they did not report their sex


```{r Exclude participants that do not report age}
dim(dat.no.sex.no.gender)
dat.no.sex.no.gender.no.age <- dat.no.sex.no.gender %>%
  drop_na(age_category)
dim(dat.no.sex.no.gender.no.age)

dim(dat.no.sex.no.gender)[1]-dim(dat.no.sex.no.gender.no.age)[1]
```
`r dim(dat.no.gender)[1]-dim(dat.no.sex.no.gender.no.age)[1]` were excluded because they did not report their age

Exclusion of inflammatory bowel disease (IBD) and GLAD BioResource (NBR) cohort
++MD: 3,410 participants from NBR IBD cohort excluded
++KT: 3 duplicated GLAD participants are excluded
```{r COVID exclusion of IBD and GLAD from NBR sample}
if(NBR == TRUE) {
dim(dat.no.sex.no.gender.no.age)

dat.no.sex.no.gender.no.age.no.ibd <- dat.no.sex.no.gender.no.age %>%
  filter(Cohort != "IBD") %>%
  filter(Cohort != "GLAD")

dim(dat.no.sex.no.gender.no.age.no.ibd)
dim(dat.no.sex.no.gender.no.age)[1]-dim(dat.no.sex.no.gender.no.age.no.ibd)[1]
}

if(GLAD == TRUE | EDGI == TRUE | RAMP == TRUE) {
dat.no.sex.no.gender.no.age.no.ibd <- dat.no.sex.no.gender.no.age
}
```


##Create tidy data on which the exclusion criteria have been applied
Complete sex, gender, age and missingness information applied. 
```{r Tidy data}
dat <- dat.no.sex.no.gender.no.age.no.ibd

skimr::skim(dat)
```

```{r Investigating RAMP NAs}
dat %>%
  group_by(control) %>%
  count(
    mhd.none_of_the_above.1,
    mhd.none_of_the_above,
    control,
    age_category
  )

dat %>%
  select(contains("none"))


dat %>%
  filter(
    (mhd.none_of_the_above.1 == "Not None of these" |
    mhd.none_of_the_above == "Not None of these") &
      control == "Control"
  )

```







# Definition of prepandemic and baseline 
Exlcude people who have joined GLAD/EDGI after the pandemic began, sensitivity analyses done on the cut off's we have chosen. 
Potentially GLAD/EDGI particiapnts between January to April. EDGI launched on February 24th. 

Prepandemic GLAD/EDGI = Prepandemic (GLAD/EDGI sign-up questionnaire)

Retrospective = COPING/RAMP sign up questionnaire; *only of those participants who have reported a change in symptoms*

Baseline = COPING/RAMP sign up questionnaire

Dates for the definition of prepandemic
```{r Potential dates for prepandemic definition}
# Date of the first COVID-19 case in the United Kingdom (UK)
date_first_case_uk_january_31 <- as.POSIXct("2020-01-31")

# Date for assumed higher awareness of COVID / Lockdown in Italy 4. March 2020 / first festivals cancelled
date_higher_awareness_march_1 <- as.POSIXct("2020-03-01")

# Date the UK went into lockdown
date_uk_lockdown_march_23 <- as.POSIXct("2020-03-23")
```


```{r Prepandemic definitions january_31}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    prepandemic_january_31_numeric =
      if_else(
        startDate.prepandemic > date_first_case_uk_january_31, # The GLAD sign up is dated before the cut off (> longer ago)
        true = 0, # Participant has not signed up before the pandemic,
        false = 1, # Participant has signed up before the pandemic,
        missing = NA_real_
      )
  )

dat <- dat %>%
  mutate(
    prepandemic_january_31 =
      recode_factor(
        prepandemic_january_31_numeric,
        "0" = "Sign up after 31. January",
        "1" = "Sign up before 31. January"
      )
  )

dat %>%
  freq(prepandemic_january_31)
}
```


```{r Prepandemic definitions march_1}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    prepandemic_march_1_numeric =
      if_else(
        startDate.prepandemic > date_higher_awareness_march_1, # The GLAD sign up is dated before the cut off (> longer ago)
        true = 0, # Participant has not signed up before the pandemic,
        false = 1, # Participant has signed up before the pandemic,
        missing = NA_real_
      )
  )

dat <- dat %>%
  mutate(
    prepandemic_march_1 =
      recode_factor(
        prepandemic_march_1_numeric,
        "0" = "Sign up after 1. March",
        "1" = "Sign up before 1. March"
      )
  )

dat %>%
  freq(prepandemic_march_1)
}
```

```{r Prepandemic definitions march_23}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    prepandemic_march_23_numeric =
      if_else(
        startDate.prepandemic > date_uk_lockdown_march_23, # The GLAD sign up is dated before the cut off (> longer ago)
        true = 0, # Participant has not signed up before the pandemic,
        false = 1, # Participant has signed up before the pandemic,
        missing = NA_real_
      )
  )

dat <- dat %>%
  mutate(
    prepandemic_march_23 =
      recode_factor(
        prepandemic_march_23_numeric,
        "0" = "Sign up after 23. March",
        "1" = "Sign up before 23. March"
      )
  )

dat %>%
  freq(prepandemic_march_23)
}
```

Calculate the time difference between starting the COPING questionnaire and the beginning of the pandemic
```{r time difference between starting the COP|NG questionnaire and the beginning of the pandemic}
if(GLAD == TRUE | EDGI == TRUE | RAMP == TRUE | NBR == TRUE){
# using date of pandemic as 23rd of March
dat <- dat %>%
  mutate(
    time_diff_coping_lockdown_march_23 =
        as.numeric(
        difftime(           #this function does time1 - time2 as difftime(time1, time2...)
          startDate.coping,    #should be start date for COPING (time1)
          date_uk_lockdown_march_23),    #should be start date for GLAD (time2)
          units = c("weeks")  #can also be "secs", "mins", "hours", "weeks"
          )
        )

dat %>%
  descr(
    var = time_diff_coping_lockdown_march_23,
    stats = "common"
    )

# using date as 1st of March  
dat <- dat %>%
  mutate(
    time_diff_coping_awareness_march_1 =
        as.numeric(
        difftime(           #this function does time1 - time2 as difftime(time1, time2...)
          startDate.coping,    #should be start date for COPING (time1)
          date_higher_awareness_march_1),    #should be start date for GLAD (time2)
          units = c("weeks")  #can also be "secs", "mins", "hours", "weeks"
          )
        )

dat %>%
  descr(
    var = time_diff_coping_awareness_march_1,
    stats = "common"
    )

# using date as 31st January 

dat <- dat %>%
  mutate(
    time_diff_coping_first_case_uk_jan_31 =
        as.numeric(
        difftime(           #this function does time1 - time2 as difftime(time1, time2...)
          startDate.coping,    #should be start date for COPING (time1)
          date_first_case_uk_january_31),    #should be start date for GLAD (time2)
          units = c("weeks")  #can also be "secs", "mins", "hours", "weeks"
          )
        )

dat %>%
  descr(
    var = time_diff_coping_first_case_uk_jan_31,
    stats = "common"
    )
}
```


Calculate the time difference between sign up questionnaire and COPING questionnaire
```{r time difference between sign up questionnaire and COPING questionnaire}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    time_diff_sign_up_coping =
        as.numeric(
        difftime(           #this function does time1 - time2 as difftime(time1, time2...)
          startDate.coping,    #should be start date for COPING (time1)
          startDate.prepandemic),    #should be start date for GLAD (time2)
          units = c("weeks")  #can also be "secs", "mins", "hours", "weeks"
          )
        )

dat %>%
  descr(
    var = time_diff_sign_up_coping,
    stats = "common"
    )
}
```

Proportion of people signed up over one year ago
```{r glad/edgi ppts signed up over one year ago, eval=FALSE, include=FALSE}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    over_one_year_time_diff_sign_up_coping_numeric =
      as.numeric(
        if_else(time_diff_sign_up_coping > 365, 1, 0
                )
      )
  )

dat <- dat %>%
  mutate(
    over_one_year_time_diff_sign_up_coping =
      recode_factor(
        over_one_year_time_diff_sign_up_coping_numeric,
        "0" = "Sign up under one year before COPING",
        "1" = "Sign up over one year before COPING"
      )
  )

dat %>%
  freq(over_one_year_time_diff_sign_up_coping, cumul = F)
}
```

Proportion of people signed up over half a year ago
```{r glad/edgi ppts signed up over half a year ago, r eval=FALSE, include=FALSE}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    over_half_a_year_time_diff_sign_up_coping_numeric =
      as.numeric(
        if_else(time_diff_sign_up_coping > 182.5, 1, 0
                )
      )
  )

dat <- dat %>%
  mutate(
    over_half_a_year_time_diff_sign_up_coping =
      recode_factor(
        over_half_a_year_time_diff_sign_up_coping_numeric,
        "0" = "Sign up under half a year before COPING",
        "1" = "Sign up over half a year before COPING"
      )
  )

dat %>%
  freq(over_half_a_year_time_diff_sign_up_coping, cumul = F)
}
```



#Total score comparison between PHQ, PCL and GAD, prepandemic, retrospecive and baseline
PHQ difference scores
```{r phq difference scores}
if(GLAD == TRUE | EDGI == TRUE){
# Difference score for prepandemic and retrospective phq sum scores
dat <- dat %>%
  mutate(
    phq.diff_score_retro_prepan =
      as.numeric(
        phq.sum_score_retro - phq.sum_score_prepan  # retrospective sum score MINUS prepandemic sum score 
      )
  )

summary(dat$phq.diff_score_prepan_retro)

# Difference score for prepandemic and baseline phq sum scores
dat <- dat %>%
  mutate(
    phq.diff_score_base_prepan =
      as.numeric(
        phq.sum_score_base - phq.sum_score_prepan  # baseline sum score MINUS prepandemic sum score 
      )
  )

summary(dat$phq.diff_score_prepan_base)
} 

# Difference score for retrospective and baseline phq sum scores
dat <- dat %>%
  mutate(
    phq.diff_score_base_retro =
      as.numeric(
        phq.sum_score_base - phq.sum_score_retro  # baseline sum score MINUS retrospective sum score 
      )
  )

summary(dat$phq.diff_score_base_retro)

```

GAD difference scores
```{r gad difference scores}
if(GLAD == TRUE | EDGI == TRUE){
# Difference score for prepandemic and retrospective gad sum scores
dat <- dat %>%
  mutate(
    gad.diff_score_retro_prepan =
      as.numeric(
        gad.sum_score_retro - gad.sum_score_prepan  # retrospective sum score MINUS prepandemic sum score 
      )
  )

summary(dat$gad.diff_score_prepan_retro)

# Difference score for prepandemic and baseline gad sum scores
dat <- dat %>%
  mutate(
    gad.diff_score_base_prepan =
      as.numeric(
        gad.sum_score_base - gad.sum_score_prepan  # baseline sum score MINUS prepandemic sum score 
      )
  )

summary(dat$gad.diff_score_prepan_base)
}

# Difference score for retrospective and baseline gad sum scores
dat <- dat %>%
  mutate(
    gad.diff_score_base_retro =
      as.numeric(
        gad.sum_score_base - gad.sum_score_retro  # baseline sum score MINUS retrospective sum score 
      )
  )

summary(dat$gad.diff_score_base_retro)

```

PCL difference scores
NOTE: Only computed baseline and prepandemic differences as the retro account here isn't actually retrospective, but whether the reported baseline scores are due to the pandemic. 
```{r pcl difference scores}
if(GLAD == TRUE | EDGI == TRUE){
# Difference score for prepandemic and baseline pcl sum scores
dat <- dat %>%
  mutate(
    pcl.diff_score_base_prepan =
      as.numeric(
        pcl.sum_score_base - pcl.sum_score_prepan  # baseline sum score MINUS prepandemic sum score 
      )
  )

summary(dat$pcl.diff_score_prepan_base)
}
```

```{r frequency of those who reported "due to pandemic" in retro PCL}
summary(dat$pcl.sum_score_retro)

freq(dat$pcl.stressful_experience_repeated_images_retro)
freq(dat$pcl.stressful_situation_avoiding_activities_retro)
freq(dat$pcl.feeling_irritable_or_having_angry_outbursts_retro)
freq(dat$pcl.stressful_experience_upset_reminded_retro)
freq(dat$pcl.cut_people_feeling_distant_retro)
freq(dat$pcl.difficulty_concentrating_retro)
```

OCI-R difference scores
```{r ocir difference scores}
if(GLAD == TRUE | EDGI == TRUE){
# Difference score for prepandemic and retrospective oci-r sum scores
dat <- dat %>%
  mutate(
    ocir.diff_score_retro_prepan =
      as.numeric(
        ocir.sum_score_retro - ocir.sum_score_prepan  # retrospective sum score MINUS prepandemic sum score 
      )
  )

summary(dat$ocir.diff_score_prepan_retro)

# Difference score for prepandemic and baseline ocir sum scores
dat <- dat %>%
  mutate(
    ocir.diff_score_base_prepan =
      as.numeric(
        ocir.sum_score_base - ocir.sum_score_prepan   # prepandemic sum score MINUS baseline sum score 
      )
  )

summary(dat$ocir.diff_score_prepan_base)
}
# Difference score for retrospective and baseline ocir sum scores
dat <- dat %>%
  mutate(
    ocir.diff_score_base_retro =
      as.numeric(
        ocir.sum_score_base - ocir.sum_score_retro  # baseline sum score MINUS retrospective sum score 
      )
  )

summary(dat$ocir.diff_score_base_retro)

```

#Data level groups
Identify which data (prepan, retro and baseline) each participant has.
```{r glad/edgi data level groups PHQ}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    data_group_phq_numeric =
      case_when(
        na_per_person_phq_base == 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_phq_base != 0 & na_per_person_phq_prepan != 0 & na_per_person_phq_retro == 0  ~ 4, #retro data only
        na_per_person_phq_base == 0 & na_per_person_phq_prepan != 0 & na_per_person_phq_retro != 0  ~ 3, #baseline data only
        na_per_person_phq_base == 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_phq_base == 0 & na_per_person_phq_prepan != 0 & na_per_person_phq_retro == 0 ~ 1,  #baseline and retro data only
        na_per_person_phq_base != 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_phq = 
      recode_factor(
        data_group_phq_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )


table(dat$data_group_phq)
}
```

```{r nbr/ramp data level groups PHQ}
if(NBR == TRUE | RAMP == TRUE){
dat <- dat %>%
  mutate(
    data_group_phq_numeric =
      case_when(
#        na_per_person_phq_base == 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_phq_base != 0 & na_per_person_phq_retro == 0  ~ 4, #retro data only
        na_per_person_phq_base == 0 & na_per_person_phq_retro != 0  ~ 3, #baseline data only
#        na_per_person_phq_base == 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_phq_base == 0 & na_per_person_phq_retro == 0 ~ 1  #baseline and retro data only
#        na_per_person_phq_base != 0 & na_per_person_phq_prepan == 0 & na_per_person_phq_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_phq = 
      recode_factor(
        data_group_phq_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )


table(dat$data_group_phq)
}
```

GAD
```{r glad/edgi data level groups GAD}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    data_group_gad_numeric =
      case_when(
        na_per_person_gad_base == 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_gad_base != 0 & na_per_person_gad_prepan != 0 & na_per_person_gad_retro == 0  ~ 4, #retro data only
        na_per_person_gad_base == 0 & na_per_person_gad_prepan != 0 & na_per_person_gad_retro != 0  ~ 3, #baseline data only
        na_per_person_gad_base == 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_gad_base == 0 & na_per_person_gad_prepan != 0 & na_per_person_gad_retro == 0 ~ 1,  #baseline and retro data only
        na_per_person_gad_base != 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_gad = 
      recode_factor(
        data_group_gad_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )

table(dat$data_group_gad)
}
```

```{r nbr/ramp data level groups GAD}
if(NBR == TRUE | RAMP == TRUE){
dat <- dat %>%
  mutate(
    data_group_gad_numeric =
      case_when(
#        na_per_person_gad_base == 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_gad_base != 0 & na_per_person_gad_retro == 0  ~ 4, #retro data only
        na_per_person_gad_base == 0 & na_per_person_gad_retro != 0  ~ 3, #baseline data only
#        na_per_person_gad_base == 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_gad_base == 0 & na_per_person_gad_retro == 0 ~ 1  #baseline and retro data only
#        na_per_person_gad_base != 0 & na_per_person_gad_prepan == 0 & na_per_person_gad_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_gad = 
      recode_factor(
        data_group_gad_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )


table(dat$data_group_gad)
}
```

PCL
```{r glad/edgi data level groups PCL}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    data_group_pcl_numeric =
      case_when(
        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_pcl_base != 0 & na_per_person_pcl_prepan != 0 & na_per_person_pcl_retro == 0  ~ 4, #retro data only
        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan != 0 & na_per_person_pcl_retro != 0  ~ 3, #baseline data only
        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan != 0 & na_per_person_pcl_retro == 0 ~ 1,  #baseline and retro data only
        na_per_person_pcl_base != 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_pcl = 
      recode_factor(
        data_group_pcl_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )

table(dat$data_group_pcl)
}
```

```{r nbr/ramp data level groups PCL}
if(NBR == TRUE | RAMP == TRUE){
dat <- dat %>%
  mutate(
    data_group_pcl_numeric =
      case_when(
#        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_pcl_base != 0 & na_per_person_pcl_retro == 0  ~ 4, #retro data only
        na_per_person_pcl_base == 0 & na_per_person_pcl_retro != 0  ~ 3, #baseline data only
#        na_per_person_pcl_base == 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_pcl_base == 0 & na_per_person_pcl_retro == 0 ~ 1  #baseline and retro data only
#        na_per_person_pcl_base != 0 & na_per_person_pcl_prepan == 0 & na_per_person_pcl_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_pcl = 
      recode_factor(
        data_group_pcl_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )


table(dat$data_group_pcl)
}
```



OCI-R
```{r glad/edgi data level groups ocir}
if(GLAD == TRUE | EDGI == TRUE){
dat <- dat %>%
  mutate(
    data_group_ocir_numeric =
      case_when(
        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_ocir_base != 0 & na_per_person_ocir_prepan != 0 & na_per_person_ocir_retro == 0  ~ 4, #retro data only
        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan != 0 & na_per_person_ocir_retro != 0  ~ 3, #baseline data only
        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan != 0 & na_per_person_ocir_retro == 0 ~ 1,  #baseline and retro data only
        na_per_person_ocir_base != 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_ocir = 
      recode_factor(
        data_group_ocir_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )

table(dat$data_group_ocir)
}
```

```{r nbr/ramp data level groups ocir}
if(NBR == TRUE | RAMP == TRUE){
dat <- dat %>%
  mutate(
    data_group_ocir_numeric =
      case_when(
#        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro == 0 ~ 5, #all complete baseline, prepan and retro
        na_per_person_ocir_base != 0 & na_per_person_ocir_retro == 0  ~ 4, #retro data only
        na_per_person_ocir_base == 0 & na_per_person_ocir_retro != 0  ~ 3, #baseline data only
#        na_per_person_ocir_base == 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro != 0  ~ 2, #prepan and baseline data only
        na_per_person_ocir_base == 0 & na_per_person_ocir_retro == 0 ~ 1  #baseline and retro data only
#        na_per_person_ocir_base != 0 & na_per_person_ocir_prepan == 0 & na_per_person_ocir_retro != 0  ~ 0  #prepan data only
      )
  )

dat <- dat %>%
  mutate(
    data_group_ocir = 
      recode_factor(
        data_group_ocir_numeric,
        "0" = "Only prepandemic data",
        "1" = "Baseline and retrospective data",
        "2" = "Prepandemic and baseline data",
        "3" = "Baseline data only",
        "4" = "Retrospective data only",
        "5" = "All prepandemic, baseline and retrospective data"
      )
  )


table(dat$data_group_ocir)
}
```

#Read in respiratory data

## GLAD respiratory
```{r glad coping respiratory cols}
if(GLAD == TRUE){
coping.glad.respiratory.raw <- readRDS(file = paste0(data.raw_path, "/glad/respiratory_coping_glad.rds"))
dim(coping.glad.respiratory.raw)
colnames(coping.glad.respiratory.raw)
}
```

Select respiratory variables
```{r coping glad respiratory cleaning}
if(GLAD == TRUE){
coping.glad.respiratory.raw.id <- coping.glad.respiratory.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    respiratory.breath_diarrhoea_fatigue_fever,
    respiratory.worst_ill_feel,
    respiratory.persistent_cough,
    respiratory.skipping_meals_because_you_felt_unwell,
    respiratory.was_your_sense_of_smell_impaired,
    respiratory.was_your_sense_of_taste_impaired,
    respiratory.feeling_tiredfatigued,
    respiratory.throat_swab_coronavirus_nose,
    respiratory.throat_swab_test_nose,
    respiratory.coronavirus_antibody_test,
    respiratory.results_antibody_test
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.glad.respiratory.raw.id)
# Inspect colnames
colnames(coping.glad.respiratory.raw.id)
#Differences
dim(coping.glad.respiratory.raw)[1]-dim(coping.glad.respiratory.raw.id)[1]
}
```

```{r coping glad respiratory copy}
if(GLAD == TRUE){
respiratory.raw.id <- coping.glad.respiratory.raw.id
}
```

## EDGI respiratory
```{r edgi coping respiratory cols}
if(EDGI == TRUE){
coping.edgi.respiratory.raw <- readRDS(file = paste0(data.raw_path, "/edgi/respiratory_coping_edgi.rds"))
dim(coping.edgi.respiratory.raw)
colnames(coping.edgi.respiratory.raw)
}
```

Select respiratory variables
```{r coping edgi respiratory cleaning}
if(EDGI == TRUE){
coping.edgi.respiratory.raw.id <- coping.edgi.respiratory.raw %>%
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    respiratory.breath_diarrhoea_fatigue_fever = respiratory.unusual_shortness_breath_diarrhoea,
    respiratory.worst_ill_feel,
    respiratory.persistent_cough,
    respiratory.skipping_meals_because_you_felt_unwell,
    respiratory.was_your_sense_of_smell_impaired,
    respiratory.was_your_sense_of_taste_impaired,
    respiratory.feeling_tiredfatigued,
    respiratory.throat_swab_coronavirus_nose,
    respiratory.throat_swab_test_nose,
    respiratory.coronavirus_antibody_test,
    respiratory.results_antibody_test
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.edgi.respiratory.raw.id)
# Inspect colnames
colnames(coping.edgi.respiratory.raw.id)
#Differences
dim(coping.edgi.respiratory.raw)[1]-dim(coping.edgi.respiratory.raw.id)[1]
}
```

```{r coping edgi respiratory copy}
if(EDGI == TRUE){
respiratory.raw.id <- coping.edgi.respiratory.raw.id
}
```

## NBR respiratory
```{r nbr coping respiratory cols}
if(NBR == TRUE){
coping.nbr.respiratory.raw <- readRDS(file = paste0(data.raw_path, "/nbr/respiratory_coping_nbr.rds"))
dim(coping.nbr.respiratory.raw)
colnames(coping.nbr.respiratory.raw)
}
```

Select respiratory variables
```{r coping nbr respiratory cleaning}
if(NBR == TRUE){
coping.nbr.respiratory.raw.id <- coping.nbr.respiratory.raw %>%
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
  separate(ID.intm, into = "ID", sep = 7) %>%
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    respiratory.breath_diarrhoea_fatigue_fever = respiratory.unusual_shortness_breath_diarrhoea,
    respiratory.worst_ill_feel,
    respiratory.persistent_cough,
    respiratory.skipping_meals_because_you_felt_unwell,
    respiratory.was_your_sense_of_smell_impaired,
    respiratory.was_your_sense_of_taste_impaired,
    respiratory.feeling_tiredfatigued,
    respiratory.throat_swab_coronavirus_nose,
    respiratory.throat_swab_test_nose,
    respiratory.coronavirus_antibody_test,
    respiratory.results_antibody_test
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(coping.nbr.respiratory.raw.id)
# Inspect colnames
colnames(coping.nbr.respiratory.raw.id)
#Differences
dim(coping.nbr.respiratory.raw)[1]-dim(coping.nbr.respiratory.raw.id)[1]
}
```

```{r coping nbr respiratory copy}
if(NBR == TRUE){
respiratory.raw.id <- coping.nbr.respiratory.raw.id
}
```

## RAMP respiratory
```{r ramp coping respiratory cols}
if(RAMP == TRUE){
ramp.respiratory.raw <- readRDS(file = paste0(data.raw_path, "/ramp/respiratory_ramp.rds"))
dim(ramp.respiratory.raw)
colnames(ramp.respiratory.raw)
}
```

Select respiratory variables
```{r coping ramp respiratory cleaning}
if(RAMP == TRUE){
ramp.respiratory.raw.id <- ramp.respiratory.raw %>%
  drop_na(`Login ID`) %>% # Drop NAs
  distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
  separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
  mutate(ID = as.numeric(ID)) %>%
  select(
    Sample, # Sample
    ID, # ID
    respiratory.breath_diarrhoea_fatigue_fever = respiratory.experienced_symptoms_unusual_shortness,
    respiratory.worst_ill_feel,
    respiratory.persistent_cough,
    respiratory.skipping_meals_because_you_felt_unwell,
    respiratory.was_your_sense_of_smell_impaired = respiratory.smell_impaired_sense_weeks,
    respiratory.was_your_sense_of_taste_impaired = respiratory.taste_impaired_sense_weeks,
    respiratory.feeling_tiredfatigued,
    respiratory.throat_swab_coronavirus_nose,
    respiratory.throat_swab_test_nose,
    respiratory.coronavirus_week_antibody_test,
    respiratory.results_antibody_test
  ) %>%
  add_numeric(., exclude = exclude_cols) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ramp.respiratory.raw.id)
# Inspect colnames
colnames(ramp.respiratory.raw.id)
#Differences
dim(ramp.respiratory.raw)[1]-dim(ramp.respiratory.raw.id)[1]
}
```

```{r ramp respiratory copy}
if(RAMP == TRUE){
respiratory.raw.id <- ramp.respiratory.raw.id
}
```

#Distribution of likert scale COVID-19 symptoms in COPING
```{r distribution of COVID symptoms}
#persistent cough
respiratory.raw.id %>%
  ggplot(
    mapping = aes(
      y = respiratory.persistent_cough_numeric 
    )
  ) +
  geom_bar() +
  labs(
    title = "Persistant cough"
  )

#severe fatigue
respiratory.raw.id %>%
  ggplot(
    mapping = aes(
        y = respiratory.feeling_tiredfatigued_numeric 
    )
  ) +
  geom_bar() +
  labs(
    title = "Severe fatigue"
  )

#skipped meals
respiratory.raw.id %>%
  ggplot(
    mapping = aes(
        y = respiratory.skipping_meals_because_you_felt_unwell_numeric
    )
  ) +
  geom_bar() +
  labs(
    title = "Skipped meals"
  )

```

#Choosing cut-offs for the likert scale symptoms of "no symptoms", "mild symptoms", "moderate symptoms" and "severe symptoms" for the fatigue, persistent cough and skipped meals variables. 
Coding:
0 = No symptoms
1 = Mild symptoms
2 = Moderate symptoms
3 = Severe symptoms

Results:
Persistent cough: "Mild symptoms" as cut off
Fatigue: "Severe symptoms" as cut off
Skipped meals: "Moderate symptoms" as cut off
```{r proportion of people who report COVID symptoms in Menni et al}
#persistent cough
percentage_pcough <- ((0.5673*6452) + (0.4556*9186) + (0.3017*2434931))/(6452+9186+2434931)
percentage_pcough    # 0.3029762% of Menni et al(2020) have fatigue
pcough_cutoff <- quantile(x = respiratory.raw.id$respiratory.persistent_cough_numeric, 
         na.rm = TRUE, 
         probs = 1-percentage_pcough) # this gives 0.3029762% of the sample reporting fatigue when using the "mild symptoms" persistent cough response
pcough_cutoff

#fatigue
percentage_fatigue <- ((0.298*6452) + (0.1556*9186) + (0.0871*2434931))/(6452+9186+2434931) 
percentage_fatigue   # 0.08791204% of Menni et al(2020) have fatigue
fatigue_cutoff <- quantile(x = respiratory.raw.id$respiratory.feeling_tiredfatigued_numeric, 
         na.rm = TRUE, 
         probs = 1-percentage_fatigue) #this gives 8% of the sample reporting fatigue when using the "severe symptoms" fatigue response
fatigue_cutoff

#skipped meals 
percentage_skipped_meals <- ((0.4203*6452) + (0.2493*9186) + (0.1912*2434931))/(6452+9186+2434931) 
percentage_skipped_meals    # 0.192021% of Menni et al(2020) have fatigue
skipped_meals_cutoff <- quantile(x = respiratory.raw.id$respiratory.skipping_meals_because_you_felt_unwell_numeric, 
         na.rm = TRUE, 
         probs = 1-percentage_skipped_meals) # this gives 0.192021% of the sample reporting fatigue when using the "moderate symptoms" persistent cough response
skipped_meals_cutoff
```

Creating binary groups for COVID symptoms
```{r creating binary groups for COVID symptoms}
#loss or smell or taste
respiratory.raw.id <- respiratory.raw.id %>%
  mutate(
    respiratory.anosmia_binary =
      if_else(
        respiratory.was_your_sense_of_smell_impaired_numeric == 1 | respiratory.was_your_sense_of_taste_impaired_numeric == 1, 
        1,
        0
      )
  )

#persistent cough
respiratory.raw.id <- respiratory.raw.id %>%
  mutate(
    respiratory.pcough_binary =
      if_else(
        respiratory.persistent_cough_numeric >= pcough_cutoff, #those who score 1 or above (mild or above)
        1,
        0
      )
  )

#fatigue
respiratory.raw.id <- respiratory.raw.id %>%
  mutate(
    respiratory.fatigue_binary =
      if_else(
        respiratory.feeling_tiredfatigued_numeric >= fatigue_cutoff, #those who score 3 (severe symptoms)
        1,
        0
      )
  )

#skipped meals
respiratory.raw.id <- respiratory.raw.id %>%
  mutate(
    respiratory.skipped_meals_binary =
      if_else(
        respiratory.skipping_meals_because_you_felt_unwell_numeric >= skipped_meals_cutoff,
        1,
        0
      )
  )
```

Frequencies of binary COVID symptoms
```{r frequencies of COVID binary symptoms}
freq(respiratory.raw.id$respiratory.anosmia_binary)
freq(respiratory.raw.id$respiratory.pcough_binary)
freq(respiratory.raw.id$respiratory.fatigue_binary)
freq(respiratory.raw.id$respiratory.skipped_meals_binary)
```

Rename respiratory dataset joined to main dataset

```{r clean respiratory dataset}
respiratory <- respiratory.raw.id

dat.coping <- left_join(
  x = dat,
  y = respiratory,
  by = c("Sample", "ID")
)
```

# Probable COVID-19 case identification

Algorithm from Menni et al. to identify probable COVID-19
Variables required:
- Sex: 	0 Female, 1 Male
- Other binary variables: 0 No, 1 Yes       
- "respiratory.anosmia_binary": loss of smell or taste  
- "respiratory.pcough_binary":	Persistent cough
- "respiratory.fatigue_binary": Severe fatigue
- "respiratory.skipped_meals_binary": Skipped meals

The COVID prediction model has coded the sexes opposite to our data set
```{r create numeric sex variable with male=1}
if(GLAD == TRUE | NBR == TRUE | EDGI == TRUE){
dat.coping <- dat.coping %>%
  mutate(
    Sex_respiratory =
      if_else(
        Sex == "Male",
        true = 1,
        false = 0,
        missing = NA_real_
      )
  )
}
```

Sex is no available in the RAMP dataset, therefore a proxy sex variable is created whereby Gender = Male and Transgender = No. 
```{r create numeric sex variable with male=1 for ramp}
if(RAMP == TRUE){
dat.coping <- dat.coping %>%
  mutate(
    Sex_respiratory =
      if_else(
        Gender == "Male" &
        Transgender_uncleaned == "No",
        true = 1,
        false = 0,
        missing = NA_real_
      )
  )
}
```

Age is not available in RAMP, only categorical age. We will assign each individual the middle value of each age category. 
```{r create age - proxy variable for ramp}
if(RAMP == TRUE){
dat.coping <- dat.coping %>%
  mutate(
    Age_respiratory =
      case_when(
        age_category == "16-18" ~ 17,
        age_category == "19-25" ~ 22,
        age_category == "26-35" ~ 30.5,
        age_category == "36-45" ~ 40.5,
        age_category == "46-55" ~ 50.5,
        age_category == "56-65" ~ 60.5,
        age_category == "66-70" ~ 68,
        age_category == "71-75" ~ 73,
        age_category == "76-80" ~ 78,
        age_category == "81-85" ~ 83,
        age_category == "86-90" ~ 88,
        age_category == "91-100" ~ 93,
      age_category == "100+" ~ 100
      )
  )
}

if(GLAD == TRUE | EDGI == TRUE | NBR == TRUE){
dat.coping <- dat.coping %>%
  mutate(
    Age_respiratory = Age
  )
}
```

```{r how many people experinced all symptoms}
dat.coping <- dat.coping %>%
  mutate(
    covid_symptoms =
      if_else(
          !is.na(respiratory.anosmia_binary) &
          !is.na(respiratory.pcough_binary) &
          !is.na(respiratory.fatigue_binary) &
          !is.na(respiratory.skipped_meals_binary),
        1,
        0
       )
  )

dat.coping %>%
  freq(covid_symptoms, cumul = F)
```

#COVID prediction model
```{r COVID prediction model}
# linear model of COVID symptoms
dat.coping <- dat.coping %>%
		  mutate(
		    covid_probability = 
		      (-1.32) - 
		      (0.01*Age_respiratory) + 
		      (0.44*Sex_respiratory) + 
		      (1.75*respiratory.anosmia_binary) + 
		      (0.31*respiratory.pcough_binary) +  
		      (0.49*respiratory.fatigue_binary) +  
		      (0.39*respiratory.skipped_meals_binary) 
		         )

# Calculate the odds ratios 
dat.coping <- dat.coping %>%
  mutate(
    covid_odds_ratio = 
      (exp(covid_probability) / (1 + exp(covid_probability)))
  )

# generate binary cut off variable for risk of COVID 
dat.coping <- dat.coping %>%
		  mutate(
		    covid_odds_ratio_50_numeric = 
		      case_when(
		        covid_odds_ratio >= 0 & covid_odds_ratio < 0.5 ~ "0", #cut off at 0.5 
		        covid_odds_ratio >= 0.5 & covid_odds_ratio <= 1 ~ "1"
		      )
		  )
		      
#create factor with labels
dat.coping <- dat.coping %>%
  mutate(
    covid_odds_ratio_50 =
      recode_factor(
        covid_odds_ratio_50_numeric,
        "0" = "No COVID",
        "1" = "Probable COVID"
      )
  )

#frequency table for covid variables 
covid_variables <- c("covid_odds_ratio",
                      "covid_probability"
                    )

descr(x = dat.coping[,covid_variables],
      round.digits = 2,
      transpose = TRUE)

## looking at cases over 0.5
freq(dat.coping$covid_odds_ratio_50, 
     cumul = FALSE) 

```

Probable COVID case including the routing question
```{r recoding probable covid to account for screening question}
dat.coping <- dat.coping %>%
  mutate(
    covid_probable_case_incl_screening_numeric =
      case_when(
        respiratory.breath_diarrhoea_fatigue_fever_numeric == 0 ~ 0,
        covid_odds_ratio_50_numeric == 0 ~ 0,
        covid_odds_ratio_50_numeric == 1 ~ 1
      )
  )

#create factor with labels
dat.coping <- dat.coping %>%
  mutate(
    covid_probable_case_incl_screening =
      recode_factor(
        covid_probable_case_incl_screening_numeric,
        "0" = "No COVID",
        "1" = "Probable COVID"
      )
  )

dat.coping %>%
  freq(covid_probable_case_incl_screening, 
     cumul = FALSE) 
```

```{r dat.coping summary}
summarytools::dfSummary(
  dat.coping,
  graph.col = F,
  valid.col = F,
  labels.col = F)
```

# Rename NBR Sample ID 
```{r rename NBR sample ID}
if(NBR == TRUE){
dat.coping <- dat.coping %>%
  mutate(
    Sample = 
    recode(
      Sample, 
      "SP0068" = "NBR"
    )
  )
}
```


# Export data
```{r export data}
if(GLAD == TRUE){
saveRDS(object = dat.coping, file = paste0(data_path, "/glad.rds"))
}

if(EDGI == TRUE){
saveRDS(object = dat.coping, file = paste0(data_path, "/edgi.rds"))
}

if(NBR == TRUE){
saveRDS(object = dat.coping, file = paste0(data_path, "/nbr.rds"))
}

if(RAMP == TRUE){
saveRDS(object = dat.coping, file = paste0(data_path, "/ramp.rds"))
}

```






