---
title: "Placeholder"
author: "Steven Bright"
date: "05/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean environment}

remove(list = ls())

```


# Set up 
 
```{r read in data } 

# Read in data
library(knitr)
library(summarytools)
library(psych)
library(polycor)
library(corrplot)
library(patchwork)
library(broom)
library(tidyverse)
library(ggpubr)


# get file info
source("../PANCHANGE_raw_path.R")


alldat <-  readRDS(file = paste0(data_path, "/four_cohorts_variables_exclusion.rds"))

```


```{r Colour palettes: COPING}

COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpalette9 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080",
                    "#cccccc",
                    "3B47DA")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  
```


# Impute and subset data

Impute retrospective scores if no change reported

```{r impute retro}

# impute retro for those who did not change

alldat$gad.sum_score_retro <- ifelse(alldat$gad.pandemic_felt_feelings == "No different", alldat$gad.sum_score_base,alldat$gad.sum_score_retro)

alldat$phq.sum_score_retro <- ifelse(alldat$phq.pandemic_felt_feelings == "No different", alldat$phq.sum_score_base,alldat$phq.sum_score_retro)

```


subsample for retro-baseline analysis
exclude those who do not have complete responses for both baseline and retrospective
in addition to those already excluded for NA in age, gender and MH diagnosis.

RETROSPECTIVE
```{r subset retrospective data }

dat.retro <- alldat %>%
  filter(
    ((data_group_gad == "Baseline and retrospective data" |
        data_group_gad == "All prepandemic, baseline and retrospective data") |
       (data_group_phq == "Baseline and retrospective data" |
          data_group_phq == "All prepandemic, baseline and retrospective data") |
        (data_group_pcl == "Baseline data only" |
           data_group_pcl == "Baseline and retrospective data" |
            data_group_pcl == "Prepandemic and baseline data" |
      data_group_pcl == "All prepandemic, baseline and retrospective data"))
  )

dim(dat.retro)

```


subsample for prepan-baseline analysis
exclude those who do not have complete responses for both baseline and prepandemic
in addition to those already excluded for NA in age, gender and MH diagnosis.

PREPANDEMIC
```{r subset prepandemic}

dat.prepan <- alldat %>%
  filter(
    ((data_group_gad == "Prepandemic and baseline data" |
        data_group_gad == "All prepandemic, baseline and retrospective data") |
       (data_group_phq == "Prepandemic and baseline data" |
          data_group_phq == "All prepandemic, baseline and retrospective data") |
       (data_group_pcl == "Prepandemic and baseline data" |
          data_group_pcl == "All prepandemic, baseline and retrospective data") ) &
      prepandemic_march_1_numeric == 1 # Exclude participants that signed up after the 1. March
  )

dim(dat.prepan)

```


Subset by study

```{r subset by study}

## Subset samples by study

GLAD.prepan <- dat.prepan %>%
  filter(Sample == "GLAD" | 
           Sample == "EDGI")

NBR.prepan <- dat.prepan %>%
  filter(Sample == "NBR")

RAMP.prepan <- dat.prepan %>%
  filter(Sample == "RAMP")

### retro
GLAD.retro <- dat.retro %>%
  filter(Sample == "GLAD" | 
           Sample == "EDGI")

NBR.retro <- dat.retro %>%
  filter(Sample == "NBR")

RAMP.retro <- dat.retro %>%
  filter(Sample == "RAMP")

```

#Histograms

```{r Merge GLAD/EDGI samples together for plot}

#Merge GLAD and EDGI Samples into one sample

dat.retro <- dat.retro %>% 
  mutate(Sample_plot = 
           case_when(
             dat.retro$Sample == "GLAD" ~ "GLAD/EDGI",
             dat.retro$Sample == "EDGI" ~ "GLAD/EDGI",
             dat.retro$Sample == "NBR" ~ "NBR",
             dat.retro$Sample == "RAMP" ~ "RAMP"
           ))

#Check that it worked

dat.retro %>% 
  group_by(Sample_plot) %>% 
  summarise(N = n())

```

##Gender
###Prepan

```{r GLAD/EDGI gender prepan}

GLAD.prepan %>%
  ggplot(aes(x = Gender)) +
  geom_bar(fill = COPINGpalette4) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Gender distribution of the GLAD/EDGI prepan cohort",
       subtitle = paste("N =", dim(GLAD.prepan)[1]),
       x = "",
       y = "N participants")
  
```

###Retrospective

```{r GLAD/EDGI gender retro}

GLAD.retro %>%
  ggplot(aes(x = Gender)) +
  geom_bar(fill = COPINGpalette4) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Gender distribution of the GLAD/EDGI retro cohort",
       subtitle = paste("N =", dim(GLAD.retro)[1]),
       x = "",
       y = "N participants")

```

```{r NBR gender retro}

NBR.retro %>%
  ggplot(aes(x = Gender)) +
  geom_bar(fill = COPINGpalette4) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Gender distribution of the NBR retro cohort",
       subtitle = paste("N =", dim(NBR.retro)[1]),
       x = "",
       y = "N participants")

```

```{r RAMP gender retro}

RAMP.retro %>%
  ggplot(aes(x = Gender)) +
  geom_bar(fill = COPINGpalette4) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Gender distribution of the RAMP retro cohort",
       subtitle = paste("N =", dim(RAMP.retro)[1]),
       x = "",
       y = "N participants")

```


```{r Retro gender together}

dat.retro %>% 
  ggplot(aes(x = Gender, fill = Sample_plot)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = COPINGpalette4) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Gender distribution of the retro cohorts",
       subtitle = paste("N =", dim(dat.retro)[1]),
       x = "",
       y = "") +
  theme(legend.position = "bottom") + 
  theme(legend.title = element_blank())

```


##Age
###Prepan

```{r GLAD/EDGI age prepan}

GLAD.prepan %>% 
  ggplot(aes(x = age_category_collapsed)) +
  geom_bar(fill = COPINGpalette9) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Age distribution of the GLAD/EDGI prepan cohort",
       subtitle = paste("N =", dim(GLAD.prepan)[1]),
       x = "",
       y = "")

```

###Retro

```{r GLAD/EDGI NBR and RAMP age}

dat.retro %>% 
  ggplot(aes(x = age_category_collapsed, fill = Sample_plot)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = COPINGpalette3) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Age distribution of the retro cohorts",
       subtitle = paste("N =", dim(dat.retro)[1]),
       x = "Age (years)",
       y = "") +
  theme(legend.position = "bottom") + 
  theme(legend.title = element_blank())

```

##Ethinicity
###Prepan

```{r GLAD/EDGI ethnicity prepan}

GLAD.prepan %>% 
  ggplot(aes(x = Ethnicity_collapsed)) +
  geom_bar(fill = COPINGpalette6) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Ethnic distribution of the GLAD/EDGI prepan cohort",
       subtitle = paste("N =", dim(GLAD.prepan)[1]),
       x = "",
       y = "N participants") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))

```

###Retro

```{r GLAD/EDGI NBR and RAMP ethnicity}

dat.retro %>% 
  ggplot(aes(x = Ethnicity_collapsed, fill = Sample_plot)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = COPINGpalette3) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Ethnic distribution of the retro cohorts",
       subtitle = paste("N =", dim(dat.retro)[1]),
       x = "",
       y = "N participants") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(legend.position = "bottom") + 
  theme(legend.title = element_blank())

```

##Employment
###Prepan

```{r GLAD/EDGI employment prepan}

GLAD.prepan %>% 
  ggplot(aes(x = employment_prior_covid)) +
  geom_bar(fill = COPINGpalette6) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Employment of the GLAD/EDGI prepan cohort",
       subtitle = paste("N =", dim(GLAD.prepan)[1]),
       x = "",
       y = "") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))

```

###Retro

```{r GLAD/EDGI NBR and RAMP retro employment}

dat.retro %>% 
  ggplot(aes(x = employment_prior_covid, fill = Sample_plot)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = COPINGpalette6) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Employment distribution of the retro cohorts",
       subtitle = paste("N =", dim(dat.retro)[1]),
       x = "",
       y = "") +
  theme(legend.position = "bottom") + 
  theme(legend.title = element_blank())

```

##Diagnoses

```{r Get data frame of positive diagnoses}

dat.retro_diagnosis_sums <- data.frame(apply(dat.retro[c("depressive_disorders_numeric", "anxiety_disorders_numeric", "eating_disorders_numeric", "obsessive_compulsive_disorders_numeric", "psychotic_disorders_numeric", "autism_spectrum_disorder_numeric", "mhd.attention_deficit_hyperactivity_disorder_numeric", "personality_cluster_a_numeric", "personality_cluster_b_numeric", "personality_cluster_c_numeric", "mhd.mania_hypomania_bipolar_or_manicdepression_numeric", "mhd.posttraumatic_stress_disorder_ptsd_numeric", "control_numeric")],2,table))

dat.retro_diagnosis_variables <- data.frame(c("depressive disorders", "anxiety disorders", "eating disorders", "obsessive compulsive disorders", "psychotic disorders", "autism spectrum disorder", "attention deficit hyperactivity disorder", "personality cluster a", "personality cluster b", "personality cluster c", "mania hypomania bipolar or manicdepression", "posttraumatic stress disorder ptsd", "control"))

dat.retro_positive_diagnosis <- data.frame(t(dat.retro_diagnosis_sums[2,]))

dat.retro_diagnosis_type <- cbind(dat.retro_diagnosis_variables, dat.retro_positive_diagnosis)

names(dat.retro_diagnosis_type) <- c("diagnosis", "count")

```

